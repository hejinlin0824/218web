{% extends 'base.html' %}
{% load static %}

{% block title %}Innovation Workspace - {{ project.title }}{% endblock %}

{# éšè—å…¨å±€ä¾§è¾¹æ ï¼Œå…¨å±æ²‰æµ¸ #}
{% block sidebar %}{% endblock %}

{% block content_container %}
<link rel="stylesheet" href="https://unpkg.com/vditor/dist/index.css" />
<script src="https://unpkg.com/vditor/dist/index.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
    /* === 1. å…¨å±€è®¾å®š === */
    body {
        overflow: hidden; /* ç¦æ­¢ä¸»é¡µé¢æ»šåŠ¨ */
        background-color: #f3f4f6; /* ææµ…ç°èƒŒæ™¯ */
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    /* ä¸»å®¹å™¨ */
    .workspace-wrapper {
        height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
        background-color: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        overflow: hidden;
        border: 1px solid #e5e7eb;
        margin-top: 10px;
    }

    /* === 2. é¡¶éƒ¨å¯¼èˆªæ  === */
    .workspace-header {
        height: 64px;
        border-bottom: 1px solid #f3f4f6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 24px;
        background: #fff;
        z-index: 10;
        flex-shrink: 0;
    }
    .header-title { font-weight: 700; font-size: 1.1rem; color: #111827; }
    .status-pill {
        font-size: 0.75rem; font-weight: 600;
        padding: 4px 12px; border-radius: 20px;
        background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7;
    }
    .token-pill {
        font-family: 'Menlo', monospace; font-size: 0.75rem;
        background: #f9fafb; color: #6b7280;
        padding: 4px 10px; border-radius: 6px; border: 1px solid #e5e7eb;
    }

    /* === 3. å·¦ä¾§å·¥ä½œæµå¯¼èˆª (Sidebar) === */
    .workflow-sidebar {
        width: 260px;
        background-color: #f9fafb;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        height: 100%;
        flex-shrink: 0;
    }
    
    .nav-section-title {
        font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
        color: #9ca3af; margin: 20px 20px 10px;
    }

    /* æ­¥éª¤é¡¹ */
    .step-item {
        margin: 4px 12px;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        color: #4b5563;
        transition: all 0.2s;
        position: relative;
    }
    .step-item:hover { background-color: #e5e7eb; color: #111827; }
    
    /* æ¿€æ´»çŠ¶æ€ */
    .step-item.active-step {
        background-color: #fff;
        color: #2563eb; /* è“è‰² */
        font-weight: 600;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
    }
    /* æ¿€æ´»çŠ¶æ€ä¸‹çš„å·¦ä¾§æŒ‡ç¤ºæ¡ */
    .step-item.active-step::before {
        content: ""; position: absolute; left: -12px; top: 50%; transform: translateY(-50%);
        height: 20px; width: 4px; border-radius: 0 4px 4px 0;
        background-color: #2563eb;
    }
    
    .step-item.locked { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
    .step-icon { width: 20px; display: flex; justify-content: center; margin-right: 12px; }

    /* === 4. èŠå¤©åŒºåŸŸ (æ ¸å¿ƒå¸ƒå±€ä¿®å¤ï¼šFlexå‚ç›´æ’åˆ—) === */
    .chat-area {
        flex: 1;
        background-color: #fff;
        position: relative;
        display: flex;
        flex-direction: column; /* å‚ç›´æ’åˆ—ï¼šä¸Šæ¶ˆæ¯ï¼Œä¸‹è¾“å…¥æ¡† */
        height: 100%; 
        overflow: hidden; /* é˜²æ­¢å¤–å±‚æ»šåŠ¨ */
    }
    
    .messages-container {
        flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
        overflow-y: auto; /* åªæœ‰è¿™é‡Œæ»šåŠ¨ */
        padding: 30px;
        scroll-behavior: smooth;
    }

    /* AI æ¶ˆæ¯æ ·å¼ (æ–‡æ¡£æµé£æ ¼) */
    .msg-row { display: flex; margin-bottom: 24px; gap: 16px; opacity: 0; animation: fadeIn 0.3s forwards; }
    @keyframes fadeIn { to { opacity: 1; } }

    .msg-avatar {
        width: 36px; height: 36px; flex-shrink: 0;
        border-radius: 8px; display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem;
    }
    .avatar-ai { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; box-shadow: 0 2px 4px rgba(59,130,246,0.3); }
    .avatar-user { background: #f3f4f6; color: #4b5563; }

    .msg-content {
        flex: 1; min-width: 0;
        padding-top: 6px; /* å¯¹é½å¤´åƒ */
        font-size: 1rem;
        line-height: 1.6;
        color: #374151;
    }
    
    /* ç”¨æˆ·æ¶ˆæ¯æ ·å¼ (æ°”æ³¡é£æ ¼) */
    .msg-row.user-row { flex-direction: row-reverse; }
    .msg-row.user-row .msg-content {
        background-color: #eff6ff;
        color: #1e3a8a;
        padding: 12px 16px;
        border-radius: 12px 12px 2px 12px;
        flex: 0 1 auto; /* è‡ªé€‚åº”å®½åº¦ */
        max-width: 80%;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    /* Vditor æ ·å¼å¾®è°ƒ */
    .vditor-reset { font-family: 'Inter', sans-serif !important; font-size: 0.95rem !important; }
    .vditor-reset p { margin-bottom: 0.8em !important; }
    .msg-row.user-row .vditor-reset { color: #1e40af !important; }

    /* === 5. åº•éƒ¨è¾“å…¥æ¡† (å¸ƒå±€ä¿®å¤ï¼šæ”¹ä¸ºæµå¼å¸ƒå±€) === */
    .input-wrapper {
        position: relative; /* ç›¸å¯¹å®šä½ */
        flex-shrink: 0; /* ç¦æ­¢è¢«å‹ç¼© */
        padding: 20px 30px 30px;
        background: #fff;
        border-top: 1px solid #f3f4f6;
        z-index: 20;
    }
    .input-box {
        background: #fff;
        border: 1px solid #e5e7eb;
        box-shadow: 0 4px 20px -2px rgba(0,0,0,0.08);
        border-radius: 16px;
        padding: 8px;
        display: flex;
        align-items: flex-end;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .input-box:focus-within {
        border-color: #3b82f6;
        box-shadow: 0 4px 20px -2px rgba(59,130,246,0.2);
    }
    #user-input {
        border: none; background: transparent; padding: 12px 16px;
        resize: none; max-height: 200px;
        font-size: 1rem; flex: 1;
    }
    #user-input:focus { outline: none; box-shadow: none; }
    
    #btn-send {
        width: 40px; height: 40px; border-radius: 10px;
        background: #3b82f6; color: white; border: none;
        display: flex; align-items: center; justify-content: center;
        margin: 4px; transition: all 0.2s;
    }
    #btn-send:hover { background: #2563eb; transform: scale(1.05); }
    #btn-send:active { transform: scale(0.95); }

    /* === 6. æ–‡æ¡£æŠ½å±‰ (Slide-Over) === */
    .doc-drawer {
        position: fixed; top: 0; right: -800px; width: 800px; height: 100vh;
        background: white; box-shadow: -10px 0 40px rgba(0,0,0,0.1);
        transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        z-index: 3000; display: flex; flex-direction: column;
    }
    .doc-drawer.open { right: 0; }
    .drawer-backdrop {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.3); backdrop-filter: blur(2px);
        z-index: 2999; display: none; opacity: 0; transition: opacity 0.3s;
    }
    .drawer-backdrop.show { display: block; opacity: 1; }

    .drawer-header {
        height: 64px; border-bottom: 1px solid #e5e7eb;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 24px; background: #f9fafb;
    }
    .drawer-body { flex: 1; overflow: hidden; position: relative; }
    #vditor-container { height: 100% !important; border: none !important; }
    .drawer-footer {
        padding: 16px 24px; border-top: 1px solid #e5e7eb; background: #fff;
        display: flex; justify-content: flex-end; gap: 12px;
    }

    /* === 7. åŠ è½½åŠ¨ç”» === */
    #loading-overlay {
        backdrop-filter: blur(4px);
    }
    .typing-indicator span {
        display: inline-block; width: 6px; height: 6px; background-color: #3b82f6;
        border-radius: 50%; animation: typing 1.4s infinite ease-in-out both;
        margin: 0 2px;
    }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
</style>

<div class="col-12">
    <div class="workspace-wrapper">
        
        <div class="workspace-header">
            <div class="d-flex align-items-center">
                <a href="{% url 'innovation_agent:project_list' %}" class="btn btn-light btn-sm rounded-lg me-3 border text-muted">
                    <i class="bi bi-chevron-left"></i>
                </a>
                <div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="header-title">{{ project.title }}</span>
                        <span class="status-pill" id="project-status-badge">{{ project.get_status_display }}</span>
                    </div>
                </div>
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <div class="token-pill">
                    <i class="bi bi-lightning-charge-fill text-warning me-1"></i>
                    <span id="token-counter">{{ project.total_tokens_used }}</span> tokens
                </div>
                {% if project.status == 6 %}
                <a href="{% url 'innovation_agent:download_project' project.id %}" class="btn btn-sm btn-dark rounded-lg shadow-sm">
                    <i class="bi bi-download me-2"></i>å¯¼å‡ºæŠ¥å‘Š
                </a>
                {% endif %}
            </div>
        </div>

        <div class="d-flex flex-grow-1 overflow-hidden">
            
            <div class="workflow-sidebar d-none d-md-flex custom-scrollbar">
                <div class="nav-section-title">Workflow Progress</div>
                
                <div id="file-list">
                    <div class="step-item" onclick="openDoc('base', 'Baseline Analysis')" id="nav-base">
                        <div class="step-icon"><i class="bi bi-file-earmark-text"></i></div>
                        <span>Baseline Analysis</span>
                        {% if project.status > 0 %}
                        <i class="bi bi-check-circle-fill text-success ms-auto"></i>
                        {% endif %}
                    </div>
                    
                    <div style="margin-left: 21px; height: 16px; border-left: 1px dashed #d1d5db;"></div>

                    <div class="step-item {% if project.status < 2 %}locked{% endif %}" onclick="openDoc('innov1', 'Innovation 1')" id="nav-innov1">
                        <div class="step-icon"><i class="bi bi-1-circle"></i></div>
                        <span>Innovation Point 1</span>
                        {% if project.status > 2 %}<i class="bi bi-check-circle-fill text-success ms-auto"></i>{% endif %}
                    </div>
                    <div style="margin-left: 21px; height: 16px; border-left: 1px dashed #d1d5db;"></div>

                    <div class="step-item {% if project.status < 3 %}locked{% endif %}" onclick="openDoc('innov2', 'Innovation 2')" id="nav-innov2">
                        <div class="step-icon"><i class="bi bi-2-circle"></i></div>
                        <span>Innovation Point 2</span>
                        {% if project.status > 3 %}<i class="bi bi-check-circle-fill text-success ms-auto"></i>{% endif %}
                    </div>
                    <div style="margin-left: 21px; height: 16px; border-left: 1px dashed #d1d5db;"></div>

                    <div class="step-item {% if project.status < 4 %}locked{% endif %}" onclick="openDoc('innov3', 'Innovation 3')" id="nav-innov3">
                        <div class="step-icon"><i class="bi bi-3-circle"></i></div>
                        <span>Innovation Point 3</span>
                        {% if project.status > 4 %}<i class="bi bi-check-circle-fill text-success ms-auto"></i>{% endif %}
                    </div>
                    
                    <div style="margin-left: 21px; height: 16px; border-left: 1px dashed #d1d5db;"></div>

                    <div class="step-item {% if project.status < 5 %}locked{% endif %}" onclick="openDoc('exp', 'Experimental Design')" id="nav-exp">
                        <div class="step-icon"><i class="bi bi-flask"></i></div>
                        <span>Experimental Design</span>
                        {% if project.status > 5 %}<i class="bi bi-check-circle-fill text-success ms-auto"></i>{% endif %}
                    </div>
                </div>

                <div class="mt-auto p-4 border-top">
                    <div id="upload-area" class="{% if project.status > 0 %}d-none{% endif %}">
                        <input type="file" id="file-input" class="d-none" accept=".pdf" onchange="handleFileUpload()">
                        <button class="btn btn-primary w-100 rounded-lg py-2 fw-bold shadow-sm" onclick="document.getElementById('file-input').click()">
                            <i class="bi bi-upload me-2"></i> ä¸Šä¼  PDF
                        </button>
                        <div class="text-center mt-2 text-muted small" style="font-size: 0.75rem;">æ”¯æŒ .pdf æ ¼å¼è®ºæ–‡</div>
                    </div>
                </div>
            </div>

            <div class="chat-area">
                <div class="messages-container" id="chat-box">
                    {% if not chat_history %}
                    <div class="msg-row">
                        <div class="msg-avatar avatar-ai"><i class="bi bi-stars"></i></div>
                        <div class="msg-content">
                            <h5 class="fw-bold mb-2">æ¬¢è¿æ¥åˆ° Innovation Workspace</h5>
                            <p>æˆ‘æ˜¯ä½ çš„ AI ç§‘ç ”åˆä¼™äººã€‚æˆ‘ä»¬å°†ä¸€èµ·å®Œæˆä» Baseline åˆ†æåˆ°å®éªŒè®¾è®¡çš„å…¨è¿‡ç¨‹ã€‚</p>
                            {% if project.status == 0 %}
                            <p class="text-muted"><i class="bi bi-arrow-left me-1"></i> è¯·å…ˆåœ¨å·¦ä¾§ä¾§è¾¹æ ä¸Šä¼ ä¸€ç¯‡ Baseline è®ºæ–‡ PDF å¼€å§‹ã€‚</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    <div id="history-marker"></div>
                </div>

                <div class="input-wrapper">
                    <div class="text-center mb-2">
                         <span id="action-hint" class="badge bg-white border text-secondary shadow-sm fw-normal px-3 py-1 rounded-pill">...</span>
                    </div>
                    <div class="input-box">
                        <textarea id="user-input" rows="1" placeholder="ä¸ AI åˆä¼™äººå¯¹è¯... (Shift+Enter æ¢è¡Œ)" oninput="this.style.height = ''; this.style.height = Math.min(this.scrollHeight, 200) + 'px'"></textarea>
                        <button id="btn-send"><i class="bi bi-arrow-up-short fs-4"></i></button>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted" style="font-size: 0.7rem;">AI generated content may be inaccurate.</small>
                    </div>
                </div>

                <div id="loading-overlay" class="position-absolute top-0 start-0 w-100 h-100 bg-white bg-opacity-80 d-none flex-column justify-content-center align-items-center" style="z-index: 50;">
                    <div class="typing-indicator mb-3">
                        <span></span><span></span><span></span>
                    </div>
                    <h6 class="fw-bold text-dark" id="loading-text">AI æ­£åœ¨æ€è€ƒ...</h6>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="drawer-backdrop" id="drawer-backdrop" onclick="closeDrawer()"></div>
<div class="doc-drawer" id="doc-drawer">
    <div class="drawer-header">
        <div class="d-flex align-items-center gap-2">
            <div class="bg-primary bg-opacity-10 text-primary p-2 rounded-lg"><i class="bi bi-file-earmark-richtext"></i></div>
            <span class="fw-bold fs-5" id="drawer-title">Document</span>
        </div>
        <button class="btn btn-light btn-sm rounded-circle" onclick="closeDrawer()"><i class="bi bi-x-lg"></i></button>
    </div>
    
    <div class="drawer-body">
        <div id="vditor-container"></div>
    </div>
    
    <div class="drawer-footer">
        <button class="btn btn-light border fw-medium px-4" onclick="closeDrawer()">å–æ¶ˆ</button>
        <button class="btn btn-primary fw-bold px-4 shadow-sm" id="btn-drawer-confirm" onclick="confirmCurrentDoc()">
            <i class="bi bi-check-lg me-2"></i> ç¡®è®¤å®šç¨¿
        </button>
    </div>
</div>

<script>
    const projectId = "{{ project.id }}";
    let currentStep = {{ step }}; 
    const csrfToken = "{{ csrf_token }}";
    let vditorInstance;
    let currentEditingDocType = null;
    
    document.addEventListener("DOMContentLoaded", function() {
        renderUIByStep();
        initVditor();
        
        // åŠ è½½å†å²æ¶ˆæ¯
        const historyData = [
            {% for chat in chat_history %}
            { role: "{{ chat.role }}", content: `{{ chat.content|escapejs }}` },
            {% endfor %}
        ];
        historyData.forEach(msg => addChatMsg(msg.role === 'user' ? 'User' : 'AI', msg.content));

        document.getElementById('user-input').addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
        });
        document.getElementById('btn-send').addEventListener('click', sendChat);
    });

    function scrollToBottom() {
        const chatBox = document.getElementById('chat-box');
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // === Vditor (æŠ½å±‰ç¼–è¾‘å™¨) ===
    function initVditor() {
        vditorInstance = new Vditor('vditor-container', {
            mode: 'ir', height: '100%', cache: { enable: false },
            toolbar: ['emoji', 'headings', 'bold', 'italic', 'strike', 'link', '|', 'list', 'ordered-list', 'check', 'outdent', 'indent', '|', 'quote', 'line', 'code', 'inline-code', '|', 'table', 'fullscreen', 'edit-mode'],
            preview: { math: { engine: 'KaTeX' } },
            placeholder: "AI ç”Ÿæˆå†…å®¹å°†æ˜¾ç¤ºåœ¨æ­¤å¤„..."
        });
    }

    // === æ ¸å¿ƒï¼šæ·»åŠ æ¶ˆæ¯ ===
    function addChatMsg(role, text) {
        const box = document.getElementById('chat-box');
        const row = document.createElement('div');
        row.className = `msg-row ${role === 'User' ? 'user-row' : 'ai-row'}`;
        
        // Avatar
        const avatar = document.createElement('div');
        avatar.className = `msg-avatar ${role === 'User' ? 'avatar-user' : 'avatar-ai'}`;
        avatar.innerHTML = role === 'User' ? '<i class="bi bi-person-fill"></i>' : '<i class="bi bi-stars"></i>';
        
        // Content
        const content = document.createElement('div');
        content.className = "msg-content";
        
        // ID for rendering
        const contentId = 'msg-content-' + Math.random().toString(36).substr(2, 9);
        content.innerHTML = `<div id="${contentId}"></div>`;
        
        row.appendChild(avatar);
        row.appendChild(content);
        box.appendChild(row);

        // Render Markdown
        Vditor.preview(document.getElementById(contentId), text, {
            mode: 'light', anchor: 0, 
            preview: { math: { engine: 'KaTeX' } },
            after: () => scrollToBottom()
        });
    }

    // === æŠ½å±‰æ§åˆ¶ ===
    function openDrawer(title, content, docType, canConfirm) {
        document.getElementById('drawer-title').innerText = title;
        document.getElementById('doc-drawer').classList.add('open');
        document.getElementById('drawer-backdrop').classList.add('show');
        setTimeout(() => vditorInstance.setValue(content), 100);
        
        currentEditingDocType = docType;
        const confirmBtn = document.getElementById('btn-drawer-confirm');
        confirmBtn.style.display = canConfirm ? 'block' : 'none';
    }

    function closeDrawer() {
        document.getElementById('doc-drawer').classList.remove('open');
        document.getElementById('drawer-backdrop').classList.remove('show');
    }

    // === ä¾§è¾¹æ æ–‡ä»¶ç‚¹å‡» ===
    function openDoc(docType, title) {
        const navItem = document.getElementById(`nav-${docType}`);
        if (navItem.classList.contains('locked')) return;

        fetch(`/innovation/api/${projectId}/get_doc/?type=${docType}`)
            .then(r => r.json())
            .then(data => {
                if(data.status === 'ok') {
                    let isCurrent = false;
                    if (docType === 'base' && currentStep === 1) isCurrent = true;
                    if (docType === 'innov1' && currentStep === 2) isCurrent = true;
                    if (docType === 'innov2' && currentStep === 3) isCurrent = true;
                    if (docType === 'innov3' && currentStep === 4) isCurrent = true;
                    if (docType === 'exp' && currentStep === 5) isCurrent = true;
                    openDrawer(title, data.content || "", docType, isCurrent);
                }
            });
    }

    // === ä¸šåŠ¡é€»è¾‘ï¼šä¸Šä¼  ===
    function handleFileUpload() {
        const input = document.getElementById('file-input');
        if (!input.files[0]) return;
        const formData = new FormData();
        formData.append('file', input.files[0]);
        formData.append('csrfmiddlewaretoken', csrfToken);

        setLoading(true, "ä¸Šä¼ ä¸­...");
        fetch(`/innovation/api/${projectId}/upload_baseline/`, { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            setLoading(false);
            if(data.status === 'ok') {
                currentStep = 1;
                renderUIByStep();
                document.getElementById('project-status-badge').innerText = "Baseline Analysis";
                document.getElementById('upload-area').classList.add('d-none');
                addChatMsg("AI", "âœ… PDF ä¸Šä¼ æˆåŠŸã€‚æˆ‘å·²å‡†å¤‡å¥½é˜…è¯»è®ºæ–‡ã€‚");
                appendSystemAction("ğŸš€ ç”Ÿæˆ Baseline æ€»ç»“", "triggerSummary()");
            } else {
                alert(data.msg);
            }
        });
    }

    // === ä¸šåŠ¡é€»è¾‘ï¼šç”Ÿæˆæ€»ç»“ ===
    window.triggerSummary = function() {
        setLoading(true, "AI æ­£åœ¨æ·±åº¦é˜…è¯»è®ºæ–‡...");
        fetch(`/innovation/api/${projectId}/generate_base_summary/`, {
            method: 'POST', headers: {'X-CSRFToken': csrfToken}
        })
        .then(r => r.json())
        .then(data => {
            setLoading(false);
            if(data.status === 'ok') {
                currentStep = 2; renderUIByStep(); updateToken(data.tokens);
                document.getElementById('project-status-badge').innerText = "Innovation 1";
                openDrawer("Baseline Summary", data.content, 'base', false);
                addChatMsg("AI", "âœ… Baseline åˆ†æå®Œæˆ (è¯·æŸ¥çœ‹å³ä¾§æ–‡æ¡£)ã€‚\n\nç°åœ¨æˆ‘ä»¬å¼€å§‹æ„æ€ **Innovation Point 1**ã€‚ä½ å¯ä»¥ç›´æ¥å‘Šè¯‰æˆ‘ä½ çš„æƒ³æ³•ï¼Œæˆ–è€…è®©æˆ‘åŸºäº Baseline çš„å¼±ç‚¹è¿›è¡Œæ¨èã€‚");
            } else {
                alert("ç”Ÿæˆå¤±è´¥: " + data.msg);
            }
        });
    }

    // === ä¸šåŠ¡é€»è¾‘ï¼šå¯¹è¯ ===
    function sendChat() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if(!text) return;
        
        // ç®€å•è·¯ç”±æ‹¦æˆª
        if (currentStep === 1) { 
            if(text.includes("ç”Ÿæˆ")) triggerSummary(); 
            else addChatMsg("AI", "è¯·ç‚¹å‡»æŒ‰é’®ç”Ÿæˆ Baseline æ€»ç»“ã€‚"); 
            input.value=''; return; 
        }
        if (currentStep === 5 && text.includes("å®éªŒ")) { triggerExperiment(); input.value=''; return; }
        if (![2, 3, 4].includes(currentStep)) {
            addChatMsg("User", text);
            addChatMsg("AI", "å½“å‰é˜¶æ®µä¸éœ€è¦å¯¹è¯ï¼Œè¯·æ£€æŸ¥å·¦ä¾§è¿›åº¦ã€‚");
            input.value = ''; return;
        }

        addChatMsg("User", text);
        input.value = '';
        setLoading(true, "AI åˆä¼™äººæ­£åœ¨æ¨å¯¼...");

        fetch(`/innovation/api/${projectId}/chat_innovation/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
            body: JSON.stringify({ idea: text })
        })
        .then(r => r.json())
        .then(data => {
            setLoading(false);
            if(data.status === 'ok') {
                updateToken(data.tokens);
                addChatMsg("AI", data.chat_content);
                
                if (data.is_draft) {
                    const stepName = `Innovation ${currentStep - 1}`;
                    const docKey = `innov${currentStep - 1}`;
                    openDrawer(stepName, data.draft_content, docKey, true);
                    appendSystemAction("ğŸ‘€ æŸ¥çœ‹è‰ç¨¿ / ç¡®è®¤å®šç¨¿", `openDoc('${docKey}', '${stepName}')`);
                }
            } else {
                addChatMsg("AI", "âŒ " + data.msg);
            }
        });
    }

    // === ä¸šåŠ¡é€»è¾‘ï¼šç”Ÿæˆå®éªŒ ===
    window.triggerExperiment = function() {
        setLoading(true, "æ­£åœ¨è®¾è®¡å®éªŒæ–¹æ¡ˆ...");
        fetch(`/innovation/api/${projectId}/generate_experiment/`, {
            method: 'POST', headers: {'X-CSRFToken': csrfToken}
        })
        .then(r => r.json())
        .then(data => {
            setLoading(false);
            if(data.status === 'ok') {
                updateToken(data.tokens);
                openDrawer("Experiment Design", data.draft_content, 'exp', true);
                addChatMsg("AI", data.chat_content);
                appendSystemAction("ğŸ‘€ æŸ¥çœ‹æ–¹æ¡ˆ / å®Œæˆé¡¹ç›®", "openDoc('exp', 'Experiment Design')");
            }
        });
    }

    // === ä¸šåŠ¡é€»è¾‘ï¼šç¡®è®¤æ–‡æ¡£ ===
    window.confirmCurrentDoc = function() {
        if (!confirm("ç¡®è®¤å®šç¨¿ï¼Ÿè¿™å°†ä¿å­˜å†…å®¹å¹¶è¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚")) return;
        const content = vditorInstance.getValue();
        closeDrawer();
        setLoading(true, "ä¿å­˜ä¸­...");

        fetch(`/innovation/api/${projectId}/confirm_step/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
            body: JSON.stringify({ content: content })
        })
        .then(r => r.json())
        .then(data => {
            setLoading(false);
            if(data.status === 'ok') {
                currentStep = data.next_step;
                renderUIByStep(); 
                document.getElementById('project-status-badge').innerText = `Step ${currentStep}`;
                
                if (currentStep === 3) addChatMsg("AI", "âœ… åˆ›æ–°ç‚¹ 1 å·²é”å®šã€‚å¼€å§‹ **åˆ›æ–°ç‚¹ 2**ã€‚");
                if (currentStep === 4) addChatMsg("AI", "âœ… åˆ›æ–°ç‚¹ 2 å·²é”å®šã€‚å¼€å§‹ **åˆ›æ–°ç‚¹ 3**ã€‚");
                if (currentStep === 5) {
                    addChatMsg("AI", "âœ… æ‰€æœ‰åˆ›æ–°ç‚¹å·²å°±ç»ªã€‚ä¸‹ä¸€æ­¥ï¼šå®éªŒè®¾è®¡ã€‚");
                    appendSystemAction("ğŸ§ª ç”Ÿæˆå®éªŒæ–¹æ¡ˆ", "triggerExperiment()");
                }
                if (currentStep === 6) {
                    addChatMsg("AI", "ğŸ‰ æ­å–œï¼é¡¹ç›®å·²å…¨éƒ¨å®Œæˆã€‚");
                    setTimeout(() => location.reload(), 1500);
                }
            } else {
                alert(data.msg);
            }
        });
    }

    // === UI å·¥å…·å‡½æ•° ===
    function renderUIByStep() {
        const navItems = {
            1: 'nav-base', 2: 'nav-innov1', 3: 'nav-innov2', 
            4: 'nav-innov3', 5: 'nav-exp', 6: 'nav-exp'
        };
        document.querySelectorAll('.step-item').forEach(el => el.classList.remove('active-step'));
        for (let s = 1; s <= currentStep && s <= 5; s++) {
            const el = document.getElementById(navItems[s]);
            if(el) el.classList.remove('locked');
        }
        if (navItems[currentStep]) {
            document.getElementById(navItems[currentStep]).classList.add('active-step');
        } else if (currentStep > 5) {
            document.getElementById('nav-exp').classList.add('active-step');
        }
        
        const hint = document.getElementById('action-hint');
        if (currentStep === 0) hint.innerText = "ğŸ‘‰ è¯·å…ˆä¸Šä¼  PDF";
        else if (currentStep === 1) hint.innerText = "ğŸ‘‰ ç‚¹å‡»â€œç”Ÿæˆ Baseline æ€»ç»“â€";
        else if ([2,3,4].includes(currentStep)) hint.innerText = `ğŸ’¡ æ­£åœ¨æ„æ€ Innovation ${currentStep-1}`;
        else if (currentStep === 5) hint.innerText = "ğŸ§ª ç”Ÿæˆå®éªŒ";
        else hint.innerText = "ğŸ‰ å·²å®Œæˆ";
    }

    function setLoading(isLoading, text="åŠ è½½ä¸­...") {
        const overlay = document.getElementById('loading-overlay');
        const textEl = document.getElementById('loading-text');
        if(isLoading) {
            overlay.classList.remove('d-none');
            overlay.classList.add('d-flex');
            textEl.innerText = text;
        } else {
            overlay.classList.add('d-none');
            overlay.classList.remove('d-flex');
        }
    }

    function appendSystemAction(text, func) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = "text-center my-3";
        div.innerHTML = `<button class="btn btn-sm btn-primary rounded-pill px-4 shadow-sm" onclick="${func}">${text}</button>`;
        box.appendChild(div);
        scrollToBottom();
    }

    function updateToken(val) {
        document.getElementById('token-counter').innerText = val;
    }
</script>
{% endblock %}