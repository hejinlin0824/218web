{% extends 'base.html' %}

{% block title %}å®éªŒå®¤ä»‹ç» - DSSG Lab{% endblock %}

{% block content %}
<style>
    /* === å®éªŒå®¤ä»‹ç»é¡µä¸“ç”¨æ ·å¼ === */

    /* 1. å¤´éƒ¨ Banner */
    .lab-hero {
        background: linear-gradient(120deg, #2c3e50 0%, #4ca1af 100%);
        color: white;
        border-radius: 1rem;
        padding: 4rem 2rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 1rem 3rem rgba(0,0,0,0.15);
    }
    .lab-hero::after {
        content: "DSSG";
        position: absolute;
        top: -20px;
        right: 20px;
        font-size: 8rem;
        font-weight: 900;
        opacity: 0.1;
        pointer-events: none;
    }

    /* 2. æˆå‘˜å¡ç‰‡ (Member Card) */
    .member-card {
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        border: none;
        background: white;
        overflow: hidden;
    }
    .member-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 1rem 2rem rgba(0,0,0,0.1) !important;
    }
    
    /* å¤´åƒæ ·å¼ */
    .avatar-fixed-box {
        position: relative;
        flex-shrink: 0;
        width: 60px;
        height: 60px;
        margin-right: 1rem;
    }
    .avatar-fixed-img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #fff;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        display: block;
    }

    /* å­¦ç”Ÿå¤´åƒå±…ä¸­ */
    .student-avatar-box {
        width: 50px;
        height: 50px;
        margin: 0 auto 0.5rem;
    }

    /* 3. ç ”ç©¶æ–¹å‘ (Topic) */
    .topic-card-header {
        background-color: white;
        transition: background-color 0.2s;
    }
    .topic-card-header:hover {
        background-color: #f8f9fa;
    }
    .topic-icon {
        width: 50px;
        height: 50px;
        min-width: 50px;
        background: rgba(13, 110, 253, 0.1);
        color: #0d6efd;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    /* 4. è®ºæ–‡æˆæœ */
    .pub-item {
        border-left: 4px solid transparent;
        transition: all 0.2s;
    }
    .pub-item:hover {
        background-color: #f8f9fa;
        border-left-color: #0d6efd;
    }
    .pub-highlight {
        background-color: #fffbf0;
        border-left-color: #ffc107;
    }
    .pub-year-badge {
        font-family: 'Courier New', Courier, monospace;
        font-weight: bold;
        opacity: 0.6;
        min-width: 50px;
        display: inline-block;
    }

    /* ç®€ä»‹å±•å¼€åŒº */
    .bio-expand-section {
        display: none; /* é»˜è®¤éšè— */
        background: #f8f9fa;
        border-left: 4px solid #0d6efd;
        border-radius: 0 8px 8px 0;
    }
    
    /* ğŸ”¥ æ»šåŠ¨æ¡ä¼˜åŒ–ï¼šé™åˆ¶ç®€ä»‹é«˜åº¦ï¼Œé˜²æ­¢é¡µé¢è¿‡é•¿ */
    .bio-scroll-content {
        max-height: 400px; /* å›ºå®šé«˜åº¦ */
        overflow-y: auto;  /* è¶…å‡ºæ»šåŠ¨ */
        padding-right: 5px; /* é˜²æ­¢æ»šåŠ¨æ¡é®æŒ¡æ–‡å­— */
    }
    /* ç¾åŒ–æ»šåŠ¨æ¡ */
    .bio-scroll-content::-webkit-scrollbar { width: 4px; }
    .bio-scroll-content::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

    /* åŠ è½½åŠ¨ç”» */
    .loading-spinner-container {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        color: #6c757d;
        font-size: 0.9rem;
    }
</style>

<div class="container-xl">
    
    <div class="lab-hero mb-5 animate__animated animate__fadeIn">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-5 fw-bold mb-3">æ•°æ®ç§‘å­¦ä¸æ™ºèƒ½è®¡ç®—å®éªŒå®¤</h1>
                <p class="lead mb-4 opacity-90">Data Science & Smart Generation Laboratory (DSSG)</p>
                <div class="d-flex gap-3">
                    <div class="d-flex align-items-center bg-white bg-opacity-10 rounded-pill px-3 py-2 border border-white border-opacity-25">
                        <span class="fs-5 me-2">ğŸ“</span>
                        <span>æˆå‘˜ <strong>{{ students.count|add:faculties.count }}</strong> äºº</span>
                    </div>
                    <div class="d-flex align-items-center bg-white bg-opacity-10 rounded-pill px-3 py-2 border border-white border-opacity-25">
                        <span class="fs-5 me-2">ğŸ“œ</span>
                        <span>æˆæœ <strong>{{ publications.count }}</strong> é¡¹</span>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 text-center d-none d-lg-block">
                <div style="font-size: 8rem; opacity: 0.8;">ğŸ§¬</div>
            </div>
        </div>
    </div>

    <div class="row g-5">
        
        <div class="col-lg-8">
            
            <section class="mb-5 animate__animated animate__fadeInUp">
                <div class="d-flex align-items-center mb-4">
                    <h3 class="fw-bold mb-0 text-dark">ğŸ”¬ ç ”ç©¶æ–¹å‘</h3>
                    <div class="ms-3 flex-grow-1 border-bottom"></div>
                </div>
                
                <div class="accordion shadow-sm rounded-3 overflow-hidden border-0" id="researchAccordion">
                    {% for topic in topics %}
                    <div class="accordion-item border-0 border-bottom">
                        <h2 class="accordion-header" id="heading{{ topic.id }}">
                            <button class="accordion-button collapsed topic-card-header py-4" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#collapse{{ topic.id }}" 
                                    aria-expanded="false" aria-controls="collapse{{ topic.id }}">
                                <div class="d-flex align-items-center w-100">
                                    <div class="topic-icon me-3">
                                        {{ topic.icon }}
                                    </div>
                                    <div>
                                        <h5 class="fw-bold mb-1 text-dark">{{ topic.title }}</h5>
                                        <small class="text-muted">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</small>
                                    </div>
                                </div>
                            </button>
                        </h2>
                        <div id="collapse{{ topic.id }}" class="accordion-collapse collapse" 
                             aria-labelledby="heading{{ topic.id }}" data-bs-parent="#researchAccordion">
                            <div class="accordion-body bg-light p-4">
                                <div id="topic-loading-{{ topic.id }}" class="loading-spinner-container">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                    èµ„æºåŠ è½½ä¸­...
                                </div>
                                <div id="topic-render-{{ topic.id }}" class="vditor-reset fs-6 text-secondary d-none"></div>
                                <div id="topic-source-{{ topic.id }}" class="d-none">{{ topic.description }}</div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5 text-muted">æš‚æ— ç ”ç©¶æ–¹å‘æ•°æ®ã€‚</div>
                    {% endfor %}
                </div>
            </section>

            <section class="animate__animated animate__fadeInUp animate__delay-1s">
                <div class="d-flex align-items-center mb-4">
                    <h3 class="fw-bold mb-0 text-dark">ğŸ† ä»£è¡¨æ€§æˆæœ</h3>
                    <div class="ms-3 flex-grow-1 border-bottom"></div>
                </div>

                <div class="card shadow-sm border-0 rounded-3">
                    <div class="list-group list-group-flush rounded-3">
                        {% for pub in publications %}
                        <a href="{{ pub.link|default:'#' }}" target="_blank" class="list-group-item list-group-item-action p-4 pub-item {% if pub.is_highlight %}pub-highlight{% endif %}">
                            <div class="d-flex">
                                <div class="me-3 text-center flex-shrink-0">
                                    <span class="badge bg-light text-dark border pub-year-badge">{{ pub.year }}</span>
                                </div>
                                <div class="flex-grow-1">
                                    <h5 class="mb-1 fw-bold text-dark lh-base">
                                        {% if pub.is_highlight %}
                                            <span class="text-danger me-1">ğŸ”¥</span>
                                        {% endif %}
                                        {{ pub.title }}
                                    </h5>
                                    <div class="text-secondary small mb-1 fst-italic">{{ pub.authors }}</div>
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span class="badge bg-secondary bg-opacity-10 text-dark fw-bold">{{ pub.venue }}</span>
                                        {% if pub.link %}
                                            <span class="text-primary small fw-bold">View Paper <i class="bi bi-arrow-up-right"></i></span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </a>
                        {% empty %}
                        <div class="text-center py-5 text-muted">æš‚æ— æˆæœå±•ç¤ºã€‚</div>
                        {% endfor %}
                    </div>
                </div>
            </section>

        </div>

        <div class="col-lg-4">
            
            <section class="mb-5 animate__animated animate__fadeInRight">
                <div class="d-flex align-items-center mb-4">
                    <h4 class="fw-bold mb-0 text-dark">ğŸ‘¨â€ğŸ« æŒ‡å¯¼æ•™å¸ˆ</h4>
                </div>
                
                <div class="row g-3">
                    {% for teacher in faculties %}
                    <div class="col-12">
                        <div class="card member-card shadow-sm rounded-3 p-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-fixed-box">
                                    {% if teacher.avatar %}
                                        <img src="{{ teacher.avatar.url }}" class="avatar-fixed-img">
                                    {% else %}
                                        <div class="avatar-fixed-img bg-dark text-white d-flex align-items-center justify-content-center fw-bold" style="font-size:1.5rem;">
                                            {{ teacher.username.0|upper }}
                                        </div>
                                    {% endif %}
                                    <span class="position-absolute bottom-0 start-100 translate-middle badge rounded-pill bg-primary border border-white">
                                        Lv.{{ teacher.level }}
                                    </span>
                                </div>
                                <div class="flex-grow-1 min-width-0">
                                    <h5 class="fw-bold mb-1 text-truncate">{{ teacher.nickname|default:teacher.username }}</h5>
                                    <p class="text-muted small mb-2 text-truncate">MIPS Lab å¯¼å¸ˆ</p>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-outline-primary py-0 px-3 rounded-pill faculty-bio-btn" 
                                                data-id="{{ teacher.id }}"
                                                onclick="toggleFacultyBio({{ teacher.id }})">
                                            ç®€ä»‹
                                        </button>
                                        <a href="{% url 'user_app:public_profile' teacher.pk %}" class="btn btn-sm btn-light py-0 px-3 rounded-pill">ä¸»é¡µ</a>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="faculty-bio-{{ teacher.id }}" class="bio-expand-section mt-3 p-3 small position-relative">
                                <div id="faculty-loading-{{ teacher.id }}" class="loading-spinner-container d-none">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                    åŠ è½½ä¸­...
                                </div>
                                <div class="bio-scroll-content">
                                    <div id="faculty-bio-render-{{ teacher.id }}" class="vditor-reset text-secondary d-none"></div>
                                </div>
                                <div id="faculty-bio-source-{{ teacher.id }}" class="d-none">{{ teacher.detailed_intro|default:"æš‚æ— ä»‹ç»" }}</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <section class="animate__animated animate__fadeInRight animate__delay-1s">
                <div class="d-flex align-items-center mb-4">
                    <h4 class="fw-bold mb-0 text-dark">ğŸ“ åœ¨è¯»ç»„å‘˜</h4>
                </div>

                <div class="row g-2">
                    {% for student in students %}
                    <div class="col-6">
                        <div class="card member-card shadow-sm rounded-3 text-center p-3 h-100">
                            <div class="avatar-fixed-box student-avatar-box mb-2 position-relative">
                                {% if student.avatar %}
                                    <img src="{{ student.avatar.url }}" class="avatar-fixed-img">
                                {% else %}
                                    <div class="avatar-fixed-img bg-secondary text-white d-flex align-items-center justify-content-center fw-bold w-100 h-100">
                                        {{ student.username.0|upper }}
                                    </div>
                                {% endif %}
                            </div>
                            <h6 class="fw-bold mb-2 text-truncate" style="font-size: 0.9rem;">{{ student.nickname|default:student.username }}</h6>
                            
                            <div class="d-flex justify-content-center gap-1">
                                <button class="btn btn-sm btn-light border py-0 px-2 small rounded-pill" style="font-size: 0.75rem;" onclick="toggleStudentBio({{ student.id }})">ç®€ä»‹</button>
                                <a href="{% url 'user_app:public_profile' student.pk %}" class="btn btn-sm btn-outline-secondary py-0 px-2 small rounded-pill" style="font-size: 0.75rem;">ä¸»é¡µ</a>
                            </div>
                            
                            <div id="student-bio-source-{{ student.id }}" class="d-none">{{ student.detailed_intro|default:"æš‚æ— ä»‹ç»" }}</div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-muted small">æš‚æ— åœ¨è¯»ç»„å‘˜</div>
                    {% endfor %}
                </div>

                <div id="shared-bio-display" class="card shadow-sm border-0 bg-light mt-3 d-none">
                    <div class="card-body position-relative">
                         <button type="button" class="btn-close position-absolute top-0 end-0 m-2" onclick="document.getElementById('shared-bio-display').classList.add('d-none')" aria-label="Close"></button>
                         <h6 class="fw-bold mb-2 text-primary" id="bio-title">æˆå‘˜ç®€ä»‹</h6>
                         
                         <div id="shared-loading" class="loading-spinner-container d-none">
                             <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                             åŠ è½½ä¸­...
                         </div>
                         
                         <div class="bio-scroll-content">
                             <div id="shared-bio-content" class="vditor-reset small d-none"></div>
                         </div>
                    </div>
                </div>
            </section>

        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/vditor/dist/index.css" />
<script src="https://unpkg.com/vditor/dist/method.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. æ¸²æŸ“ç ”ç©¶æ–¹å‘ (å¸¦åŠ è½½çŠ¶æ€)
        {% for topic in topics %}
            (function(){
                const loading = document.getElementById('topic-loading-{{ topic.id }}');
                const renderDiv = document.getElementById('topic-render-{{ topic.id }}');
                const sourceDiv = document.getElementById('topic-source-{{ topic.id }}');

                if (sourceDiv && renderDiv) {
                    Vditor.preview(renderDiv, sourceDiv.textContent.trim(), {
                        mode: 'light',
                        anchor: 0,
                        after() {
                            if(loading) loading.classList.add('d-none');
                            renderDiv.classList.remove('d-none');
                        }
                    });
                }
            })();
        {% endfor %}
    });

    // 2. å¯¼å¸ˆç®€ä»‹æ§åˆ¶ (äº’æ–¥å±•å¼€ + æ»šåŠ¨)
    function toggleFacultyBio(id) {
        const area = document.getElementById(`faculty-bio-${id}`);
        const render = document.getElementById(`faculty-bio-render-${id}`);
        const source = document.getElementById(`faculty-bio-source-${id}`);
        const loading = document.getElementById(`faculty-loading-${id}`);
        
        // å¦‚æœå½“å‰æ˜¯æ‰“å¼€çš„ï¼Œå°±å…³é—­å®ƒ
        if (area.style.display === 'block') {
            area.style.display = 'none';
            return;
        }

        // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šå…³é—­æ‰€æœ‰å…¶ä»–å¯¼å¸ˆçš„ç®€ä»‹
        document.querySelectorAll('.bio-expand-section').forEach(el => {
            el.style.display = 'none';
        });

        // å±•å¼€å½“å‰çš„
        area.style.display = 'block';
        
        // å¦‚æœè¿˜æ²¡æ¸²æŸ“è¿‡ï¼ˆé¿å…é‡å¤æ¸²æŸ“å¯¼è‡´é—ªçƒï¼‰ï¼Œæˆ–è€…ä½ æƒ³æ¯æ¬¡éƒ½é‡æ–°æ¸²æŸ“ä¹Ÿå¯ä»¥
        // è¿™é‡Œå‡è®¾æ¯æ¬¡ç‚¹å‡»éƒ½æ¸²æŸ“ä»¥ä¿è¯çŠ¶æ€ä¸€è‡´
        if(loading) loading.classList.remove('d-none');
        render.classList.add('d-none');

        Vditor.preview(render, source.textContent.trim(), {
            mode: 'light',
            after() {
                if(loading) loading.classList.add('d-none');
                render.classList.remove('d-none');
            }
        });
    }

    // 3. å­¦ç”Ÿç®€ä»‹æ§åˆ¶ (å…±ç”¨åŒºåŸŸ)
    function toggleStudentBio(id) {
        // å…³é—­æ‰€æœ‰å¯¼å¸ˆçš„å±•å¼€é¡¹ï¼Œé¿å…å¤ªä¹±
        document.querySelectorAll('.bio-expand-section').forEach(el => el.style.display = 'none');

        const displayBox = document.getElementById('shared-bio-display');
        const contentBox = document.getElementById('shared-bio-content');
        const loading = document.getElementById('shared-loading');
        const source = document.getElementById(`student-bio-source-${id}`);
        
        displayBox.classList.remove('d-none');
        
        if(loading) loading.classList.remove('d-none');
        contentBox.classList.add('d-none');

        // æ»šåŠ¨åˆ°ç®€ä»‹åŒº
        displayBox.scrollIntoView({ behavior: 'smooth', block: 'center' });

        Vditor.preview(contentBox, source.textContent.trim(), {
            mode: 'light',
            after() {
                if(loading) loading.classList.add('d-none');
                contentBox.classList.remove('d-none');
            }
        });
    }
</script>
{% endblock %}