{% extends 'base.html' %}

{% block title %}å®éªŒå®¤ä»‹ç» - DSSG Lab{% endblock %}

{% block content %}
<style>
    /* å¯¼å¸ˆ/ç»„å‘˜é€šç”¨å¤´åƒæ ·å¼ */
    .avatar-wrapper { position: relative; display: inline-block; vertical-align: middle; cursor: pointer; transition: transform 0.2s; }
    .avatar-wrapper:hover { transform: scale(1.05); }
    .avatar-wrapper img { border: 3px solid #fff; box-shadow: 0 0 0 2px #e0e0e0; border-radius: 50%; object-fit: cover; box-sizing: content-box; }
    .avatar-badge { position: absolute; bottom: -2px; right: -5px; background: linear-gradient(45deg, #FFD700, #FFA500); color: #fff; font-size: 0.6rem; font-weight: bold; padding: 1px 6px; border-radius: 10px; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10; white-space: nowrap; font-family: 'Courier New', Courier, monospace; }

    /* ç®€ä»‹å±•å¼€åŒºåŸŸ (é€šç”¨) */
    .bio-section {
        display: none; 
        overflow: hidden;
        transition: all 0.5s ease-in-out;
    }
    
    /* é€‰ä¸­å¤´åƒçš„é«˜äº®æ ·å¼ */
    .active-indicator {
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.25) !important;
        border-color: #0d6efd !important;
    }
    
    .popover { max-width: 250px; }
    
    .accordion-button:not(.collapsed) { color: #0d6efd; background-color: #e7f1ff; font-weight: bold; }
    .accordion-button:focus { box-shadow: none; border-color: rgba(0,0,0,.125); }
    .topic-render-content p:last-child { margin-bottom: 0; }
</style>

<div class="row justify-content-center">
    <div class="col-md-10">
        
        <div class="text-center mb-5">
            <h1 class="fw-bold display-5">ğŸ”¬ å…³äºå®éªŒå®¤</h1>
            <p class="text-muted lead">MIPS Lab</p>
            <hr class="w-25 mx-auto text-primary" style="height: 3px; opacity: 1;">
        </div>

        <div class="mb-5">
            <h3 class="fw-bold mb-4 border-start border-4 border-success ps-3">ç ”ç©¶æ–¹å‘</h3>
            <div class="accordion shadow-sm" id="researchAccordion">
                {% for topic in topics %}
                <div class="accordion-item border-0 border-bottom">
                    <h2 class="accordion-header" id="heading{{ topic.id }}">
                        <button class="accordion-button collapsed py-4" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ topic.id }}" aria-expanded="false" aria-controls="collapse{{ topic.id }}">
                            <span class="fs-4 me-3">{{ topic.icon }}</span>
                            <span class="fs-5">{{ topic.title }}</span>
                        </button>
                    </h2>
                    <div id="collapse{{ topic.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ topic.id }}" data-bs-parent="#researchAccordion">
                        <div class="accordion-body bg-light p-4">
                            <div id="topic-render-{{ topic.id }}" class="topic-render-content vditor-reset"></div>
                            <div id="topic-source-{{ topic.id }}" class="d-none">{{ topic.description }}</div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-muted p-3">æš‚æ— ç ”ç©¶æ–¹å‘æ•°æ®ã€‚</div>
                {% endfor %}
            </div>
        </div>

        <div class="mb-5">
            <h3 class="fw-bold mb-4 border-start border-4 border-primary ps-3">æŒ‡å¯¼æ•™å¸ˆ</h3>
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <div class="row row-cols-2 row-cols-md-5 g-4 text-center">
                        {% for teacher in faculties %}
                        <div class="col position-relative">
                            <div class="avatar-wrapper mb-2 faculty-avatar-item" 
                                 id="faculty-avatar-{{ teacher.id }}"
                                 tabindex="0"
                                 role="button"
                                 data-bs-toggle="popover" 
                                 data-bs-trigger="click" 
                                 data-bs-container="body"
                                 data-bs-html="true"
                                 data-bs-placement="top"
                                 data-bs-title="{{ teacher.nickname|default:teacher.username }}"
                                 data-bs-content="
                                    <div class='d-grid gap-2'>
                                        <button class='btn btn-sm btn-primary' onclick='showFacultyBio({{ teacher.id }})'>ğŸ“– æŸ¥çœ‹ç®€ä»‹</button>
                                        <a href='{% url 'user_app:public_profile' teacher.pk %}' class='btn btn-sm btn-outline-secondary'>ğŸ  å‰å¾€ä¸»é¡µ</a>
                                    </div>
                                 ">
                                {% if teacher.avatar %}
                                    <img src="{{ teacher.avatar.url }}" style="width: 80px; height: 80px;" class="mb-1">
                                {% else %}
                                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center mx-auto" 
                                         style="width: 80px; height: 80px; font-size: 2rem; border: 3px solid #fff; box-shadow: 0 0 0 2px #ccc;">
                                        {{ teacher.username.0|upper }}
                                    </div>
                                {% endif %}
                                <span class="avatar-badge">Lv.{{ teacher.level }}</span>
                            </div>
                            <h6 class="fw-bold mb-0 text-truncate px-2">{{ teacher.nickname|default:teacher.username }}</h6>
                            <small class="text-muted">å¯¼å¸ˆ</small>
                            <div id="faculty-bio-source-{{ teacher.id }}" class="d-none">{{ teacher.detailed_intro|default:"æš‚æ— è¯¦ç»†ä»‹ç»" }}</div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-muted">æš‚æ— å¯¼å¸ˆæ•°æ®ã€‚</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div id="faculty-bio-section" class="bio-section mt-3">
                <div class="card bg-light border-0 shadow-inner">
                    <div class="card-body p-4 position-relative">
                        <button type="button" class="btn-close position-absolute top-0 end-0 m-3" onclick="closeFacultyBio()" aria-label="Close"></button>
                        <h4 class="fw-bold text-primary mb-3">å¯¼å¸ˆç®€ä»‹</h4>
                        <div id="faculty-bio-render" class="vditor-reset text-dark"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-5">
            <h3 class="fw-bold mb-4 border-start border-4 border-warning ps-3">åœ¨è¯»ç»„å‘˜</h3>
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <div class="row row-cols-2 row-cols-md-5 g-4 text-center">
                        {% for student in students %}
                        <div class="col position-relative">
                            <div class="avatar-wrapper mb-2 student-avatar-item" 
                                 id="student-avatar-{{ student.id }}"
                                 tabindex="0"
                                 role="button"
                                 data-bs-toggle="popover" 
                                 data-bs-trigger="click" 
                                 data-bs-container="body"
                                 data-bs-html="true"
                                 data-bs-placement="top"
                                 data-bs-title="{{ student.nickname|default:student.username }}"
                                 data-bs-content="
                                    <div class='d-grid gap-2'>
                                        <button class='btn btn-sm btn-primary' onclick='showStudentBio({{ student.id }})'>ğŸ“– æŸ¥çœ‹ç®€ä»‹</button>
                                        <a href='{% url 'user_app:public_profile' student.pk %}' class='btn btn-sm btn-outline-secondary'>ğŸ  å‰å¾€ä¸»é¡µ</a>
                                    </div>
                                 ">
                                {% if student.avatar %}
                                    <img src="{{ student.avatar.url }}" style="width: 80px; height: 80px;" class="mb-1">
                                {% else %}
                                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center mx-auto" 
                                         style="width: 80px; height: 80px; font-size: 2rem; border: 3px solid #fff; box-shadow: 0 0 0 2px #ccc;">
                                        {{ student.username.0|upper }}
                                    </div>
                                {% endif %}
                                <span class="avatar-badge">Lv.{{ student.level }}</span>
                            </div>
                            
                            <h6 class="fw-bold mb-0 text-truncate px-2">{{ student.nickname|default:student.username }}</h6>
                            {% if student.student_id %}
                                <small class="text-muted d-block" style="font-size: 0.7rem;">åœ¨è¯»æˆå‘˜</small>
                            {% endif %}

                            <div id="student-bio-source-{{ student.id }}" class="d-none">
                                {{ student.detailed_intro|default:"è¯¥æˆå‘˜æš‚æ— è¯¦ç»†ä»‹ç»ã€‚" }}
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-muted py-4">æš‚æ— åœ¨è¯»ç»„æˆå‘˜ã€‚</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div id="student-bio-section" class="bio-section mt-3">
                <div class="card bg-light border-0 shadow-inner">
                    <div class="card-body p-4 position-relative">
                        <button type="button" class="btn-close position-absolute top-0 end-0 m-3" onclick="closeStudentBio()" aria-label="Close"></button>
                        <h4 class="fw-bold text-warning mb-3">æˆå‘˜ç®€ä»‹</h4>
                        <div id="student-bio-render" class="vditor-reset text-dark"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-5">
            <h3 class="fw-bold mb-4 border-start border-4 border-danger ps-3">ä»£è¡¨æ€§æˆæœ</h3>
            <div class="list-group shadow-sm">
                {% for pub in publications %}
                <a href="{{ pub.link|default:'#' }}" target="_blank" class="list-group-item list-group-item-action p-4 pub-card {% if pub.is_highlight %}bg-light{% endif %}">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div>
                            <h5 class="mb-1 fw-bold text-dark">
                                {% if pub.is_highlight %}ğŸ”¥ {% endif %}
                                {{ pub.title }}
                            </h5>
                            <p class="mb-1 text-secondary fst-italic">{{ pub.authors }}</p>
                            <small class="text-muted">
                                <span class="badge bg-secondary me-2">{{ pub.year }}</span>
                                <span class="fw-bold">{{ pub.venue }}</span>
                            </small>
                        </div>
                        {% if pub.link %}
                        <small class="text-primary fw-bold">View PDF â†—</small>
                        {% endif %}
                    </div>
                </a>
                {% empty %}
                <div class="text-center py-4 text-muted">æš‚æ— æˆæœå±•ç¤ºã€‚</div>
                {% endfor %}
            </div>
        </div>

    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/vditor/dist/index.css" />
<script src="https://unpkg.com/vditor/dist/method.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // 1. æ¸²æŸ“â€œç ”ç©¶æ–¹å‘â€ (ä¿æŒä¸å˜)
        {% for topic in topics %}
            (function(){
                const topicSourceDiv = document.getElementById('topic-source-{{ topic.id }}');
                const topicRenderDiv = document.getElementById('topic-render-{{ topic.id }}');
                if (topicSourceDiv && topicRenderDiv) {
                    Vditor.preview(topicRenderDiv, topicSourceDiv.textContent.trim(), { mode: 'light', anchor: 0 });
                }
            })();
        {% endfor %}

        // 2. åˆå§‹åŒ– Popover
        const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
        const popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl, { trigger: 'click', html: true, sanitize: false })
        });

        // 3. ç‚¹å‡»ç©ºç™½å¤„å…³é—­ Popover
        document.body.addEventListener('click', function (e) {
            if (!e.target.closest('[data-bs-toggle="popover"]') && !e.target.closest('.popover')) {
                popoverList.forEach(p => p.hide());
            } else if (e.target.closest('[data-bs-toggle="popover"]')) {
                const currentTrigger = e.target.closest('[data-bs-toggle="popover"]');
                popoverList.forEach(p => { if (p._element !== currentTrigger) p.hide(); });
            }
        });

        // === å¯¼å¸ˆç®€ä»‹é€»è¾‘ ===
        window.showFacultyBio = function(userId) {
            popoverList.forEach(p => p.hide()); // å…³é—­æ°”æ³¡
            closeStudentBio(); // å…³é—­å­¦ç”Ÿçš„ç®€ä»‹æ¡†ï¼ˆäº’æ–¥ï¼‰
            
            const section = document.getElementById('faculty-bio-section');
            const renderDiv = document.getElementById('faculty-bio-render');
            const sourceDiv = document.getElementById('faculty-bio-source-' + userId);
            
            // åˆ‡æ¢å¤´åƒé«˜äº®
            document.querySelectorAll('.faculty-avatar-item img').forEach(el => el.classList.remove('active-indicator'));
            const activeImg = document.querySelector('#faculty-avatar-' + userId + ' img');
            if(activeImg) activeImg.classList.add('active-indicator');

            if (sourceDiv) {
                Vditor.preview(renderDiv, sourceDiv.textContent.trim(), { mode: 'light', anchor: 1 });
                section.style.display = 'block';
                section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        };

        window.closeFacultyBio = function() {
            document.getElementById('faculty-bio-section').style.display = 'none';
            document.querySelectorAll('.faculty-avatar-item img').forEach(el => el.classList.remove('active-indicator'));
        };

        // === ğŸ‘‡ å­¦ç”Ÿç®€ä»‹é€»è¾‘ (æ–°å¢) ===
        window.showStudentBio = function(userId) {
            popoverList.forEach(p => p.hide()); // å…³é—­æ°”æ³¡
            closeFacultyBio(); // å…³é—­å¯¼å¸ˆçš„ç®€ä»‹æ¡†ï¼ˆäº’æ–¥ï¼‰

            const section = document.getElementById('student-bio-section');
            const renderDiv = document.getElementById('student-bio-render');
            const sourceDiv = document.getElementById('student-bio-source-' + userId);
            
            // åˆ‡æ¢å¤´åƒé«˜äº®
            document.querySelectorAll('.student-avatar-item img').forEach(el => el.classList.remove('active-indicator'));
            const activeImg = document.querySelector('#student-avatar-' + userId + ' img');
            if(activeImg) activeImg.classList.add('active-indicator');

            if (sourceDiv) {
                Vditor.preview(renderDiv, sourceDiv.textContent.trim(), { mode: 'light', anchor: 1 });
                section.style.display = 'block';
                section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        };

        window.closeStudentBio = function() {
            document.getElementById('student-bio-section').style.display = 'none';
            document.querySelectorAll('.student-avatar-item img').forEach(el => el.classList.remove('active-indicator'));
        };
    });
</script>
{% endblock %}