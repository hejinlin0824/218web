{% load community_extras %}
{% load static %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Web 218 å®éªŒå®¤{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    
    <style>
        /* === å…¨å±€åŸºç¡€æ ·å¼ === */
        body {
            padding-top: 80px; /* ä¸ºå›ºå®šå¯¼èˆªæ ç•™å‡ºç©ºé—´ */
            background-color: #f8f9fa; /* æµ…ç°èƒŒæ™¯ï¼Œçªæ˜¾å¡ç‰‡ç™½åº• */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* === ğŸ”® ç£¨ç ‚ç»ç’ƒå¯¼èˆªæ  === */
        .navbar-glass {
            background-color: rgba(255, 255, 255, 0.85) !important; /* åŠé€æ˜ç™½ */
            backdrop-filter: blur(12px); /* ç£¨ç ‚æ¨¡ç³Šæ•ˆæœ */
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05); /* ææ·¡çš„åˆ†å‰²çº¿ */
            box-shadow: 0 4px 30px rgba(0,0,0,0.03); /* æŸ”å’Œé˜´å½± */
            height: 70px;
            transition: all 0.3s ease;
        }

        /* å¯¼èˆªé“¾æ¥æ ·å¼ */
        .nav-link-custom {
            color: #555 !important;
            font-weight: 600;
            padding: 8px 18px !important;
            border-radius: 50rem; /* èƒ¶å›Šåœ†è§’ */
            transition: all 0.2s ease-in-out;
            font-size: 0.95rem;
            margin: 0 2px;
        }

        /* æ‚¬åœå’Œæ¿€æ´»çŠ¶æ€ */
        .nav-link-custom:hover, 
        .nav-link-custom.active {
            color: #0d6efd !important; /* äº®è“æ–‡å­— */
            background-color: rgba(13, 110, 253, 0.08); /* æµ…è“èƒŒæ™¯ */
        }

        /* Logo æ ·å¼ */
        .navbar-brand {
            font-weight: 800;
            font-size: 1.3rem;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #0d6efd, #0dcaf0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; /* æ¸å˜æ–‡å­— */
        }

        /* === å·¥å…·ç±» === */
        .hover-shadow:hover { box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; transition: .3s; }
        .vditor-reset { max-width: 100vw !important; overflow-x: hidden; }
        img, video, iframe { max-width: 100%; height: auto; }
        
        /* æ¸¸æˆåŒ– UI ç»„ä»¶ (å…¨å±€å¤ç”¨) */
        .avatar-wrapper { position: relative; display: inline-block; vertical-align: middle; }
        .avatar-wrapper img { border: 3px solid #fff; box-shadow: 0 0 0 2px #e0e0e0; border-radius: 50%; object-fit: cover; box-sizing: content-box; }
        .avatar-badge { position: absolute; bottom: -2px; right: -5px; background: linear-gradient(45deg, #FFD700, #FFA500); color: #fff; font-size: 0.6rem; font-weight: bold; padding: 1px 6px; border-radius: 10px; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10; white-space: nowrap; font-family: 'Courier New', Courier, monospace; }
        
        /* è¿›åº¦æ¡ */
        .pixel-progress-container { width: 100%; height: 12px; background-color: #eee; border: 2px solid #ccc; position: relative; border-radius: 0; }
        .pixel-progress-bar { height: 100%; background-color: #4CAF50; transition: width 0.3s steps(10); position: relative; }
        .pixel-progress-bar::after { content: ""; position: absolute; top: 2px; left: 0; right: 0; height: 2px; background-color: rgba(255,255,255,0.4); }

        /* é“ƒé“›æ‘‡æ™ƒåŠ¨ç”» */
        .bell-shake {
            animation: swing 2s infinite;
            display: inline-block;
        }
        @keyframes swing {
            20% { transform: rotate(15deg); }
            40% { transform: rotate(-10deg); }
            60% { transform: rotate(5deg); }
            80% { transform: rotate(-5deg); }
            100% { transform: rotate(0deg); }
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light fixed-top navbar-glass">
    <div class="container-xxl"> <a class="navbar-brand d-flex align-items-center" href="{% url 'home' %}">
            <span class="fs-4 me-2">ğŸ”¬</span> Web 218 Lab
        </a>
        
        <button class="navbar-toggler border-0 shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto ms-lg-4 mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link nav-link-custom" href="{% url 'home' %}">å¤§å…</a></li>
                <li class="nav-item"><a class="nav-link nav-link-custom" href="{% url 'core:intro' %}">å®éªŒå®¤æ¦‚è§ˆ</a></li>
                <li class="nav-item"><a class="nav-link nav-link-custom" href="{% url 'vocabulary:index' %}">èƒŒå•è¯</a></li>
                <li class="nav-item"><a class="nav-link nav-link-custom" href="{% url 'npy_editor:home' %}">NPY æ•°æ®å·¥åŠ</a></li>
                <li class="nav-item"><a class="nav-link nav-link-custom" href="{% url 'innovation_agent:project_list' %}">åˆ›æ–°ç‚¹å·¥å…·</a></li>
                <li class="nav-item dropdown">
                    <a class="nav-link nav-link-custom dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        æ›´å¤š
                    </a>
                    <ul class="dropdown-menu border-0 shadow-sm rounded-3 mt-2">
                        <li><a class="dropdown-item py-2" href="{% url 'core:intro' %}">ğŸ« å®éªŒå®¤æ¦‚è§ˆ</a></li>
                        <li><a class="dropdown-item py-2" href="{% url 'community:post_list' %}">ğŸ« ç¤¾åŒº</a></li>
                        <li><a class="dropdown-item py-2" href="{% url 'Github_trend:index' %}">ğŸ« Githubè¶‹åŠ¿</a></li>
                        <li><a class="dropdown-item py-2" href="{% url 'tasks:my_tasks' %}">ğŸ« ä»»åŠ¡ä¸­å¿ƒ</a></li>
                    </ul>
                </li>
            </ul>

            <ul class="navbar-nav align-items-center">
                {% if user.is_authenticated %}
                    
                    <li class="nav-item me-3">
                        <a class="nav-link position-relative text-dark" href="{% url 'notifications:list' %}">
                            <i class="bi bi-bell-fill fs-5 {% if unread_notification_count > 0 %}bell-shake text-warning{% else %}text-secondary{% endif %}"></i>
                            
                            <span id="notification-badge" 
                                  class="position-absolute top-0 start-100 translate-middle badge rounded-circle bg-danger border border-white" 
                                  style="width:18px; height:18px; padding:0; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; 
                                  {% if unread_notification_count == 0 %}display: none !important;{% endif %}">
                                  {{ unread_notification_count }}
                            </span>
                        </a>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link d-flex align-items-center gap-2 p-0" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            {% if user.avatar %}
                                <img src="{{ user.avatar.url }}" class="rounded-circle border border-2 border-white shadow-sm" style="width: 38px; height: 38px; object-fit: cover;">
                            {% else %}
                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center shadow-sm border border-2 border-white" style="width: 38px; height: 38px; font-weight: bold;">
                                    {{ user.username.0|upper }}
                                </div>
                            {% endif %}
                            <span class="d-none d-lg-block fw-bold text-dark small">{{ user.nickname|default:user.username }}</span>
                            <i class="bi bi-chevron-down text-muted" style="font-size: 0.8rem;"></i>
                        </a>

                        <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg rounded-4 mt-3 p-2" style="min-width: 200px;">
                            <li class="px-3 py-2 border-bottom mb-2">
                                <div class="fw-bold text-dark">{{ user.nickname|default:user.username }}</div>
                                <div class="small text-muted">{{ user.email }}</div>
                                <div class="mt-2 d-flex justify-content-between align-items-center small">
                                    <span class="badge bg-light text-dark border">Lv.{{ user.level }}</span>
                                    <span class="text-warning">ğŸª™ {{ user.coins }}</span>
                                </div>
                            </li>
                            <li><a class="dropdown-item rounded-2 py-2" href="{% url 'user_app:profile' %}"><i class="bi bi-person-gear me-2"></i> ä¸ªäººä¸­å¿ƒ</a></li>
                            <li><a class="dropdown-item rounded-2 py-2" href="{% url 'direct_messages:inbox' %}"><i class="bi bi-chat-text me-2"></i> æˆ‘çš„ç§ä¿¡</a></li>
                            <li><a class="dropdown-item rounded-2 py-2" href="{% url 'tasks:my_tasks' %}"><i class="bi bi-list-check me-2"></i> æˆ‘çš„ä»»åŠ¡</a></li>
                            <li><hr class="dropdown-divider my-2"></li>
                            <li>
                                <form action="{% url 'user_app:logout' %}" method="post">
                                    {% csrf_token %}
                                    <button type="submit" class="dropdown-item rounded-2 py-2 text-danger w-100 text-start">
                                        <i class="bi bi-box-arrow-right me-2"></i> é€€å‡ºç™»å½•
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </li>
                {% else %}
                    <li class="nav-item"><a class="nav-link nav-link-custom me-2" href="{% url 'user_app:login' %}">ç™»å½•</a></li>
                    <li class="nav-item">
                        <a class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" href="{% url 'user_app:register' %}">æ³¨å†Œ</a>
                    </li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>

<div class="container-xxl mt-4"> {% block messages %}
        {% if messages %}
            <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1060; margin-top: 80px;">
                {% for message in messages %}
                <div class="toast align-items-center text-white bg-{{ message.tags|default:'primary' }} border-0 fade show shadow" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body fs-6">
                            {{ message }}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <script>
                // 3ç§’åè‡ªåŠ¨æ¶ˆå¤± Toast
                setTimeout(() => {
                    document.querySelectorAll('.toast').forEach(el => el.classList.remove('show'));
                }, 3000);
            </script>
        {% endif %}
    {% endblock %}

    <div class="row g-4">
        
        {% block sidebar %}
        <div class="col-md-3 d-none d-md-block"> {% include 'includes/side_nav.html' %}
        </div>
        {% endblock %}

        {% block content_container %}
        <div class="col-md-9">
            {% block content %}{% endblock %}
        </div>
        {% endblock %}
        
    </div>
</div>

<footer class="text-center py-5 text-muted mt-5 border-top bg-white">
    <div class="container">
        <p class="mb-1 fw-bold text-dark">ğŸ”¬ DSSG Lab Center</p>
        <p class="small mb-3">Exploring the boundaries of Data Science & Intelligence.</p>
        <div class="small">
            <a href="#" class="text-decoration-none text-secondary me-3">å…³äºæˆ‘ä»¬</a>
            <a href="#" class="text-decoration-none text-secondary me-3">ä½¿ç”¨åè®®</a>
            <a href="#" class="text-decoration-none text-secondary">éšç§æ”¿ç­–</a>
        </div>
        <p class="small mt-3 opacity-50">&copy; 2026 DSSG Laboratory. All rights reserved.</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // æ¶ˆæ¯è½®è¯¢é€»è¾‘
        {% if user.is_authenticated %}
        
        const badgeElement = document.getElementById('notification-badge');
        const bellIcon = document.querySelector('.bi-bell-fill');
        
        function checkNotifications() {
            fetch("{% url 'notifications:api_unread_count' %}")
                .then(response => response.json())
                .then(data => {
                    const newCount = data.count;
                    if (badgeElement) {
                        badgeElement.innerText = newCount;
                        if (newCount > 0) {
                            badgeElement.style.display = 'flex';
                            bellIcon.classList.add('bell-shake', 'text-warning');
                            bellIcon.classList.remove('text-secondary');
                        } else {
                            badgeElement.style.display = 'none';
                            bellIcon.classList.remove('bell-shake', 'text-warning');
                            bellIcon.classList.add('text-secondary');
                        }
                    }
                })
                .catch(error => console.error('è½®è¯¢å‡ºé”™:', error));
        }

        // æ¯ 3ç§’ æ£€æŸ¥ä¸€æ¬¡
        setInterval(checkNotifications, 3000);
        
        {% endif %}
    });
</script>
</body>
</html>