{% extends 'base.html' %}
{% load community_extras %}

{% block title %}DSSG å®éªŒå®¤é—¨æˆ·{% endblock %}

{% block content %}
<style>
    /* === é¦–é¡µä¸“ç”¨æ ·å¼ === */
    
    /* 1. Hero Banner */
    .hero-banner {
        background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%);
        color: white;
        border-radius: 1rem;
        position: relative;
        overflow: hidden;
    }
    .hero-bg-circle {
        position: absolute;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
    }
    
    /* 2. æ•°æ®ç»Ÿè®¡å¡ç‰‡ */
    .stat-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: none;
        border-radius: 1rem;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,0.1) !important;
    }
    .stat-icon-box {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        font-size: 1.5rem;
    }

    /* 3. åˆ—è¡¨é¡¹ä¼˜åŒ– */
    .dashboard-list-item {
        transition: background-color 0.2s;
        border-left: 3px solid transparent;
    }
    .dashboard-list-item:hover {
        background-color: #f8f9fa;
        border-left-color: #0d6efd;
    }

    /* å¤´åƒå¾®è°ƒ */
    .mini-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid #dee2e6;
    }

    /* æ»šåŠ¨æ¡éšè— */
    .tab-scroll-box {
        height: 400px;
        overflow-y: auto;
        scrollbar-width: thin;
    }
    .tab-scroll-box::-webkit-scrollbar { width: 4px; }
    .tab-scroll-box::-webkit-scrollbar-thumb { background: #e9ecef; border-radius: 4px; }

    /* ğŸ”¥ğŸ”¥ğŸ”¥ 4. æ°´æµ Tab åŠ¨ç”»æ ¸å¿ƒæ ·å¼ ğŸ”¥ğŸ”¥ğŸ”¥ */
    .nav-pills-custom {
        position: relative;
        background-color: #f8f9fa;
        border-radius: 50rem;
        padding: 5px;
        display: inline-flex;
        border: 1px solid #e9ecef;
    }

    .nav-pills-custom .nav-link {
        color: #6c757d;
        background: transparent !important; /* ç¦ç”¨é»˜è®¤èƒŒæ™¯ */
        border-radius: 50rem;
        position: relative;
        z-index: 2; /* æ–‡å­—åœ¨æ»‘å—ä¹‹ä¸Š */
        transition: color 0.3s ease;
        padding: 8px 20px;
        font-weight: 500;
        border: none;
    }

    .nav-pills-custom .nav-link.active {
        color: #0d6efd;
        font-weight: bold;
    }

    /* æ»‘å— (Glider) */
    .nav-glider {
        position: absolute;
        top: 5px;
        left: 5px;
        height: calc(100% - 10px);
        background-color: white;
        border-radius: 50rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        z-index: 1;
        transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1); /* Qå¼¹æ•ˆæœçš„å…³é”® */
    }

    /* ğŸ”¥ğŸ”¥ğŸ”¥ 5. å†…å®¹æº¢å‡ºä¿®å¤ ğŸ”¥ğŸ”¥ğŸ”¥ */
    .content-truncate-wrapper {
        flex-grow: 1;
        min-width: 0; /* å…³é”®ï¼šå…è®¸ flex å­é¡¹æ”¶ç¼© */
    }
</style>

<div class="hero-banner p-4 p-md-5 mb-4 shadow-sm">
    <div class="hero-bg-circle" style="width: 200px; height: 200px; top: -50px; right: -50px;"></div>
    <div class="hero-bg-circle" style="width: 100px; height: 100px; bottom: -20px; left: 20%;"></div>

    <div class="row align-items-center position-relative" style="z-index: 1;">
        <div class="col-md-8">
            <h1 class="fw-bold display-6 mb-2">
                {% if user.is_authenticated %}
                    ä½ å¥½å•Šï¼Œ{{ user.nickname|default:user.username }}ï¼ğŸ‘‹
                {% else %}
                    æ¬¢è¿æ¥åˆ° DSSG å®éªŒå®¤ ğŸ”¬
                {% endif %}
            </h1>
            <p class="lead mb-0 opacity-75 fs-6">
                æ¢ç´¢æ•°æ®ç§‘å­¦ä¸æ™ºèƒ½è®¡ç®—çš„è¾¹ç•Œï¼Œè¿æ¥æ¯ä¸€ä½ç§‘ç ”ä¼™ä¼´ã€‚
            </p>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            {% if not user.is_authenticated %}
                <a href="{% url 'user_app:login' %}" class="btn btn-light text-primary fw-bold px-4 rounded-pill shadow-sm">ç«‹å³ç™»å½•</a>
            {% else %}
                 <div class="d-inline-flex align-items-center bg-white bg-opacity-25 rounded-pill px-3 py-2 border border-white border-opacity-25 backdrop-blur">
                    <span class="me-2">å½“å‰ç­‰çº§</span>
                    <span class="fw-bold text-warning">Lv.{{ user.level }}</span>
                 </div>
            {% endif %}
        </div>
    </div>
</div>

{% if user.is_authenticated and user.status == 'faculty' %}
<div class="alert alert-danger border-0 shadow-sm d-flex align-items-center justify-content-between mb-4 rounded-4" role="alert" style="background-color: #fff5f5; border-left: 5px solid #dc3545 !important;">
    <div class="d-flex align-items-center">
        <div class="bg-danger text-white rounded-circle p-2 me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
            <i class="bi bi-shield-lock-fill"></i>
        </div>
        <div>
            <h6 class="fw-bold text-danger mb-0">å¯¼å¸ˆæ§åˆ¶å°</h6>
            <small class="text-danger opacity-75">æ‚¨æ‹¥æœ‰ç®¡ç†å®éªŒå®¤ç­çº§å’Œå‘å¸ƒæŒ‡ä»¤çš„æƒé™</small>
        </div>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'core:class_management' %}" class="btn btn-sm btn-danger rounded-pill px-3">ğŸ“ ç­çº§ç®¡ç†</a>
        <a href="{% url 'tasks:task_create' %}" class="btn btn-sm btn-outline-danger rounded-pill px-3">ğŸš€ å‘å¸ƒæŒ‡ä»¤</a>
    </div>
</div>
{% endif %}

<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card stat-card shadow-sm h-100 bg-white">
            <div class="card-body d-flex align-items-center p-3">
                <div class="stat-icon-box bg-primary bg-opacity-10 text-primary me-3">
                    <i class="bi bi-people-fill"></i>
                </div>
                <div>
                    <h3 class="fw-bold mb-0">{{ stats.users }}</h3>
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">å®éªŒå®¤æˆå‘˜</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card shadow-sm h-100 bg-white">
            <div class="card-body d-flex align-items-center p-3">
                <div class="stat-icon-box bg-success bg-opacity-10 text-success me-3">
                    <i class="bi bi-file-earmark-richtext-fill"></i>
                </div>
                <div>
                    <h3 class="fw-bold mb-0">{{ stats.posts }}</h3>
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">æ²‰æ·€çŸ¥è¯†åº“</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card shadow-sm h-100 bg-white">
            <div class="card-body d-flex align-items-center p-3">
                <div class="stat-icon-box bg-warning bg-opacity-10 text-warning me-3 position-relative">
                    <i class="bi bi-activity"></i>
                    <span class="position-absolute top-0 start-100 translate-middle p-1 bg-success border border-light rounded-circle animate__animated animate__flash animate__infinite animate__slower"></span>
                </div>
                <div>
                    <h3 class="fw-bold mb-0">{{ stats.online }}</h3>
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">è¿‘æœŸæ´»è·ƒ</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card shadow-sm border-0 rounded-4 h-100">
            <div class="card-header bg-white border-bottom-0 pt-4 px-4 pb-0">
                
                <ul class="nav nav-pills-custom" id="homeTabs" role="tablist">
                    <div class="nav-glider"></div> <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks-panel" type="button" onclick="moveGlider(this)">
                            ğŸ“… å¾…åŠæ—¥ç¨‹
                            {% if user.is_authenticated and my_todos %}
                                <span class="badge bg-danger rounded-circle ms-1" style="font-size: 0.6rem; padding: 4px 6px;">{{ my_todos.count }}</span>
                            {% endif %}
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="community-tab" data-bs-toggle="tab" data-bs-target="#community-panel" type="button" onclick="moveGlider(this)">
                            ğŸ’¬ æœ€æ–°è®¨è®º
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="news-tab" data-bs-toggle="tab" data-bs-target="#news-panel" type="button" onclick="moveGlider(this)">
                            ğŸ“¢ å…¬å‘ŠåŠ¨æ€
                        </button>
                    </li>
                </ul>

            </div>
            
            <div class="card-body p-0 mt-3">
                <div class="tab-content" id="homeTabsContent">
                    
                    <div class="tab-pane fade show active" id="tasks-panel" role="tabpanel">
                        <div class="tab-scroll-box">
                            <div class="list-group list-group-flush">
                                {% if user.is_authenticated %}
                                    {% for item in my_todos %}
                                        <a href="{% url 'tasks:task_detail' item.task.pk %}" class="list-group-item list-group-item-action dashboard-list-item py-3 px-4 border-bottom-0 border-top">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="d-flex align-items-center overflow-hidden content-truncate-wrapper">
                                                    <div class="me-3 flex-shrink-0">
                                                        {% if item.task.task_type == 'faculty' %}
                                                            <div class="bg-danger bg-opacity-10 text-danger rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                                <i class="bi bi-exclamation-lg"></i>
                                                            </div>
                                                        {% else %}
                                                            <div class="bg-warning bg-opacity-10 text-warning rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                                <i class="bi bi-coin"></i>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <div class="min-width-0 content-truncate-wrapper">
                                                        <h6 class="mb-1 fw-bold text-truncate text-dark d-block w-100">{{ item.task.title }}</h6>
                                                        <div class="small text-muted d-flex align-items-center">
                                                            <span class="me-2">{{ item.task.creator.nickname }}</span>
                                                            {% if item.task.is_overdue %}
                                                                <span class="badge bg-secondary">å·²æˆªæ­¢</span>
                                                            {% else %}
                                                                <span class="text-danger fw-bold countdown-timer" data-deadline="{{ item.task.deadline|date:'c' }}">è®¡ç®—ä¸­...</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="ms-3 text-end flex-shrink-0">
                                                    {% if item.task.task_type == 'faculty' %}
                                                        <span class="badge bg-danger rounded-pill">å¿…ä¿®</span>
                                                    {% else %}
                                                        <span class="fw-bold text-warning">ğŸª™ {{ item.task.bounty }}</span>
                                                    {% endif %}
                                                    <div class="small text-muted mt-1">è¿›è¡Œä¸­</div>
                                                </div>
                                            </div>
                                        </a>
                                    {% empty %}
                                        <div class="text-center py-5">
                                            <div class="display-1 mb-3 opacity-25">â˜•</div>
                                            <h5 class="text-muted">æš‚æ— å¾…åŠä»»åŠ¡</h5>
                                            <p class="text-secondary small">ä½ å¯ä»¥å»ä»»åŠ¡ä¸­å¿ƒçœ‹çœ‹æœ‰æ²¡æœ‰æ„Ÿå…´è¶£çš„æ‚¬èµ</p>
                                            <a href="{% url 'tasks:my_tasks' %}" class="btn btn-sm btn-outline-primary rounded-pill px-4 mt-2">å‰å¾€ä»»åŠ¡ä¸­å¿ƒ</a>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-center py-5">
                                        <div class="display-1 mb-3 opacity-25">ğŸ”’</div>
                                        <h5 class="text-muted">è¯·å…ˆç™»å½•</h5>
                                        <p class="text-secondary small">ç™»å½•åå³å¯æŸ¥çœ‹æ‚¨çš„ä¸“å±ä»»åŠ¡æ—¥ç¨‹</p>
                                        <a href="{% url 'user_app:login' %}" class="btn btn-primary rounded-pill px-4 mt-2">ç«‹å³ç™»å½•</a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="community-panel" role="tabpanel">
                        <div class="tab-scroll-box">
                            <div class="list-group list-group-flush">
                                {% for post in recent_posts %}
                                    <a href="{% url 'community:post_detail' post.pk %}" class="list-group-item list-group-item-action dashboard-list-item py-3 px-4 border-bottom-0 border-top">
                                        <div class="d-flex align-items-start">
                                            <div class="me-3 flex-shrink-0 pt-1">
                                                {% if post.author.avatar %}
                                                    <img src="{{ post.author.avatar.url }}" class="mini-avatar">
                                                {% else %}
                                                    <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center" style="width:24px; height:24px; font-size: 0.6rem;">
                                                        {{ post.author.username.0|upper }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="content-truncate-wrapper">
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <h6 class="mb-0 fw-bold text-truncate text-dark d-block w-100">{{ post.title }}</h6>
                                                    {% if post.is_first_like_rewarded %}
                                                        <span class="badge bg-light text-warning border border-warning flex-shrink-0 ms-2" style="font-size: 0.6rem;">çƒ­é—¨</span>
                                                    {% endif %}
                                                </div>
                                                <p class="text-muted small text-truncate mb-1 d-block w-100">{{ post.content|md_to_text }}</p>
                                                <div class="d-flex text-muted small align-items-center" style="font-size: 0.75rem;">
                                                    <span class="me-3 fw-bold">{{ post.author.nickname|default:post.author.username }}</span>
                                                    <span class="me-3">{{ post.created_at|smart_time }}</span>
                                                    <span><i class="bi bi-chat-dots"></i> {{ post.comment_count }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                {% empty %}
                                    <div class="text-center py-5 text-muted">æš‚æ— ç¤¾åŒºåŠ¨æ€</div>
                                {% endfor %}
                            </div>
                            <div class="text-center py-3 bg-light border-top">
                                <a href="{% url 'community:post_list' %}" class="text-decoration-none text-primary small fw-bold">æŸ¥çœ‹æ›´å¤šè®¨è®º &raquo;</a>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="news-panel" role="tabpanel">
                        <div class="tab-scroll-box">
                            <div class="list-group list-group-flush">
                                {% for news in announcements %}
                                    <div class="list-group-item dashboard-list-item py-3 px-4 border-bottom-0 border-top">
                                        <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                                            <div class="d-flex align-items-center content-truncate-wrapper">
                                                {% if news.is_top %}
                                                    <span class="badge bg-danger me-2 flex-shrink-0">ç½®é¡¶</span>
                                                {% else %}
                                                    <span class="badge bg-light text-secondary border me-2 flex-shrink-0">å…¬å‘Š</span>
                                                {% endif %}
                                                <h6 class="mb-0 fw-bold text-dark text-truncate d-block w-100">{{ news.title }}</h6>
                                            </div>
                                            <small class="text-muted ms-2 flex-shrink-0">{{ news.created_at|date:"m-d" }}</small>
                                        </div>
                                        <p class="mb-0 small text-secondary ps-5 text-truncate d-block w-100">{{ news.content|striptags }}</p>
                                    </div>
                                {% empty %}
                                    <div class="text-center py-5 text-muted">æš‚æ— å…¬å‘Š</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        
        <div class="card shadow-sm border-0 rounded-4 mb-4" style="background: linear-gradient(135deg, #6610f2 0%, #6f42c1 100%); color: white;">
            <div class="card-body p-4 position-relative overflow-hidden">
                <div class="position-absolute" style="right: -20px; bottom: -20px; font-size: 8rem; opacity: 0.1;">ğŸ“ˆ</div>
                <h5 class="fw-bold mb-2">NPY Editor V23</h5>
                <p class="small opacity-75 mb-3">ç§‘ç ”æ•°æ®å¯è§†åŒ–ã€èåˆã€ä¿®æ­£ä¸€ç«™å¼å·¥å…·ã€‚</p>
                <a href="{% url 'npy_editor:home' %}" class="btn btn-light text-purple fw-bold rounded-pill px-4 shadow-sm" style="color: #6610f2;">
                    ç«‹å³å¯åŠ¨ ğŸš€
                </a>
            </div>
        </div>

        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-header bg-white fw-bold py-3 border-bottom-0">
                ğŸ”— å¸¸ç”¨èµ„æº
            </div>
            <div class="card-body p-3">
                <div class="row g-2">
                    <div class="col-6">
                        <a href="https://github.com/" target="_blank" class="btn btn-outline-dark w-100 d-flex align-items-center justify-content-center gap-2 py-2">
                            <i class="bi bi-github"></i> GitHub
                        </a>
                    </div>
                    <div class="col-6">
                        <a href="https://arxiv.org/" target="_blank" class="btn btn-outline-danger w-100 d-flex align-items-center justify-content-center gap-2 py-2">
                            <i class="bi bi-file-earmark-pdf"></i> Arxiv
                        </a>
                    </div>
                    <div class="col-6">
                        <a href="https://scholar.google.com/" target="_blank" class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center gap-2 py-2">
                            <i class="bi bi-google"></i> Scholar
                        </a>
                    </div>
                    <div class="col-6">
                        <a href="https://www.overleaf.com/" target="_blank" class="btn btn-outline-success w-100 d-flex align-items-center justify-content-center gap-2 py-2">
                            <i class="bi bi-tex"></i> Overleaf
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4 text-center text-muted small">
            <p class="mb-1">&copy; 2026 DSSG Lab Center</p>
            <p class="opacity-50">Designed for Research & Collaboration</p>
        </div>

    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    // === æ°´æµ Tab åŠ¨ç”»æ ¸å¿ƒé€»è¾‘ ===
    const glider = document.querySelector('.nav-glider');
    const tabs = document.querySelectorAll('.nav-link');
    
    window.moveGlider = function(el) {
        // è®¡ç®—ä½ç½®å’Œå®½åº¦
        const width = el.offsetWidth;
        const left = el.offsetLeft;
        
        // åº”ç”¨åˆ°æ»‘å—
        glider.style.width = width + 'px';
        glider.style.left = left + 'px';
    };

    // åˆå§‹åŒ–ï¼šæ‰¾åˆ°å½“å‰ active çš„ tab å¹¶ç§»åŠ¨æ»‘å—
    const activeTab = document.querySelector('.nav-link.active');
    if (activeTab) {
        // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿ DOM æ¸²æŸ“å®Œæ¯•ï¼Œä½ç½®è®¡ç®—å‡†ç¡®
        setTimeout(() => moveGlider(activeTab), 50);
    }
    
    // === å€’è®¡æ—¶é€»è¾‘ ===
    const timers = document.querySelectorAll('.countdown-timer');
    function updateTimers() {
        timers.forEach(timer => {
            const deadline = new Date(timer.dataset.deadline).getTime();
            const now = new Date().getTime();
            const distance = deadline - now;
            if (distance < 0) {
                timer.innerHTML = 'å·²æˆªæ­¢';
                timer.className = 'badge bg-secondary';
                return;
            }
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            let timeStr = '';
            if (days > 0) timeStr += `${days}å¤©`;
            timeStr += `${hours}æ—¶${minutes}åˆ†`;
            timer.innerHTML = 'â³ ' + timeStr;
        });
    }
    if (timers.length > 0) {
        setInterval(updateTimers, 60000); 
        updateTimers();
    }
});
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
{% endblock %}