{% extends 'base.html' %}
{% load community_extras %}

{% block title %}æ¶ˆæ¯ä¸­å¿ƒ{% endblock %}

{% block content %}
<style>
    /* === æ¶ˆæ¯ä¸­å¿ƒä¸“ç”¨æ ·å¼ === */
    
    /* 1. å¤´åƒå¼ºåˆ¶ä¿®æ­£ */
    .notif-avatar {
        width: 48px;
        height: 48px;
        min-width: 48px; /* å¼ºåˆ¶æœ€å°å®½åº¦ */
        flex-shrink: 0;  /* ç¦æ­¢è¢« Flex å®¹å™¨æŒ¤å‹ */
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    /* 2. æ¶ˆæ¯å¡ç‰‡ */
    .notification-item {
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }
    .notification-item:hover {
        background-color: #f8f9fa;
        transform: translateX(3px);
    }
    
    /* æœªè¯»çŠ¶æ€ */
    .notification-item.unread {
        background-color: rgba(13, 110, 253, 0.04);
        border-left-color: #0d6efd;
    }
    /* æœªè¯»çº¢ç‚¹ */
    .unread-dot {
        width: 8px;
        height: 8px;
        background-color: #dc3545;
        border-radius: 50%;
        display: inline-block;
        margin-left: 5px;
    }

    /* 3. å†…å®¹æ–‡æœ¬ */
    .notif-text {
        font-size: 0.9rem;
        line-height: 1.5;
        color: #495057;
    }
    .notif-quote {
        border-left: 3px solid #dee2e6;
        padding-left: 8px;
        margin-top: 4px;
        color: #6c757d;
        font-size: 0.85rem;
        background-color: #f8f9fa;
        border-radius: 0 4px 4px 0;
    }

    /* 4. ç±»å‹å›¾æ ‡å®¹å™¨ */
    .type-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        position: absolute;
        bottom: -2px;
        right: -2px;
        box-shadow: 0 0 0 2px #fff;
    }
</style>

<div class="row justify-content-center">
    <div class="col-md-9">
        <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
            
            <div class="card-header bg-white py-3 px-4 border-bottom d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <h5 class="mb-0 fw-bold">ğŸ”” æ¶ˆæ¯ä¸­å¿ƒ</h5>
                    {% if unread_notification_count > 0 %}
                        <span class="badge bg-danger rounded-pill">{{ unread_notification_count }} æœªè¯»</span>
                    {% endif %}
                </div>
                
                <form method="post">
                    {% csrf_token %}
                    <button type="submit" name="mark_all_read" class="btn btn-sm btn-light text-primary fw-bold rounded-pill px-3 shadow-sm border">
                        <i class="bi bi-check2-all"></i> ä¸€é”®å·²è¯»
                    </button>
                </form>
            </div>

            <div class="list-group list-group-flush" id="notificationList">
                {% for notice in notifications %}
                <a href="{% url 'notifications:read_and_redirect' notice.pk %}" class="list-group-item list-group-item-action p-3 notification-item {% if not notice.is_read %}unread{% endif %}">
                    <div class="d-flex align-items-start">
                        
                        <div class="position-relative me-3">
                            {% if notice.actor.avatar %}
                                <img src="{{ notice.actor.avatar.url }}" class="notif-avatar">
                            {% else %}
                                <div class="notif-avatar bg-secondary text-white d-flex align-items-center justify-content-center fw-bold fs-5">
                                    {{ notice.actor.username.0|upper }}
                                </div>
                            {% endif %}

                            {% if notice.verb == 'like' %}
                                <div class="type-icon bg-danger text-white"><i class="bi bi-heart-fill"></i></div>
                            {% elif notice.verb == 'comment' or notice.verb == 'reply' %}
                                <div class="type-icon bg-primary text-white"><i class="bi bi-chat-dots-fill"></i></div>
                            {% elif 'task' in notice.verb %}
                                <div class="type-icon bg-warning text-dark"><i class="bi bi-trophy-fill"></i></div>
                            {% elif 'friend' in notice.verb %}
                                <div class="type-icon bg-success text-white"><i class="bi bi-person-check-fill"></i></div>
                            {% else %}
                                <div class="type-icon bg-secondary text-white"><i class="bi bi-bell-fill"></i></div>
                            {% endif %}
                        </div>

                        <div class="flex-grow-1 min-width-0">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="fw-bold text-dark">{{ notice.actor.nickname|default:notice.actor.username }}</span>
                                <div class="d-flex align-items-center">
                                    <small class="text-muted" style="font-size: 0.75rem;">{{ notice.created_at|smart_time }}</small>
                                    {% if not notice.is_read %}
                                        <span class="unread-dot" title="æœªè¯»"></span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="notif-text">
                                {% if notice.verb == 'like' %}
                                    <span class="text-secondary">èµäº†ä½ çš„å¸–å­</span>
                                
                                {% elif notice.verb == 'comment' %}
                                    <span class="text-secondary">è¯„è®ºäº†ä½ çš„å¸–å­ï¼š</span>
                                    <div class="notif-quote text-truncate">{{ notice.content }}</div>
                                
                                {% elif notice.verb == 'reply' %}
                                    <span class="text-secondary">å›å¤äº†ä½ çš„è¯„è®ºï¼š</span>
                                    <div class="notif-quote text-truncate">{{ notice.content }}</div>
                                
                                {% elif notice.verb == 'follow' %}
                                    <span class="text-primary fw-bold">å…³æ³¨äº†ä½ </span> ğŸ‰
                                
                                {% elif notice.verb == 'friend_request' %}
                                    <span class="text-dark fw-bold">ğŸ‘‹ è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹</span>
                                    <div class="mt-2">
                                        <span class="badge bg-primary rounded-pill">å»å¤„ç† &raquo;</span>
                                    </div>

                                {% elif notice.verb == 'friend_accept' %}
                                    <span class="text-success fw-bold">âœ… é€šè¿‡äº†ä½ çš„å¥½å‹è¯·æ±‚</span>
                                
                                {% elif notice.verb == 'friend_reject' %}
                                    <span class="text-secondary">ğŸš« æ‹’ç»äº†ä½ çš„å¥½å‹è¯·æ±‚</span>

                                {% elif notice.verb == 'task_invite' %}
                                    <span class="text-dark">é‚€è¯·ä½ å‚ä¸ä»»åŠ¡ï¼š</span>
                                    <span class="d-block fw-bold text-primary mt-1">ğŸ“œ {{ notice.content }}</span>

                                {% elif notice.verb == 'task_accept' %}
                                    <span class="text-success">æ¥å—äº†ä½ çš„ä»»åŠ¡ï¼š</span>
                                    <span class="fw-bold">{{ notice.content }}</span>

                                {% elif notice.verb == 'task_settle' %}
                                    <span class="text-warning fw-bold">ğŸ’° {{ notice.content }}</span>
                                    
                                {% elif notice.verb == 'system' %}
                                    <span class="badge bg-secondary me-1">ç³»ç»Ÿ</span> {{ notice.content }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </a>
                {% empty %}
                <div class="text-center py-5">
                    <div class="display-1 mb-3 opacity-25">ğŸ“­</div>
                    <h5 class="text-muted">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿ</h5>
                    <p class="text-secondary small">å½“æœ‰æ–°æ¶ˆæ¯æ—¶ï¼Œä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</p>
                </div>
                {% endfor %}
            </div>

            {% if has_more %}
            <div class="card-footer bg-white border-top p-3 text-center">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="current_limit" value="{{ current_limit }}">
                    
                    {# ğŸ”¥ ä¿®å¤é‡ç‚¹ï¼šä½¿ç”¨ widthratio è®¡ç®—å‡æ³• (total_count - current_limit) #}
                    {% widthratio current_limit 1 -1 as negative_limit %}
                    
                    <button type="submit" name="load_more" class="btn btn-outline-primary rounded-pill px-4 shadow-sm">
                        æŸ¥çœ‹æ›´å¤šå†å²æ¶ˆæ¯ (å‰©ä½™ {{ total_count|add:negative_limit }} æ¡)
                    </button>
                </form>
            </div>
            {% elif notifications %}
            <div class="card-footer bg-light border-top p-3 text-center text-muted small">
                å·²æ˜¾ç¤ºå…¨éƒ¨ {{ total_count }} æ¡é€šçŸ¥
            </div>
            {% endif %}

        </div>
    </div>
</div>
{% endblock %}