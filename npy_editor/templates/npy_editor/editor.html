{% extends 'base.html' %}
{% load static %}

{% block title %}NPY Editor V23.7 - Pro Web{% endblock %}

{# ğŸ”¥ è¦†ç›– sidebar ä¸ºç©ºï¼Œå…¨å®½å¸ƒå±€ #}
{% block sidebar %}{% endblock %}

{% block content_container %}
<div class="col-12">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <style>
        /* === ç”Ÿäº§åŠ›å·¥å…·ä¸“ç”¨æ ·å¼ === */
        
        /* å…¨å±€å»é€‰ */
        .noselect { user-select: none; -webkit-user-select: none; }
        
        /* 1. é¡¶éƒ¨å·¥å…·æ  */
        .editor-toolbar {
            background: #fff;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            padding: 0.8rem 1.5rem;
            margin-bottom: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 2. å·¦ä¾§æ§åˆ¶å° */
        .control-panel {
            height: calc(100vh - 180px); /* åŠ¨æ€è®¡ç®—é«˜åº¦ */
            overflow-y: auto;
            padding-right: 5px;
            scrollbar-width: thin;
        }
        .control-panel::-webkit-scrollbar { width: 4px; }
        .control-panel::-webkit-scrollbar-thumb { background: #ced4da; border-radius: 4px; }

        /* æ§åˆ¶å¡ç‰‡é€šç”¨æ ·å¼ */
        .panel-card {
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 8px;
            margin-bottom: 1rem;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: all 0.2s;
        }
        .panel-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border-color: rgba(0,0,0,0.12);
        }
        
        .panel-header {
            background-color: #f8f9fa;
            padding: 8px 12px;
            font-size: 0.85rem;
            font-weight: 700;
            color: #495057;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-body {
            padding: 12px;
        }

        /* 3. é”å®šçŠ¶æ€ */
        .locked-bg {
            background-color: #fff8e1 !important; /* æ·¡é»„è‰²èƒŒæ™¯ */
            border-color: #ffe69c !important;
        }
        .locked-bg .panel-header {
            background-color: #ffecb5;
            color: #856404;
        }

        /* 4. å¾®ç»„ä»¶ä¼˜åŒ– */
        .form-label-xs { font-size: 0.75rem; font-weight: 600; color: #6c757d; margin-bottom: 2px; display: block; }
        .form-control-xs, .form-select-xs { padding: 0.25rem 0.5rem; font-size: 0.85rem; border-radius: 4px; }
        
        /* é¢œè‰²é€‰æ‹©å™¨ */
        input[type="color"] {
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            cursor: pointer;
            background: none;
        }

        /* 5. ç”»å¸ƒåŒºåŸŸ */
        .canvas-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
            height: calc(100vh - 180px);
            position: relative;
            overflow: hidden;
        }
        
        /* æ‹–æ‹½é®ç½© (äº¤äº’æ ¸å¿ƒ) */
        #dragMask {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            display: none; 
            cursor: ns-resize; 
            z-index: 9999;
            /* è°ƒè¯•ç”¨ï¼šbackground: rgba(255,0,0,0.1); */
        }
    </style>

    <div class="editor-toolbar noselect">
        <div class="d-flex align-items-center gap-3">
            <div class="d-flex align-items-center">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2 shadow-sm" style="width: 36px; height: 36px;">
                    <i class="bi bi-bezier2"></i>
                </div>
                <div>
                    <h6 class="mb-0 fw-bold">NPY Data Workshop <span class="badge bg-dark ms-1" style="font-size: 0.6rem;">PRO</span></h6>
                    <small class="text-muted" id="file-status" style="font-size: 0.75rem;">ç­‰å¾…åŠ è½½æ•°æ®æº...</small>
                </div>
            </div>
            
            <div class="vr mx-2"></div>
            
            <div class="btn-group shadow-sm">
                <input type="file" id="mainFile" accept=".npy" class="d-none" onchange="uploadFile('main')">
                <button class="btn btn-sm btn-outline-primary fw-bold" onclick="document.getElementById('mainFile').click()">
                    <i class="bi bi-folder2-open me-1"></i> åŠ è½½ä¸»æ–‡ä»¶
                </button>
                
                <input type="file" id="fusionFile" accept=".npy" class="d-none" onchange="uploadFile('fusion')">
                <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('fusionFile').click()" id="btnFusion" disabled>
                    <i class="bi bi-layers-half me-1"></i> èåˆå¯¹æ¯”
                </button>
            </div>
        </div>

        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-success fw-bold text-white shadow-sm" onclick="exportPlot()">
                <i class="bi bi-camera-fill me-1"></i> å¯¼å‡ºå›¾è¡¨
            </button>
            <a href="{% url 'home' %}" class="btn btn-sm btn-light border text-muted">é€€å‡º</a>
        </div>
    </div>

    <div class="row g-3">
        
        <div class="col-lg-2 col-md-3">
            <div class="control-panel noselect">
                
                <div class="panel-card border-primary" id="curveManagerCard">
                    <div class="panel-header text-primary">
                        <span><i class="bi bi-list-task me-1"></i> æ›²çº¿ç®¡ç†</span>
                        <span id="lockStatusIcon" class="small">ğŸ”“</span>
                    </div>
                    <div class="panel-body">
                        <label class="form-label-xs">å½“å‰æ¿€æ´»å¯¹è±¡ (Active)</label>
                        <select id="activeCurveSelect" class="form-select form-select-xs mb-2 fw-bold border-primary" onchange="onActiveCurveChange()">
                            <option value="-1">-- æ— æ•°æ® --</option>
                        </select>
                        
                        <button class="btn btn-sm btn-outline-danger w-100" id="btnLock" onclick="toggleLock()">
                            <i class="bi bi-lock-fill"></i> é”å®šå½“å‰æ›²çº¿
                        </button>
                        <div class="form-text" style="font-size: 0.65rem;">é”å®šåä¸å¯ç¼–è¾‘ï¼Œé˜²æ­¢è¯¯è§¦</div>
                    </div>
                </div>

                <div class="panel-card">
                    <div class="panel-header">
                        <span><i class="bi bi-arrows-move me-1"></i> åæ ‡è½´é…ç½®</span>
                    </div>
                    <div class="panel-body">
                        <div class="row g-1 mb-2">
                            <div class="col-6">
                                <label class="form-label-xs">X è½´æ•°æ®</label>
                                <select id="xSelect" class="form-select form-select-xs"></select>
                            </div>
                            <div class="col-6">
                                <label class="form-label-xs">Y è½´æ•°æ®</label>
                                <select id="ySelect" class="form-select form-select-xs"></select>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-xs mb-1" id="xAxisLabel" placeholder="X è½´æ ‡é¢˜..." onchange="updateLayout()">
                            <input type="text" class="form-control form-control-xs" id="yAxisLabel" placeholder="Y è½´æ ‡é¢˜..." onchange="updateLayout()">
                        </div>

                        <button class="btn btn-sm btn-dark w-100 py-1" onclick="loadChart()">
                            <i class="bi bi-arrow-clockwise"></i> é‡ç»˜å›¾è¡¨
                        </button>
                    </div>
                </div>

                <div class="panel-card">
                    <div class="panel-header">
                        <span><i class="bi bi-cursor-fill me-1"></i> äº¤äº’ç¼–è¾‘</span>
                    </div>
                    <div class="panel-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="editModeSwitch">
                            <label class="form-check-label form-label-xs mt-1" for="editModeSwitch">å¯ç”¨æ‹–æ‹½ä¿®æ­£ (Drag)</label>
                        </div>
                        
                        <div class="border-top pt-2">
                            <label class="form-label-xs mb-1">æ‰¹é‡åç§» (Batch Shift)</label>
                            <button class="btn btn-xs btn-outline-secondary w-100 mb-2" id="btnToggleRegion" onclick="toggleLinearRegion()" style="font-size: 0.75rem;">
                                <i class="bi bi-bounding-box"></i> é€‰æ‹©èŒƒå›´
                            </button>
                            
                            <div class="input-group input-group-sm">
                                <button class="btn btn-outline-danger" onclick="applyBatch(-1)"><i class="bi bi-dash"></i></button>
                                <input type="number" class="form-control text-center form-control-xs" id="batchShiftVal" value="1.0" step="0.1">
                                <button class="btn btn-outline-success" onclick="applyBatch(1)"><i class="bi bi-plus"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel-card">
                    <div class="panel-header">
                        <span><i class="bi bi-palette-fill me-1"></i> æ ·å¼é£æ ¼</span>
                    </div>
                    <div class="panel-body">
                        <input type="text" class="form-control form-control-xs mb-2" id="chartTitle" placeholder="å›¾è¡¨æ€»æ ‡é¢˜" onchange="updateLayout()">
                        
                        <select class="form-select form-select-xs mb-2" id="colorPreset" onchange="applyPreset()">
                            <option value="default">ğŸ¨ é…è‰²: ç»å…¸è“</option>
                            <option value="macaron">ğŸ¬ é…è‰²: é©¬å¡é¾™</option>
                            <option value="morandi">ğŸŒ«ï¸ é…è‰²: è«å…°è’‚</option>
                            <option value="cyber">ğŸ¤– é…è‰²: èµ›åšæœ‹å…‹</option>
                        </select>

                        <div class="d-flex align-items-center justify-content-between mb-2 border rounded p-1">
                            <label class="form-label-xs mb-0 ms-1">çº¿æ¡:</label>
                            <input type="color" id="traceColor" onchange="updateTraceStyle()" title="é¢œè‰²">
                            <input type="number" class="form-control form-control-xs" id="traceWidth" value="2" min="1" max="10" style="width: 50px;" title="ç²—ç»†" onchange="updateTraceStyle()">
                        </div>

                        <div class="d-grid">
                            <button class="btn btn-sm btn-outline-secondary py-0" onclick="openLegendEditor()" style="font-size: 0.75rem;">
                                <i class="bi bi-fonts"></i> é‡å‘½åå›¾ä¾‹...
                            </button>
                        </div>
                        
                        <div class="mt-2 text-center">
                            <a class="text-decoration-none small text-muted" data-bs-toggle="collapse" href="#moreSettings" role="button">
                                æ›´å¤šè®¾ç½® <i class="bi bi-chevron-down"></i>
                            </a>
                        </div>
                        <div class="collapse mt-2" id="moreSettings">
                            <div class="card card-body p-2 bg-light border-0">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showGrid" checked onchange="updateLayout()">
                                    <label class="form-check-label small">æ˜¾ç¤ºç½‘æ ¼</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showLegend" checked onchange="updateLayout()">
                                    <label class="form-check-label small">æ˜¾ç¤ºå›¾ä¾‹</label>
                                </div>
                                <div class="input-group input-group-sm mt-1">
                                    <span class="input-group-text p-1" style="font-size:0.7rem">å­—å·</span>
                                    <input type="number" class="form-control p-1" id="legendFontSize" value="12" onchange="updateLayout()">
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>

        <div class="col-lg-10 col-md-9">
            <div class="canvas-container">
                <div id="plotDiv" style="width:100%; height:100%;"></div>
                <div id="dragMask"></div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="legendModal" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header py-2 bg-light">
                    <h6 class="modal-title fw-bold">é‡å‘½åæ›²çº¿</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-3">
                    <form id="legendForm"></form>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-primary btn-sm w-100" onclick="saveLegendNames()">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let gd = document.getElementById('plotDiv');
        let currentTraces = [];
        let isDragging = false;
        let dragState = { curveIdx: -1, pointIdx: -1, offsetY: 0, yaxis: null };
        let regionActive = false;
        let lockedTraces = {}; 
        let activeTraceIndex = 0; 

        const PALETTES = {
            'default': ['#0d6efd', '#fd7e14', '#198754', '#dc3545', '#6610f2'],
            'macaron': ['#FFADAD', '#FFD6A5', '#FDFFB6', '#CAFFBF', '#9BF6FF', '#A0C4FF', '#BDB2FF', '#FFC6FF'],
            'morandi': ['#7A7281', '#A2999E', '#848C90', '#C4B7B0', '#959685', '#E2DACE'],
            'cyber': ['#00f3ff', '#bc13fe', '#ff00ff', '#120052', '#00ff9f']
        };

        const layout = {
            title: { text: '', font: { family: 'Microsoft YaHei', size: 18 } }, // é»˜è®¤ç©ºæ ‡é¢˜æ›´ç®€æ´
            font: { family: 'Segoe UI, Arial', size: 12 },
            margin: { t: 50, r: 30, l: 50, b: 50 }, // è°ƒæ•´è¾¹è·
            xaxis: { title: 'Index', gridcolor: '#f0f0f0', zeroline: false },
            yaxis: { title: 'Value', gridcolor: '#f0f0f0', zeroline: false },
            hovermode: 'closest',
            dragmode: 'zoom',
            showlegend: true,
            legend: { x: 0.01, y: 0.99, bgcolor: 'rgba(255,255,255,0.9)', bordercolor: '#eee', borderwidth: 1 },
            shapes: []
        };
        const config = { responsive: true, displayModeBar: true, displaylogo: false, edits: { shapePosition: true } };
        
        Plotly.newPlot(gd, [], layout, config);

        // --- é€»è¾‘å‡½æ•°åŒº (ä¸ä¹‹å‰ä¿æŒä¸€è‡´ï¼Œé€‚é…äº†æ–°æ ·å¼ç±»å) ---
        
        function updateCurveSelector() {
            const sel = document.getElementById('activeCurveSelect');
            sel.innerHTML = '';
            if (currentTraces.length === 0) {
                sel.innerHTML = '<option value="-1">-- æ— æ•°æ® --</option>';
                return;
            }
            currentTraces.forEach((t, i) => {
                let name = t.name || `Trace ${i}`;
                let lockMark = lockedTraces[i] ? 'ğŸ”’ ' : '';
                sel.innerHTML += `<option value="${i}">${lockMark}${name}</option>`;
            });
            sel.value = activeTraceIndex;
            updateLockUI(); 
        }

        function onActiveCurveChange() {
            activeTraceIndex = parseInt(document.getElementById('activeCurveSelect').value);
            updateLockUI();
            const trace = currentTraces[activeTraceIndex];
            if(trace && trace.line) {
                document.getElementById('traceColor').value = trace.line.color;
                document.getElementById('traceWidth').value = trace.line.width;
            }
        }

        function toggleLock() {
            if (currentTraces.length === 0) return;
            lockedTraces[activeTraceIndex] = !lockedTraces[activeTraceIndex];
            updateLockUI();
            updateCurveSelector();
        }

        function updateLockUI() {
            const isLocked = !!lockedTraces[activeTraceIndex];
            const btn = document.getElementById('btnLock');
            const icon = document.getElementById('lockStatusIcon');
            const card = document.getElementById('curveManagerCard');
            
            if (isLocked) {
                btn.classList.replace('btn-outline-danger', 'btn-danger');
                btn.innerHTML = '<i class="bi bi-lock-fill"></i> å·²é”å®š';
                icon.innerText = 'ğŸ”’';
                card.classList.add('locked-bg');
            } else {
                btn.classList.replace('btn-danger', 'btn-outline-danger');
                btn.innerHTML = '<i class="bi bi-unlock"></i> ç‚¹å‡»é”å®š';
                icon.innerText = 'ğŸ”“';
                card.classList.remove('locked-bg');
            }
        }

        // æ‹–æ‹½é€»è¾‘
        gd.on('plotly_click', function(data){
            if (!document.getElementById('editModeSwitch').checked) return;
            
            const pt = data.points[0];
            const clickedIdx = pt.curveNumber;

            if (clickedIdx !== activeTraceIndex) {
                activeTraceIndex = clickedIdx;
                updateCurveSelector();
            }

            if (lockedTraces[activeTraceIndex]) {
                alert(`æ›²çº¿ "${currentTraces[activeTraceIndex].name}" å·²é”å®šï¼Œæ— æ³•ä¿®æ”¹ï¼`);
                return; 
            }
            
            const yaxis = gd._fullLayout.yaxis;
            const rect = gd.getBoundingClientRect();
            const mouseDataY = yaxis.p2d(data.event.clientY - rect.top);
            
            isDragging = true;
            dragState = {
                curveIdx: clickedIdx,
                pointIdx: pt.pointIndex,
                offsetY: pt.y - mouseDataY,
                yaxis: yaxis
            };
            
            document.getElementById('dragMask').style.display = 'block';
        });

        document.getElementById('dragMask').addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            const rect = gd.getBoundingClientRect();
            const currentMouseDataY = dragState.yaxis.p2d(e.clientY - rect.top);
            const newDataY = currentMouseDataY + dragState.offsetY;

            currentTraces[dragState.curveIdx].y[dragState.pointIdx] = newDataY;
            
            requestAnimationFrame(() => {
                Plotly.restyle(gd, { y: [currentTraces[dragState.curveIdx].y] }, [dragState.curveIdx]);
            });
        });

        document.getElementById('dragMask').addEventListener('mouseup', function(e) {
            if (!isDragging) return;
            isDragging = false;
            document.getElementById('dragMask').style.display = 'none';
            const finalVal = currentTraces[dragState.curveIdx].y[dragState.pointIdx];
            saveSinglePoint(dragState.curveIdx, dragState.pointIdx, finalVal);
        });
        
        document.getElementById('editModeSwitch').addEventListener('change', (e) => {
            if (e.target.checked) {
                Plotly.relayout(gd, { dragmode: false });
                gd.style.cursor = 'pointer';
            } else {
                Plotly.relayout(gd, { dragmode: 'zoom' });
                gd.style.cursor = 'default';
            }
        });

        // æ‰¹é‡æ“ä½œ
        function toggleLinearRegion() {
            regionActive = !regionActive;
            const btn = document.getElementById('btnToggleRegion');
            if (regionActive) {
                btn.classList.replace('btn-outline-secondary', 'btn-secondary');
                btn.innerHTML = '<i class="bi bi-x-square"></i> å…³é—­èŒƒå›´';
                const xrange = gd.layout.xaxis.range || [0, 100];
                const width = (xrange[1] - xrange[0]) / 5;
                const center = (xrange[1] + xrange[0]) / 2;
                const shape = {
                    type: 'rect', xref: 'x', yref: 'paper',
                    x0: center - width, x1: center + width,
                    y0: 0, y1: 1,
                    fillcolor: 'rgba(13, 110, 253, 0.2)', // ä½¿ç”¨ Bootstrap Primary è‰²åŠé€æ˜
                    line: {width: 0},
                    editable: true
                };
                Plotly.relayout(gd, { shapes: [shape] });
            } else {
                btn.classList.replace('btn-secondary', 'btn-outline-secondary');
                btn.innerHTML = '<i class="bi bi-bounding-box"></i> é€‰æ‹©èŒƒå›´';
                Plotly.relayout(gd, { shapes: [] });
            }
        }
        
        function applyBatch(direction) {
            if (lockedTraces[activeTraceIndex]) {
                alert(`å½“å‰æ›²çº¿ "${currentTraces[activeTraceIndex].name}" å·²é”å®šï¼`);
                return;
            }
            if (!regionActive || !gd.layout.shapes || gd.layout.shapes.length === 0) {
                alert("è¯·å…ˆå¼€å¯èŒƒå›´é€‰æ‹©ï¼"); return;
            }
            const shape = gd.layout.shapes[0];
            const minX = Math.min(shape.x0, shape.x1);
            const maxX = Math.max(shape.x0, shape.x1);
            const shift = parseFloat(document.getElementById('batchShiftVal').value) * direction;
            const yKey = document.getElementById('ySelect').value;
            const xKey = document.getElementById('xSelect').value;

            fetch("{% url 'npy_editor:update_data' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ 
                    mode: 'batch', 
                    trace_index: activeTraceIndex, 
                    min_x: minX, max_x: maxX, shift: shift, x_key: xKey, y_key: yKey 
                })
            }).then(r=>r.json()).then(d=>{
                if(d.status==='ok') loadChart();
                else alert(d.msg);
            });
        }

        // æ ·å¼ä¸å¸ƒå±€
        function updateTraceStyle() {
            const color = document.getElementById('traceColor').value;
            const width = parseInt(document.getElementById('traceWidth').value);
            if (currentTraces.length > 0) {
                Plotly.restyle(gd, {
                    'line.color': color,
                    'line.width': width
                }, [activeTraceIndex]);
                if(!currentTraces[activeTraceIndex].line) currentTraces[activeTraceIndex].line = {};
                currentTraces[activeTraceIndex].line.color = color;
                currentTraces[activeTraceIndex].line.width = width;
            }
        }

        function applyPreset() {
            const preset = document.getElementById('colorPreset').value;
            const colors = PALETTES[preset] || PALETTES['default'];
            currentTraces.forEach((trace, i) => {
                const color = colors[i % colors.length];
                Plotly.restyle(gd, { 'line.color': color }, [i]);
                if(!trace.line) trace.line = {}; trace.line.color = color;
            });
            if(currentTraces[activeTraceIndex]) {
                document.getElementById('traceColor').value = currentTraces[activeTraceIndex].line.color;
            }
        }

        function updateLayout() {
            const title = document.getElementById('chartTitle').value;
            const xLabel = document.getElementById('xAxisLabel').value;
            const yLabel = document.getElementById('yAxisLabel').value;
            const showGrid = document.getElementById('showGrid').checked;
            const showLegend = document.getElementById('showLegend').checked;
            const legFontSize = parseInt(document.getElementById('legendFontSize').value) || 12;

            const newLayout = {
                'title.text': title || '',
                'xaxis.title.text': xLabel || 'Index',
                'yaxis.title.text': yLabel || 'Value',
                'xaxis.showgrid': showGrid,
                'yaxis.showgrid': showGrid,
                showlegend: showLegend,
                'legend.font.size': legFontSize
            };
            
            Plotly.relayout(gd, newLayout);
        }
        
        // æ–‡ä»¶ IO
        function uploadFile(type) {
            const inputId = type === 'main' ? 'mainFile' : 'fusionFile';
            const fileInput = document.getElementById(inputId);
            if (!fileInput.files.length) return;
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('type', type);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            // UI åé¦ˆ
            document.getElementById('file-status').innerText = "åŠ è½½ä¸­...";
            
            fetch("{% url 'npy_editor:upload_file' %}", { method: 'POST', body: formData })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'ok') {
                    if (type === 'main') {
                        const xSel = document.getElementById('xSelect');
                        const ySel = document.getElementById('ySelect');
                        xSel.innerHTML = '<option value="Index">Index</option>';
                        ySel.innerHTML = '';
                        data.keys.forEach(k => {
                            xSel.innerHTML += `<option value="${k}">${k}</option>`;
                            ySel.innerHTML += `<option value="${k}">${k}</option>`;
                        });
                        if (data.keys.length > 1) ySel.selectedIndex = 1;
                        
                        document.getElementById('file-status').innerHTML = `<span class="text-success fw-bold">Ready</span>: ${fileInput.files[0].name}`;
                        document.getElementById('btnFusion').disabled = false;
                        lockedTraces = {};
                        activeTraceIndex = 0;
                    }
                    loadChart();
                } else {
                    alert(data.msg);
                    document.getElementById('file-status').innerText = "åŠ è½½å¤±è´¥";
                }
            });
        }

        function loadChart() {
            const xKey = document.getElementById('xSelect').value;
            const yKey = document.getElementById('ySelect').value;
            fetch(`{% url 'npy_editor:get_data' %}?x_key=${xKey}&y_key=${yKey}`)
            .then(r => r.json()).then(data => {
                if (data.status === 'ok') {
                    currentTraces = data.traces;
                    currentTraces.forEach((t, i) => {
                        t.line = { width: 2 };
                        if (i > 0) t.line.dash = 'dash';
                    });
                    applyPreset();
                    updateCurveSelector();
                    updateLayout();
                    Plotly.react(gd, currentTraces, layout, config);
                }
            });
        }

        function saveSinglePoint(cIdx, pIdx, val) {
            const yKey = document.getElementById('ySelect').value;
            fetch("{% url 'npy_editor:update_data' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ mode: 'single', trace_index: cIdx, index: pIdx, value: val, y_key: yKey })
            });
        }
        
        function openLegendEditor() {
            const form = document.getElementById('legendForm');
            form.innerHTML = '';
            if (currentTraces.length === 0) {
                form.innerHTML = '<div class="text-muted text-center">æš‚æ— æ›²çº¿æ•°æ®</div>';
            } else {
                currentTraces.forEach((trace, idx) => {
                    form.innerHTML += `
                        <div class="input-group input-group-sm mb-2">
                            <span class="input-group-text" style="color:${trace.line?.color||'black'}">â—</span>
                            <input type="text" class="form-control legend-input" data-idx="${idx}" value="${trace.name}">
                        </div>
                    `;
                });
            }
            new bootstrap.Modal(document.getElementById('legendModal')).show();
        }
        
        function saveLegendNames() {
            document.querySelectorAll('.legend-input').forEach(input => {
                const idx = input.dataset.idx;
                Plotly.restyle(gd, { name: input.value }, [parseInt(idx)]);
                currentTraces[idx].name = input.value;
            });
            bootstrap.Modal.getInstance(document.getElementById('legendModal')).hide();
            updateCurveSelector();
        }
        
        function exportPlot() {
            Plotly.downloadImage(gd, {format: 'svg', width: 1200, height: 800, filename: 'npy_plot'});
        }
    </script>
</div>
{% endblock %}