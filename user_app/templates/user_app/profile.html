{% extends 'base.html' %}

{% block title %}ä¸ªäººä¸­å¿ƒ - {{ user.nickname|default:user.username }}{% endblock %}

{# ğŸ”¥ è¦†ç›– sidebar ä¸ºç©ºï¼Œå…¨å®½å¸ƒå±€ #}
{% block sidebar %}{% endblock %}

{% block content_container %}
<div class="col-12">
    {% block content %}
    
    <link rel="stylesheet" href="https://unpkg.com/vditor/dist/index.css" />
    <script src="https://unpkg.com/vditor/dist/index.min.js"></script>

    <style>
        /* èƒŒæ™¯è£…é¥° */
        .profile-bg {
            height: 200px;
            background: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);
            border-radius: 0 0 50% 50% / 20px;
            margin-bottom: -100px;
            position: relative;
            z-index: 0;
        }

        /* å¤´åƒå®¹å™¨ */
        .profile-avatar-box {
            width: 140px;
            height: 140px;
            position: relative;
            margin: 0 auto 1rem;
        }
        .profile-avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            border: 5px solid #fff;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
            background-color: #fff;
        }
        .profile-level-badge {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: white;
            font-weight: bold;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* ç»Ÿè®¡æ•°å­— */
        .stat-box {
            transition: all 0.2s;
            padding: 10px;
            border-radius: 10px;
        }
        .stat-box:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
        }

        /* è¡¨å•åŒºåŸŸ */
        .form-section-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        /* ğŸ”¥ å…³é”®ï¼šå·¦ä¾§å¡ç‰‡å¸é¡¶æ•ˆæœ */
        .sticky-profile-card {
            position: sticky;
            top: 100px; /* è·ç¦»é¡¶éƒ¨çš„è·ç¦»ï¼Œç•™å‡ºå¯¼èˆªæ ç©ºé—´ */
            z-index: 10;
        }
    </style>

    <div class="profile-bg"></div>

    <div class="container pb-5" style="position: relative; z-index: 1;">
        
        <div class="row g-4">
            
            <div class="col-lg-4">
                <div class="card shadow border-0 rounded-4 overflow-hidden sticky-profile-card">
                    <div class="card-body text-center pt-5 pb-4 px-4">
                        
                        <div class="profile-avatar-box">
                            {% if user.avatar %}
                                <img src="{{ user.avatar.url }}" class="profile-avatar-img" id="avatarPreview">
                            {% else %}
                                <div class="profile-avatar-img d-flex align-items-center justify-content-center bg-secondary text-white display-1 fw-bold">
                                    {{ user.username.0|upper }}
                                </div>
                            {% endif %}
                            <div class="profile-level-badge">Lv.{{ user.level }}</div>
                        </div>

                        <h4 class="fw-bold mb-1">{{ user.nickname|default:user.username }}</h4>
                        <div class="mb-3">
                            {% if user.status == 'newbie' %}
                                <span class="badge bg-success bg-opacity-10 text-success border border-success rounded-pill">ğŸŒ± {{ user.get_status_display }}</span>
                            {% elif user.status == 'student' %}
                                <span class="badge bg-primary bg-opacity-10 text-primary border border-primary rounded-pill">ğŸ“ {{ user.get_status_display }}</span>
                            {% elif user.status == 'alumni' %}
                                <span class="badge bg-warning bg-opacity-10 text-warning border border-warning rounded-pill">ğŸ† {{ user.get_status_display }}</span>
                            {% elif user.status == 'faculty' %}
                                <span class="badge bg-danger bg-opacity-10 text-danger border border-danger rounded-pill">ğŸ‘¨â€ğŸ« {{ user.get_status_display }}</span>
                            {% endif %}
                        </div>

                        <p class="text-muted small fst-italic px-3 mb-4">
                            "{{ user.bio|default:"è¿™ä¸ªäººå¾ˆæ‡’ï¼Œè¿˜æ²¡æœ‰å†™ç®€ä»‹~" }}"
                        </p>

                        <div class="row g-2 mb-4 border-top border-bottom py-3">
                            <div class="col-4 border-end">
                                <div class="stat-box">
                                    <div class="h5 fw-bold mb-0 text-dark">{{ user.following.count }}</div>
                                    <small class="text-muted" style="font-size: 0.7rem;">å…³æ³¨</small>
                                </div>
                            </div>
                            <div class="col-4 border-end">
                                <div class="stat-box">
                                    <div class="h5 fw-bold mb-0 text-dark">{{ user.followers.count }}</div>
                                    <small class="text-muted" style="font-size: 0.7rem;">ç²‰ä¸</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-box">
                                    <div class="h5 fw-bold mb-0 text-dark">{{ user.posts.count }}</div>
                                    <small class="text-muted" style="font-size: 0.7rem;">å¸–å­</small>
                                </div>
                            </div>
                        </div>

                        <div class="px-3 mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="fw-bold text-secondary small">å‡çº§è¿›åº¦</span>
                                <small class="text-success fw-bold">{{ user.level_progress }}%</small>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: {{ user.level_progress }}%"></div>
                            </div>
                            <div class="d-flex justify-content-between mt-2 small text-muted">
                                <span>æˆé•¿å€¼: {{ user.growth }}</span>
                                <span>ç¡¬å¸: ğŸª™ {{ user.coins }}</span>
                            </div>
                        </div>

                        <div class="d-grid gap-2 mb-3">
                            <a href="{% url 'user_app:public_profile' user.pk %}" class="btn btn-outline-primary rounded-pill">
                                ğŸ‘€ é¢„è§ˆä¸»é¡µ
                            </a>
                            <a href="{% url 'community:my_collections' %}" class="btn btn-outline-warning text-dark rounded-pill">
                                ğŸ“‚ ç®¡ç†æ”¶è—å¤¹
                            </a>
                            <a href="{% url 'home' %}" class="btn btn-light rounded-pill text-muted">
                                è¿”å›å¤§å…
                            </a>
                        </div>
                        
                        <div class="border-top pt-3 text-start small text-muted">
                            <div class="d-flex justify-content-between mb-1">
                                <span><i class="bi bi-shield-check text-success"></i> é‚®ç®±éªŒè¯</span>
                                <span>{% if user.email_verified %}å·²éªŒè¯{% else %}æœªéªŒè¯{% endif %}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span><i class="bi bi-calendar3"></i> åŠ å…¥æ—¶é—´</span>
                                <span>{{ user.date_joined|date:"Y-m-d" }}</span>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card shadow border-0 rounded-4">
                    <div class="card-header bg-white py-3 border-bottom-0">
                        <h5 class="mb-0 fw-bold border-start border-4 border-primary ps-3">âš™ï¸ ç¼–è¾‘èµ„æ–™</h5>
                    </div>
                    <div class="card-body p-4">
                        
                        {% if user.status != 'newbie' %}
                        <div class="card bg-light border-0 mb-4 rounded-3">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="fw-bold text-dark mb-1">
                                        <i class="bi bi-robot text-primary me-2"></i>AI åˆ›æ–°åŠ©æ‰‹é…ç½®
                                    </h6>
                                    <p class="text-muted small mb-0">ç®¡ç†æ‚¨çš„ API Keyã€æ¨¡å‹æä¾›å•†åŠ Base URL</p>
                                </div>
                                <a href="{% url 'innovation_agent:config' %}?edit=true" class="btn btn-sm btn-white border shadow-sm fw-bold text-primary">
                                    ç®¡ç†é…ç½®
                                </a>
                            </div>
                        </div>
                        {% endif %}
                        <form method="post" enctype="multipart/form-data">
                            {% csrf_token %}

                            {% if form.non_field_errors %}
                                <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                            {% endif %}

                            <div class="form-section-title">åŸºæœ¬ä¿¡æ¯</div>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">æ˜µç§°</label>
                                    {{ form.nickname }}
                                    {% if form.nickname.errors %}<div class="text-danger small">{{ form.nickname.errors.0 }}</div>{% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">é‚®ç®± (ä¸å¯ä¿®æ”¹)</label>
                                    {{ form.email }}
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold small">ä¸€å¥è¯ç®€ä»‹</label>
                                    {{ form.bio }}
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold small">ä¸Šä¼ å¤´åƒ</label>
                                    {{ form.avatar }}
                                    <div class="form-text small">æ”¯æŒ jpg, png, webp æ ¼å¼ï¼Œå»ºè®®å°ºå¯¸ 200x200ã€‚</div>
                                </div>
                            </div>

                            <div class="form-section-title">èº«ä»½è®¤è¯</div>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">å½“å‰èº«ä»½</label>
                                    {{ form.status }}
                                    <div class="form-text small">æ¯•ä¸šåè¯·åˆ‡æ¢ä¸º"æ¯•ä¸šæ ¡å‹"ï¼Œåˆ‡æ¢åä¸å¯å›é€€ã€‚</div>
                                </div>
                                
                                <div class="col-md-6" id="div_student_id" style="display: none;">
                                    <label class="form-label fw-bold small">å­¦å· (Student ID)</label>
                                    {{ form.student_id }}
                                    {% if form.student_id.errors %}
                                        <div class="text-danger small">{{ form.student_id.errors.0 }}</div>
                                    {% endif %}
                                    <div class="form-text small">è¯·å¡«å†™çœŸå®å­¦å·ä»¥é€šè¿‡ç™½åå•éªŒè¯ã€‚</div>
                                </div>
                            </div>

                            {% if user.status == 'faculty' or user.status == 'student' or user.status == 'alumni' %}
                            <div class="form-section-title text-primary">ğŸ“ è¯¦ç»†ä¸ªäººä»‹ç» (æ”¯æŒ Markdown)</div>
                            <div class="mb-4">
                                <div id="vditor" class="mb-2"></div>
                                <textarea name="detailed_intro" id="detailed_intro_hidden" class="d-none">
                                    {{ form.detailed_intro.value|default:'' }}
                                </textarea>
                                <div class="form-text small">
                                    {% if user.status == 'faculty' %}
                                        æ­¤å†…å®¹å°†æ˜¾ç¤ºåœ¨â€œå®éªŒå®¤ä»‹ç»â€é¡µé¢çš„<strong>å¯¼å¸ˆè¯¦æƒ…</strong>ä¸­ã€‚
                                    {% else %}
                                        æ­¤å†…å®¹å°†æ˜¾ç¤ºåœ¨â€œå®éªŒå®¤ä»‹ç»â€é¡µé¢çš„<strong>æˆå‘˜ç®€ä»‹å¼¹çª—</strong>ä¸­ã€‚
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}

                            <div class="d-flex justify-content-end gap-3 mt-5 border-top pt-4">
                                <button type="reset" class="btn btn-light rounded-pill px-4">é‡ç½®</button>
                                <button type="submit" id="saveBtn" class="btn btn-primary rounded-pill px-5 fw-bold shadow-sm">
                                    ğŸ’¾ ä¿å­˜æ›´æ”¹
                                </button>
                            </div>

                        </form>

                    </div>
                </div>
            </div>

        </div>
    </div>
    {% endblock %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // 1. å¤´åƒé¢„è§ˆ
        const avatarInput = document.querySelector('input[type="file"][name="avatar"]');
        const avatarPreview = document.getElementById('avatarPreview');
        if (avatarInput && avatarPreview) {
            avatarInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        avatarPreview.src = e.target.result;
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        // 2. å­¦å·æ˜¾ç¤ºé€»è¾‘
        const statusSelect = document.getElementById('id_profile_status') || document.querySelector('select[name="status"]');
        const studentIdDiv = document.getElementById('div_student_id');
        const studentIdInput = document.getElementById('id_profile_student_id') || document.querySelector('input[name="student_id"]');
        
        const currentUserStatus = "{{ user.status }}";

        if (currentUserStatus === 'alumni') {
            if(statusSelect) statusSelect.disabled = true;
            if(studentIdInput) studentIdInput.disabled = true;
        }

        function toggleStudentId() {
            if (!statusSelect) return;
            const val = statusSelect.value;
            if (val === 'student' || val === 'alumni') {
                studentIdDiv.style.display = 'block';
                studentIdDiv.style.opacity = 0;
                setTimeout(() => { 
                    studentIdDiv.style.opacity = 1; 
                    studentIdDiv.style.transition = 'opacity 0.3s';
                }, 10);
            } else {
                studentIdDiv.style.display = 'none';
            }
        }

        if (statusSelect) {
            statusSelect.addEventListener('change', toggleStudentId);
            toggleStudentId(); 
        }

        // 3. Vditor åˆå§‹åŒ–
        {% if user.status == 'faculty' or user.status == 'student' or user.status == 'alumni' %}
            const hiddenInput = document.getElementById('detailed_intro_hidden');
            const vditor = new Vditor('vditor', {
                height: 400,
                mode: 'sv', 
                value: hiddenInput.value,
                placeholder: 'è¯·è¾“å…¥è¯¦ç»†ä»‹ç»ï¼ˆæ”¯æŒ Markdown è¯­æ³•ï¼‰...',
                cache: { enable: false },
                toolbar: ['emoji', 'headings', 'bold', 'italic', 'strike', 'link', '|', 'list', 'ordered-list', 'check', 'outdent', 'indent', '|', 'quote', 'line', 'code', 'inline-code', 'insert-before', 'insert-after', '|', 'upload', 'table', 'edit-mode'],
                upload: {
                    accept: 'image/jpg, image/jpeg, image/png, image/gif',
                    url: '{% url "community:upload_image" %}',
                    linkToImgUrl: '{% url "community:upload_image" %}',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                    fieldName: 'file[]',
                    format(files, responseText) {
                        const res = JSON.parse(responseText);
                        return JSON.stringify({
                            msg: res.msg, code: res.code,
                            data: { succMap: { [files[0].name]: res.data.succMap[files[0].name] } }
                        });
                    }
                },
                input(value) {
                    hiddenInput.value = value;
                }
            });

            document.getElementById('saveBtn').addEventListener('click', function() {
                hiddenInput.value = vditor.getValue();
            });
        {% endif %}
    });
</script>
{% endblock %}