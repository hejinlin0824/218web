{% extends 'base.html' %}

{% block title %}æˆ‘çš„ä»»åŠ¡{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-9">
        <h3 class="fw-bold mb-4">ğŸ“‹ ä»»åŠ¡ç®¡ç†</h3>

        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#my-published" type="button">
                    ğŸ“¤ æˆ‘å‘å¸ƒçš„
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#my-joined" type="button">
                    ğŸ“¥ æˆ‘å‚ä¸çš„
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="my-published">
                <div class="list-group shadow-sm">
                    {% for task in created_tasks %}
                        <a href="{% url 'tasks:task_detail' task.pk %}" class="list-group-item list-group-item-action p-4 border-start-0 border-end-0">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <h5 class="mb-1 fw-bold">{{ task.title }}</h5>
                                <small class="text-muted">{{ task.created_at|date:"Y-m-d" }}</small>
                            </div>
                            <p class="mb-1">
                                <span class="badge bg-warning text-dark me-2">ğŸª™ {{ task.bounty }}</span>
                                {% if task.status == 'open' %}
                                    <span class="badge bg-success">æ‹›å‹Ÿä¸­</span>
                                {% elif task.status == 'in_progress' %}
                                    <span class="badge bg-primary">è¿›è¡Œä¸­</span>
                                {% elif task.status == 'closed' %}
                                    <span class="badge bg-secondary">å·²ç»“æŸ</span>
                                {% endif %}
                            </p>
                            <small class="text-muted">å‚ä¸äººæ•°: {{ task.participants.count }}</small>
                        </a>
                    {% empty %}
                        <div class="text-center py-5 text-muted">ä½ è¿˜æ²¡æœ‰å‘å¸ƒè¿‡ä»»åŠ¡</div>
                    {% endfor %}
                </div>
                <div class="mt-3">
                    <a href="{% url 'tasks:task_create' %}" class="btn btn-primary rounded-pill">+ å‘å¸ƒæ–°ä»»åŠ¡</a>
                </div>
            </div>

            <div class="tab-pane fade" id="my-joined">
                <div class="list-group shadow-sm">
                    {% for record in my_participations %}
                        <a href="{% url 'tasks:task_detail' record.task.pk %}" class="list-group-item list-group-item-action p-4 border-start-0 border-end-0">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <h5 class="mb-1 fw-bold">{{ record.task.title }}</h5>
                                <small class="text-muted font-monospace">
                                    {% if record.task.status == 'closed' %}
                                        ğŸ å·²ç»“æŸ
                                    {% elif record.task.is_overdue %}
                                        ğŸ›‘ å·²æˆªæ­¢
                                    {% else %}
                                        <span class="countdown-timer" data-deadline="{{ record.task.deadline|date:'c' }}">â³</span>
                                    {% endif %}
                                </small>
                            </div>
                            <p class="mb-1">
                                çŠ¶æ€: 
                                {% if record.status == 'invited' %}
                                    <span class="badge bg-info">ğŸ“© å¾…æ¥å—</span>
                                {% elif record.status == 'accepted' %}
                                    <span class="badge bg-success">âœ… è¿›è¡Œä¸­</span>
                                {% endif %}
                                <span class="ms-2">å‘å¸ƒäºº: {{ record.task.creator.nickname }}</span>
                            </p>
                        </a>
                    {% empty %}
                        <div class="text-center py-5 text-muted">æš‚æ— å‚ä¸çš„ä»»åŠ¡</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const timers = document.querySelectorAll('.countdown-timer');
    
    function updateTimers() {
        timers.forEach(timer => {
            const deadline = new Date(timer.dataset.deadline).getTime();
            const now = new Date().getTime();
            const distance = deadline - now;
            
            if (distance < 0) {
                timer.innerHTML = 'ğŸ›‘ å·²æˆªæ­¢';
                return;
            }
            
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            let timeStr = '';
            if (days > 0) timeStr += `${days}d`;
            timeStr += `${hours}h${minutes}m${seconds}s`;
            timer.innerHTML = 'â³ ' + timeStr;
        });
    }
    
    if (timers.length > 0) {
        setInterval(updateTimers, 1000);
        updateTimers();
    }
});
</script>
{% endblock %}