{% extends 'base.html' %}

{% block title %}ä»»åŠ¡ä¸­å¿ƒ - 218 å®éªŒå®¤{% endblock %}

{% block content %}
<style>
    /* === ä»»åŠ¡ä¸­å¿ƒä¸“ç”¨æ ·å¼ === */
    
    /* é¡¶éƒ¨ Banner */
    .task-hero {
        background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
        border-radius: 1rem;
        padding: 3rem 2rem;
        color: #fff;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 20px rgba(253, 160, 133, 0.2);
    }
    .task-hero::before {
        content: "TASKS";
        position: absolute;
        top: -10px;
        right: 10px;
        font-size: 6rem;
        font-weight: 900;
        opacity: 0.15;
        pointer-events: none;
    }

    /* ä»»åŠ¡å¡ç‰‡ */
    .task-card {
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        border: 1px solid rgba(0,0,0,0.05);
        background: white;
        margin-bottom: 1rem;
        border-radius: 12px;
    }
    .task-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.08);
        border-color: rgba(0,0,0,0.1);
    }

    /* çŠ¶æ€å¾½ç«  */
    .status-badge {
        padding: 5px 12px;
        border-radius: 30px;
        font-size: 0.75rem;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* é‡‘å¸æ ·å¼ */
    .bounty-tag {
        background-color: #fff8e1;
        color: #d4a017;
        font-weight: 800;
        padding: 4px 10px;
        border-radius: 8px;
        border: 1px solid #ffe69c;
    }

    /* å¯¼å¸ˆæŒ‡ä»¤æ ·å¼ */
    .faculty-tag {
        background-color: #fce8e6;
        color: #dc3545;
        font-weight: 800;
        padding: 4px 10px;
        border-radius: 8px;
        border: 1px solid #fadbd8;
    }

    /* Tab æ ·å¼ä¼˜åŒ– */
    .nav-pills-task .nav-link {
        color: #6c757d;
        background: transparent;
        font-weight: 600;
        padding: 10px 20px;
        border-radius: 50rem;
        transition: all 0.2s;
    }
    .nav-pills-task .nav-link.active {
        background-color: #fff;
        color: #0d6efd;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .nav-pills-wrapper {
        background-color: #f1f3f5;
        padding: 5px;
        border-radius: 50rem;
        display: inline-flex;
    }
</style>

<div class="row justify-content-center">
    <div class="col-lg-10">
        
        <div class="task-hero mb-4 d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold mb-1">ğŸ“‹ ä»»åŠ¡ç®¡ç†ä¸­å¿ƒ</h2>
                <p class="mb-0 opacity-90">å‘å¸ƒæ‚¬èµã€å‚ä¸æŒ‘æˆ˜ã€åä½œå…±èµ¢ã€‚</p>
            </div>
            <div class="d-none d-md-block">
                <a href="{% url 'tasks:task_create' %}" class="btn btn-light text-warning fw-bold rounded-pill px-4 shadow-sm">
                    <i class="bi bi-plus-lg me-1"></i> å‘å¸ƒæ–°ä»»åŠ¡
                </a>
            </div>
        </div>

        <div class="d-md-none mb-3">
            <a href="{% url 'tasks:task_create' %}" class="btn btn-warning text-white w-100 fw-bold rounded-pill shadow-sm">
                + å‘å¸ƒæ–°ä»»åŠ¡
            </a>
        </div>

        <div class="d-flex justify-content-center mb-4">
            <div class="nav-pills-wrapper">
                <ul class="nav nav-pills nav-pills-task" id="taskTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="published-tab" data-bs-toggle="tab" data-bs-target="#my-published" type="button">
                            ğŸ“¤ æˆ‘å‘å¸ƒçš„
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="joined-tab" data-bs-toggle="tab" data-bs-target="#my-joined" type="button">
                            ğŸ“¥ æˆ‘å‚ä¸çš„
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <div class="tab-content" id="taskTabsContent">
            
            <div class="tab-pane fade show active" id="my-published" role="tabpanel">
                <div class="d-flex flex-column">
                    {% for task in created_tasks %}
                        <a href="{% url 'tasks:task_detail' task.pk %}" class="text-decoration-none">
                            <div class="card task-card p-3">
                                <div class="row align-items-center">
                                    
                                    <div class="col-md-7 mb-2 mb-md-0">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3 flex-shrink-0">
                                                {% if task.task_type == 'faculty' %}
                                                    <div class="bg-danger bg-opacity-10 text-danger rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; font-size: 1.5rem;">
                                                        <i class="bi bi-megaphone-fill"></i>
                                                    </div>
                                                {% else %}
                                                    <div class="bg-warning bg-opacity-10 text-warning rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; font-size: 1.5rem;">
                                                        <i class="bi bi-trophy-fill"></i>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="min-width-0">
                                                <h5 class="fw-bold text-dark mb-1 text-truncate">{{ task.title }}</h5>
                                                <div class="text-muted small">
                                                    <i class="bi bi-clock"></i> å‘å¸ƒäº {{ task.created_at|date:"Y-m-d" }}
                                                    <span class="mx-2">|</span>
                                                    <i class="bi bi-people"></i> {{ task.participants.count }} äººå‚ä¸
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-5 text-md-end">
                                        <div class="d-flex flex-md-column align-items-center align-items-md-end justify-content-between h-100">
                                            
                                            <div class="mb-md-2">
                                                {% if task.task_type == 'faculty' %}
                                                    <span class="faculty-tag me-2">å¯¼å¸ˆæŒ‡ä»¤</span>
                                                {% else %}
                                                    <span class="bounty-tag me-2">ğŸª™ {{ task.bounty }}</span>
                                                {% endif %}
                                                
                                                {% if task.status == 'open' %}
                                                    <span class="status-badge bg-success bg-opacity-10 text-success border border-success">æ‹›å‹Ÿä¸­</span>
                                                {% elif task.status == 'in_progress' %}
                                                    <span class="status-badge bg-primary bg-opacity-10 text-primary border border-primary">è¿›è¡Œä¸­</span>
                                                {% elif task.status == 'closed' %}
                                                    <span class="status-badge bg-secondary bg-opacity-10 text-secondary border border-secondary">å·²ç»“æŸ</span>
                                                {% endif %}
                                            </div>

                                            <div class="small text-muted d-none d-md-block">
                                                {% if task.status == 'closed' %}
                                                    è·èƒœè€…: <span class="fw-bold text-dark">{{ task.winner.nickname|default:"æ— " }}</span>
                                                {% else %}
                                                    ç‚¹å‡»ç®¡ç†ä»»åŠ¡ &raquo;
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </a>
                    {% empty %}
                        <div class="text-center py-5">
                            <div class="display-1 mb-3 opacity-25">ğŸ“¤</div>
                            <h4 class="text-muted">ä½ è¿˜æ²¡æœ‰å‘å¸ƒè¿‡ä»»åŠ¡</h4>
                            <p class="text-secondary mb-4">æœ‰å›°éš¾éœ€è¦å¸®åŠ©ï¼Ÿæˆ–è€…æƒ³ç»™å¸ˆå¼Ÿå¸ˆå¦¹æ´¾æ´»ï¼Ÿ</p>
                            <a href="{% url 'tasks:task_create' %}" class="btn btn-warning text-white rounded-pill px-4 shadow-sm fw-bold">ç«‹å³å‘å¸ƒ</a>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="tab-pane fade" id="my-joined" role="tabpanel">
                <div class="d-flex flex-column">
                    {% for record in my_participations %}
                        <a href="{% url 'tasks:task_detail' record.task.pk %}" class="text-decoration-none">
                            <div class="card task-card p-3">
                                <div class="row align-items-center">
                                    
                                    <div class="col-md-7 mb-2 mb-md-0">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3 flex-shrink-0">
                                                {% if record.task.creator.avatar %}
                                                    <img src="{{ record.task.creator.avatar.url }}" class="rounded-circle border" width="50" height="50" style="object-fit:cover;">
                                                {% else %}
                                                    <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center fw-bold" style="width:50px; height:50px;">
                                                        {{ record.task.creator.username.0|upper }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="min-width-0">
                                                <h5 class="fw-bold text-dark mb-1 text-truncate">{{ record.task.title }}</h5>
                                                <div class="small text-secondary">
                                                    <span class="fw-bold">{{ record.task.creator.nickname }}</span> å‘å¸ƒ
                                                    {% if record.task.task_type == 'faculty' %}
                                                        <span class="badge bg-danger rounded-pill ms-1" style="font-size: 0.6rem;">å¿…ä¿®</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-5 text-md-end">
                                        <div class="d-flex flex-md-column align-items-center align-items-md-end justify-content-between h-100">
                                            
                                            <div class="mb-md-2 font-monospace small">
                                                {% if record.task.status == 'closed' %}
                                                    <span class="text-muted">ğŸ ä»»åŠ¡å·²ç»“æŸ</span>
                                                {% elif record.task.is_overdue %}
                                                    <span class="text-secondary fw-bold">ğŸ›‘ å·²æˆªæ­¢</span>
                                                {% else %}
                                                    <span class="countdown-timer text-danger fw-bold bg-danger bg-opacity-10 px-2 py-1 rounded" 
                                                          data-deadline="{{ record.task.deadline|date:'c' }}">
                                                        è®¡ç®—ä¸­...
                                                    </span>
                                                {% endif %}
                                            </div>

                                            <div>
                                                {% if record.status == 'invited' %}
                                                    <span class="badge bg-info text-dark border">ğŸ“© é‚€è¯·å‡½</span>
                                                {% elif record.status == 'accepted' %}
                                                    <span class="badge bg-success border border-success">âœ… è¿›è¡Œä¸­</span>
                                                {% elif record.status == 'rejected' %}
                                                    <span class="badge bg-secondary border">ğŸš« å·²æ‹’ç»</span>
                                                {% elif record.status == 'quit' %}
                                                    <span class="badge bg-dark border">ğŸ³ï¸ å·²é€€å‡º</span>
                                                {% endif %}
                                            </div>

                                        </div>
                                    </div>

                                </div>
                            </div>
                        </a>
                    {% empty %}
                        <div class="text-center py-5">
                            <div class="display-1 mb-3 opacity-25">ğŸ“¥</div>
                            <h4 class="text-muted">æš‚æ— å‚ä¸çš„ä»»åŠ¡</h4>
                            <p class="text-secondary">å»â€œå¤§å…â€çœ‹çœ‹æœ‰æ²¡æœ‰æœ€æ–°çš„æ‚¬èµå§ï¼</p>
                        </div>
                    {% endfor %}
                </div>
            </div>

        </div>

    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const timers = document.querySelectorAll('.countdown-timer');
        
        function updateTimers() {
            timers.forEach(timer => {
                const deadline = new Date(timer.dataset.deadline).getTime();
                const now = new Date().getTime();
                const distance = deadline - now;
                
                if (distance < 0) {
                    timer.innerHTML = 'ğŸ›‘ å·²æˆªæ­¢';
                    timer.className = 'text-secondary fw-bold';
                    return;
                }
                
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                
                let timeStr = 'â³ å‰©ä½™: ';
                if (days > 0) timeStr += `${days}å¤© `;
                timeStr += `${hours}æ—¶${minutes}åˆ†`;
                
                timer.innerHTML = timeStr;
            });
        }
        
        if (timers.length > 0) {
            setInterval(updateTimers, 60000); // åˆ—è¡¨é¡µæ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡å³å¯
            updateTimers();
        }
    });
</script>
{% endblock %}