{% extends 'base.html' %}

{% block title %}å‘å¸ƒä»»åŠ¡{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/vditor/dist/index.css" />
<script src="https://unpkg.com/vditor/dist/index.min.js"></script>

<style>
    /* === ä»»åŠ¡å‘å¸ƒé¡µä¸“ç”¨æ ·å¼ === */

    /* 1. æ•´ä½“å¸ƒå±€ */
    .form-section {
        background: #fff;
        border: 1px solid #f0f0f0;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.02);
    }
    .section-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: #495057;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* 2. äººå‘˜é€‰æ‹©å™¨ (Grid Card) */
    .user-select-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
        max-height: 250px;
        overflow-y: auto;
        padding: 5px;
    }
    
    /* éšè—åŸç”Ÿ checkbox */
    .user-select-card input[type="checkbox"] {
        display: none;
    }
    
    .user-select-card {
        display: block;
        cursor: pointer;
        position: relative;
    }

    .user-card-inner {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        transition: all 0.2s ease;
        background: #fff;
    }
    
    .user-card-inner:hover {
        border-color: #ced4da;
        background-color: #f8f9fa;
    }

    /* é€‰ä¸­çŠ¶æ€ */
    .user-select-card input:checked + .user-card-inner {
        border-color: #0d6efd;
        background-color: #f0f7ff;
        box-shadow: 0 0 0 1px #0d6efd;
    }
    
    .user-card-inner .check-icon {
        position: absolute;
        top: 5px;
        right: 5px;
        color: #0d6efd;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .user-select-card input:checked + .user-card-inner .check-icon {
        opacity: 1;
    }

    /* 3. èµé‡‘è¾“å…¥æ¡† */
    .bounty-input-group .input-group-text {
        background-color: #fff8e1;
        border-color: #ffe69c;
        color: #d4a017;
        font-weight: bold;
    }
    .bounty-input-group .form-control:focus {
        border-color: #ffe69c;
        box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, 0.25);
    }

    /* 4. æ»šåŠ¨æ¡ç¾åŒ– */
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #dee2e6; border-radius: 3px; }
</style>

<div class="row justify-content-center">
    <div class="col-lg-9">
        
        <div class="d-flex align-items-center mb-4">
            <a href="{% url 'tasks:my_tasks' %}" class="btn btn-light rounded-circle shadow-sm me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-arrow-left"></i>
            </a>
            <div>
                <h4 class="fw-bold mb-0">ğŸš€ å‘å¸ƒæ–°ä»»åŠ¡</h4>
                <small class="text-muted">åˆ›å»ºæŒ‘æˆ˜ï¼Œé‚€è¯·ä¼™ä¼´ï¼Œå…±åŒè¿›æ­¥</small>
            </div>
        </div>

        <form method="post" id="taskForm">
            {% csrf_token %}

            {% if form.errors %}
                <div class="alert alert-danger shadow-sm border-0 rounded-3 mb-4">
                    <i class="bi bi-exclamation-circle-fill me-2"></i> <strong>æäº¤å—é˜»ï¼š</strong> è¯·æ£€æŸ¥ä¸‹æ–¹çº¢è‰²æç¤ºé¡¹ã€‚
                    {{ form.non_field_errors }}
                </div>
            {% endif %}

            <div class="form-section">
                <div class="section-title"><i class="bi bi-card-heading text-primary"></i> ä»»åŠ¡åŸºç¡€</div>
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label small fw-bold text-muted">ä»»åŠ¡æ ‡é¢˜</label>
                        {{ form.title }}
                        {% if form.title.errors %}<div class="text-danger small mt-1">{{ form.title.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold text-muted">ç±»å‹</label>
                        {{ form.task_type }}
                        {% if user.status != 'faculty' %}
                            <input type="text" class="form-control" value="ğŸ’° æ‚¬èµä»»åŠ¡" disabled>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="form-section" id="bounty-deadline-section">
                <div class="section-title"><i class="bi bi-hourglass-split text-warning"></i> èµé‡‘ä¸æ—¶é™</div>
                <div class="row g-3">
                    <div class="col-md-6" id="bounty-col">
                        <label class="form-label small fw-bold text-muted">æ‚¬èµé‡‘å¸ (Bounty)</label>
                        <div class="input-group bounty-input-group">
                            <span class="input-group-text">ğŸª™</span>
                            {{ form.bounty }}
                            <span class="input-group-text bg-light text-secondary fw-normal border-start-0">ä½™é¢: {{ user.coins }}</span>
                        </div>
                        {% if form.bounty.errors %}<div class="text-danger small mt-1">{{ form.bounty.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">æˆªæ­¢æ—¶é—´ (Deadline)</label>
                        {{ form.deadline }}
                        {% if form.deadline.errors %}<div class="text-danger small mt-1">{{ form.deadline.errors.0 }}</div>{% endif %}
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title"><i class="bi bi-people-fill text-success"></i> é€‰æ‹©æ‰§è¡Œäºº</div>
                
                {% if user.status == 'faculty' %}
                <div class="bg-light p-3 rounded-3 mb-3 border border-primary border-opacity-25">
                    <label class="form-label fw-bold text-primary mb-2">ğŸ« æŒ‰ç­çº§ç¾¤å‘ (å¼ºåˆ¶æŒ‡æ´¾)</label>
                    {{ form.target_class }}
                    <div class="form-text mt-1 text-muted small">
                        <i class="bi bi-info-circle"></i> é€‰ä¸­ç­çº§åï¼Œç­å†…æ‰€æœ‰å­¦ç”Ÿå°†<b>è‡ªåŠ¨åŠ å…¥</b>å¹¶å¼ºåˆ¶æ¥å—ä»»åŠ¡ã€‚
                    </div>
                </div>
                {% endif %}

                <label class="form-label small fw-bold text-muted mb-2">
                    {% if user.status == 'faculty' %}â• é¢å¤–æ·»åŠ ä¸ªäºº (å¯é€‰){% else %}é€‰æ‹©é‚€è¯·å¯¹è±¡ (å¿…é€‰){% endif %}
                </label>
                
                <div class="user-select-grid custom-scroll border rounded-3 bg-light">
                    {% for checkbox in form.invitees %}
                        <label class="user-select-card">
                            {{ checkbox.tag }}
                            <div class="user-card-inner">
                                <i class="bi bi-check-circle-fill check-icon"></i>
                                <div class="fw-bold text-dark text-truncate">{{ checkbox.choice_label }}</div>
                                <div class="small text-muted" style="font-size: 0.7rem;">ç‚¹å‡»é€‰æ‹©</div>
                            </div>
                        </label>
                    {% empty %}
                        <div class="text-center py-4 text-muted w-100 grid-column-full">
                            æš‚æ— å¯é‚€è¯·çš„ç”¨æˆ·ï¼Œè¯·å…ˆç­‰å¾…æ›´å¤šæˆå‘˜åŠ å…¥ã€‚
                        </div>
                    {% endfor %}
                </div>
                {% if form.invitees.errors %}<div class="text-danger small mt-1">{{ form.invitees.errors.0 }}</div>{% endif %}
            </div>

            <div class="form-section">
                <div class="section-title"><i class="bi bi-file-text-fill text-secondary"></i> ä»»åŠ¡è¯¦æƒ…</div>
                <div id="vditor" style="min-height: 400px;"></div>
                <textarea name="content" id="hiddenContent" style="display:none;">{{ form.content.value|default:'' }}</textarea>
                {% if form.content.errors %}<div class="text-danger small mt-1">{{ form.content.errors.0 }}</div>{% endif %}
            </div>

            <div class="d-grid gap-2 mb-5">
                <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow-sm fw-bold py-3">
                    ğŸš€ ç¡®è®¤å‘å¸ƒä»»åŠ¡
                </button>
                <a href="{% url 'tasks:my_tasks' %}" class="btn btn-link text-muted">å–æ¶ˆ</a>
            </div>

        </form>
    </div>
</div>

<script>
    // Vditor åˆå§‹åŒ–
    const vditor = new Vditor('vditor', {
        height: 400,
        placeholder: 'åœ¨æ­¤è¾“å…¥ä»»åŠ¡è¯¦ç»†è¦æ±‚ã€éªŒæ”¶æ ‡å‡†ç­‰...',
        cache: { enable: false },
        value: document.getElementById('hiddenContent').value, // å›æ˜¾å†…å®¹
        preview: { math: { engine: 'KaTeX' } },
        toolbar: ['emoji', 'headings', 'bold', 'italic', 'strike', 'link', '|', 'list', 'ordered-list', 'check', 'outdent', 'indent', '|', 'quote', 'line', 'code', 'inline-code', 'insert-before', 'insert-after', '|', 'upload', 'table', 'edit-mode'],
        upload: {
            accept: 'image/jpg, image/jpeg, image/png, image/gif',
            url: '{% url "community:upload_image" %}',
            linkToImgUrl: '{% url "community:upload_image" %}',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            fieldName: 'file[]',
            format(files, responseText) {
                const res = JSON.parse(responseText);
                return JSON.stringify({
                    msg: res.msg, code: res.code,
                    data: { errFiles: [], succMap: { [files[0].name]: res.data.succMap[files[0].name] } }
                });
            }
        }
    });

    // è¡¨å•æäº¤æ‹¦æˆª
    document.getElementById('taskForm').addEventListener('submit', function(e) {
        const content = vditor.getValue();
        if (!content.trim()) {
            e.preventDefault();
            alert("è¯·å¡«å†™ä»»åŠ¡è¯¦æƒ…å†…å®¹");
            return;
        }
        document.getElementById('hiddenContent').value = content;
    });

    // å¯¼å¸ˆç±»å‹è”åŠ¨é€»è¾‘
    const typeSelect = document.getElementById('id_task_type');
    const bountyInput = document.getElementById('id_bounty');
    const bountySection = document.getElementById('bounty-deadline-section');
    const bountyCol = document.getElementById('bounty-col');

    if (typeSelect) {
        function toggleBounty() {
            if (typeSelect.value === 'faculty') {
                // å¯¼å¸ˆæ¨¡å¼ï¼šèµé‡‘å½’é›¶å¹¶ç¦ç”¨
                bountyInput.value = 0;
                bountyInput.readOnly = true;
                bountyCol.style.opacity = '0.5';
                bountyCol.style.pointerEvents = 'none';
            } else {
                // æ‚¬èµæ¨¡å¼ï¼šæ¢å¤
                bountyCol.style.opacity = '1';
                bountyCol.style.pointerEvents = 'auto';
                bountyInput.readOnly = false;
            }
        }
        toggleBounty();
        typeSelect.addEventListener('change', toggleBounty);
    }
</script>
{% endblock %}