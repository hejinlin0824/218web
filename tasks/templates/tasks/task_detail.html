{% extends 'base.html' %}
{% load community_extras %}

{% block title %}{{ task.title }} - ä»»åŠ¡è¯¦æƒ…{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/vditor/dist/index.css" />
<script src="https://unpkg.com/vditor/dist/method.min.js"></script>

<style>
    /* === ä»»åŠ¡è¯¦æƒ…é¡µä¸“ç”¨æ ·å¼ === */
    
    /* 1. é¡¶éƒ¨çŠ¶æ€æ¨ªå¹… */
    .status-banner {
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    /* 2. å³ä¾§å¸é¡¶å¡ç‰‡ */
    .sticky-sidebar {
        position: sticky;
        top: 100px;
        z-index: 10;
    }
    
    /* 3. æ‚¬èµå¡ç‰‡ */
    .bounty-card {
        background: linear-gradient(135deg, #fff8e1 0%, #fff 100%);
        border: 1px solid #ffe69c;
    }
    .faculty-card {
        background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
        border: 1px solid #fadbd8;
    }

    /* 4. å‚ä¸è€…è¡¨æ ¼ä¼˜åŒ– */
    .participant-table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #eee;
        color: #6c757d;
        font-size: 0.85rem;
        text-transform: uppercase;
        vertical-align: middle;
    }
    .participant-row {
        transition: background-color 0.2s;
    }
    .participant-row:hover {
        background-color: #f8f9fa;
    }
    
    /* ğŸ”¥ ä¿®å¤ï¼šå•é€‰æ¡†æ ·å¼å¢å¼º */
    .custom-radio {
        transform: scale(1.3); /* æ”¾å¤§ 1.3 å€ */
        cursor: pointer;
        border-color: #adb5bd;
    }
    .custom-radio:checked {
        background-color: #ffc107; /* é€‰ä¸­å˜æˆé†’ç›®çš„é»„è‰² */
        border-color: #ffc107;
    }
    
    /* å¤´åƒå¾®è°ƒ */
    .avatar-xs {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        object-fit: cover;
        vertical-align: middle;
        border: 1px solid #dee2e6;
    }
    
    /* Vditor é˜…è¯»ä¼˜åŒ– */
    .vditor-reset {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif !important;
        font-size: 16px !important;
        line-height: 1.8 !important;
        color: #212529 !important;
    }
</style>

<div class="row g-4 justify-content-center">
    
    <div class="col-lg-8">
        
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'tasks:my_tasks' %}" class="text-decoration-none">ä»»åŠ¡ä¸­å¿ƒ</a></li>
                <li class="breadcrumb-item active" aria-current="page">ä»»åŠ¡è¯¦æƒ…</li>
            </ol>
        </nav>

        {% if task.status == 'closed' %}
            <div class="status-banner bg-secondary text-white shadow-sm">
                <div>
                    <h5 class="mb-0 fw-bold"><i class="bi bi-flag-fill me-2"></i> ä»»åŠ¡å·²ç»“æŸ</h5>
                    {% if task.winner %}
                        <small class="opacity-75">è·èƒœè€…: {{ task.winner.nickname|default:task.winner.username }}</small>
                    {% else %}
                        <small class="opacity-75">æœ¬æ¬¡ä»»åŠ¡æœªäº§ç”Ÿè·èƒœè€…</small>
                    {% endif %}
                </div>
                <span class="badge bg-white text-secondary">Closed</span>
            </div>
        {% elif task.is_overdue %}
            <div class="status-banner bg-danger text-white shadow-sm">
                <div>
                    <h5 class="mb-0 fw-bold"><i class="bi bi-stop-circle-fill me-2"></i> ä»»åŠ¡å·²æˆªæ­¢</h5>
                    <small class="opacity-75">æˆªæ­¢æ—¶é—´: {{ task.deadline|date:"Y-m-d H:i" }}</small>
                </div>
                <span class="badge bg-white text-danger">Overdue</span>
            </div>
        {% endif %}

        <div class="card shadow-sm border-0 rounded-4 mb-4">
            <div class="card-body p-4 p-md-5">
                
                <div class="mb-4 pb-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="mb-2">
                                {% if task.task_type == 'faculty' %}
                                    <span class="badge bg-danger rounded-pill">ğŸš¨ å¯¼å¸ˆæŒ‡ä»¤</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark rounded-pill">ğŸ’° æ‚¬èµä»»åŠ¡</span>
                                {% endif %}
                                <span class="badge bg-light text-secondary border ms-1">{{ task.get_status_display }}</span>
                            </div>
                            <h2 class="fw-bold text-dark mb-2">{{ task.title }}</h2>
                            <div class="d-flex align-items-center text-muted small">
                                <a href="{% url 'user_app:public_profile' task.creator.pk %}" class="text-decoration-none text-muted d-flex align-items-center">
                                    {% if task.creator.avatar %}
                                        <img src="{{ task.creator.avatar.url }}" class="avatar-xs me-2">
                                    {% else %}
                                        <div class="avatar-xs bg-secondary text-white d-flex align-items-center justify-content-center me-2 fw-bold" style="font-size: 0.6rem;">{{ task.creator.username.0|upper }}</div>
                                    {% endif %}
                                    <span class="fw-bold">{{ task.creator.nickname|default:task.creator.username }}</span>
                                </a>
                                <span class="mx-2">Â·</span>
                                <span>å‘å¸ƒäº {{ task.created_at|date:"Y-m-d H:i" }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="task-content" class="vditor-reset"></div>
                <div id="raw-content" class="d-none">{{ task.content }}</div>

            </div>
        </div>

        {% if is_creator %}
        <div class="card shadow-sm border-0 border-start border-5 border-primary rounded-4 mb-4" id="creator-console">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold text-primary">ğŸ‘‘ ç®¡ç†æ§åˆ¶å°</h5>
            </div>
            <div class="card-body p-4">
                
                {% if task.status == 'closed' %}
                    <div class="text-center py-4 text-muted">
                        <div class="fs-1 mb-2">ğŸ</div>
                        <p>ä»»åŠ¡å·²å½’æ¡£ï¼Œæ— æ³•è¿›è¡Œæ“ä½œã€‚</p>
                        {% if task.winner %}
                            <div class="alert alert-success d-inline-block px-4">
                                ğŸ† MVP: <strong>{{ task.winner.nickname|default:task.winner.username }}</strong>
                            </div>
                        {% endif %}
                    </div>
                {% else %}
                    <h6 class="fw-bold mb-3">ğŸ‘¥ å‚ä¸è€…åå•</h6>
                    <p class="text-muted small mb-3">è¯·åœ¨ä»»åŠ¡å®Œæˆåï¼Œé€‰æ‹©ä¸€ä½è´¡çŒ®æœ€å¤§çš„æˆå‘˜ä½œä¸º MVP å¹¶ç»“ç®—èµé‡‘ã€‚ç»“ç®—åä»»åŠ¡å°†è‡ªåŠ¨å…³é—­ã€‚</p>
                    
                    <form method="post" action="{% url 'tasks:settle_task' task.pk %}" onsubmit="return confirm('ç¡®å®šè¦ç»“æŸä»»åŠ¡å¹¶å°†èµé‡‘è½¬ç»™è¯¥ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')">
                        {% csrf_token %}
                        <div class="table-responsive rounded-3 border mb-3">
                            <table class="table table-hover align-middle mb-0 participant-table">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4 text-nowrap" style="width: 80px;">é€‰å®š</th>
                                        <th>æˆå‘˜</th>
                                        <th>çŠ¶æ€</th>
                                        <th>åŠ å…¥æ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for p in all_participants %}
                                    <tr class="participant-row {% if p.status == 'quit' or p.status == 'rejected' %}opacity-50 bg-light{% endif %}">
                                        <td class="ps-4">
                                            <input type="radio" name="winner_id" value="{{ p.user.id }}" 
                                                   class="form-check-input custom-radio" required 
                                                   {% if p.status != 'accepted' %}disabled{% endif %}>
                                        </td>
                                        <td>
                                            <a href="{% url 'user_app:public_profile' p.user.pk %}" class="text-decoration-none text-dark d-flex align-items-center">
                                                {% if p.user.avatar %}
                                                    <img src="{{ p.user.avatar.url }}" class="avatar-xs me-2">
                                                {% else %}
                                                    <div class="avatar-xs bg-secondary text-white d-flex align-items-center justify-content-center me-2 small">{{ p.user.username.0|upper }}</div>
                                                {% endif %}
                                                <span class="fw-bold">{{ p.user.nickname|default:p.user.username }}</span>
                                            </a>
                                        </td>
                                        <td>
                                            {% if p.status == 'invited' %}<span class="badge bg-secondary">æœªå“åº”</span>
                                            {% elif p.status == 'accepted' %}<span class="badge bg-success">è¿›è¡Œä¸­</span>
                                            {% elif p.status == 'rejected' %}<span class="badge bg-danger">å·²æ‹’ç»</span>
                                            {% elif p.status == 'quit' %}<span class="badge bg-dark">å·²é€€å‡º</span>
                                            {% endif %}
                                        </td>
                                        <td class="small text-muted">{{ p.updated_at|date:"m-d H:i" }}</td>
                                        <td>
                                            <a href="{% url 'direct_messages:chat_room' p.user.pk %}" class="btn btn-sm btn-light border rounded-pill" title="ç§ä¿¡è”ç³»">
                                                <i class="bi bi-chat-text"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center py-4 text-muted">æš‚æ— å‚ä¸è€…</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex justify-content-end align-items-center gap-3">
                            <span class="text-muted small">å…± {{ all_participants|length }} äºº</span>
                            <button type="submit" class="btn btn-warning fw-bold px-4 rounded-pill shadow-sm">
                                {% if task.bounty > 0 %}
                                    ğŸ† ç»“ç®—èµé‡‘ & å…³é—­ä»»åŠ¡
                                {% else %}
                                    ğŸ æ ‡è®°å®Œæˆ & å…³é—­ä»»åŠ¡
                                {% endif %}
                            </button>
                        </div>
                    </form>
                {% endif %}
            </div>
        </div>
        {% endif %}

    </div>

    <div class="col-lg-4">
        <div class="sticky-sidebar">
            
            <div class="card shadow-sm rounded-4 mb-3 {% if task.task_type == 'faculty' %}faculty-card{% else %}bounty-card{% endif %}">
                <div class="card-body text-center p-4">
                    <div class="text-uppercase fw-bold small opacity-75 mb-1">
                        {% if task.task_type == 'faculty' %}ä¼˜å…ˆçº§ / Priority{% else %}ä»»åŠ¡èµé‡‘ / Bounty{% endif %}
                    </div>
                    
                    {% if task.task_type == 'faculty' %}
                        <div class="display-4 fw-bold text-danger mb-2">MAX</div>
                        <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">ğŸ”´ å¿…é¡»å®Œæˆ</span>
                    {% else %}
                        <div class="display-4 fw-bold text-warning mb-2">{{ task.bounty }}</div>
                        <span class="badge bg-warning text-dark border border-warning-subtle">ğŸª™ é‡‘å¸</span>
                    {% endif %}

                    <hr class="my-4 opacity-25">

                    <div class="mb-2 text-muted small fw-bold">è·ç¦»æˆªæ­¢è¿˜æœ‰</div>
                    {% if task.status == 'closed' %}
                        <h5 class="fw-bold text-secondary">å·²ç»“æŸ</h5>
                    {% elif task.is_overdue %}
                        <h5 class="fw-bold text-danger">å·²æˆªæ­¢</h5>
                    {% else %}
                        <h4 class="fw-bold text-dark font-monospace" id="countdown-display">
                            è®¡ç®—ä¸­...
                        </h4>
                        <span id="countdown-data" data-deadline="{{ task.deadline|date:'c' }}"></span>
                    {% endif %}
                </div>
            </div>

            {% if not is_creator %}
            <div class="card shadow-sm border-0 rounded-4 mb-3">
                <div class="card-body p-4">
                    <h6 class="fw-bold mb-3">ğŸ‘‹ ä½ çš„çŠ¶æ€</h6>
                    
                    {% if participant_record %}
                        
                        <div class="text-center mb-4">
                            {% if participant_record.status == 'accepted' %}
                                <div class="mb-2 text-success" style="font-size: 3rem;"><i class="bi bi-check-circle-fill"></i></div>
                                <h5 class="fw-bold text-success">è¿›è¡Œä¸­</h5>
                                <p class="text-muted small">è¯·æŒ‰æ—¶å®Œæˆä»»åŠ¡ï¼Œå¹¶åŠæ—¶å‘å‘èµ·äººæ±‡æŠ¥ã€‚</p>
                            {% elif participant_record.status == 'invited' %}
                                <div class="mb-2 text-primary" style="font-size: 3rem;"><i class="bi bi-envelope-paper-fill"></i></div>
                                <h5 class="fw-bold text-primary">æ”¶åˆ°é‚€è¯·</h5>
                                <p class="text-muted small">å‘èµ·äººé‚€è¯·ä½ å‚ä¸æ­¤ä»»åŠ¡ï¼Œæ˜¯å¦æ¥å—ï¼Ÿ</p>
                            {% elif participant_record.status == 'quit' %}
                                <div class="mb-2 text-secondary" style="font-size: 3rem;"><i class="bi bi-x-circle-fill"></i></div>
                                <h5 class="fw-bold text-secondary">å·²é€€å‡º</h5>
                            {% endif %}
                        </div>

                        <div class="d-grid gap-2">
                            {% if participant_record.status == 'invited' %}
                                {% if task.task_type == 'faculty' %}
                                    <div class="alert alert-warning small border-0 mb-0">
                                        <i class="bi bi-exclamation-triangle"></i> å¯¼å¸ˆæŒ‡æ´¾ä»»åŠ¡ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨æ¥å—ã€‚
                                    </div>
                                    <a href="{% url 'direct_messages:chat_room' task.creator.pk %}" class="btn btn-primary rounded-pill">
                                        <i class="bi bi-chat-text"></i> æ±‡æŠ¥è¿›å±•
                                    </a>
                                {% else %}
                                    <a href="{% url 'tasks:handle_invite' task.pk 'accept' %}" class="btn btn-success fw-bold rounded-pill shadow-sm">
                                        æ¥å—æŒ‘æˆ˜
                                    </a>
                                    <a href="{% url 'tasks:handle_invite' task.pk 'reject' %}" class="btn btn-outline-secondary rounded-pill">
                                        å©‰è¨€æ‹’ç»
                                    </a>
                                {% endif %}
                            {% elif participant_record.status == 'accepted' %}
                                <a href="{% url 'direct_messages:chat_room' task.creator.pk %}" class="btn btn-primary rounded-pill shadow-sm">
                                    <i class="bi bi-chat-text"></i> è”ç³»å‘èµ·äºº
                                </a>
                                {% if task.task_type != 'faculty' %}
                                    <a href="{% url 'tasks:handle_invite' task.pk 'quit' %}" class="btn btn-outline-danger rounded-pill btn-sm mt-2" onclick="return confirm('ç¡®å®šè¦æ”¾å¼ƒä»»åŠ¡å—ï¼Ÿ')">
                                        æ”¾å¼ƒä»»åŠ¡
                                    </a>
                                {% endif %}
                            {% endif %}
                        </div>

                    {% else %}
                        <div class="text-center text-muted">
                            <p class="mb-0">æ‚¨æœªå‚ä¸æ­¤ä»»åŠ¡ã€‚</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if is_creator %}
            <div class="card shadow-sm border-0 rounded-4 mb-3 bg-light">
                <div class="card-body p-3">
                    <h6 class="fw-bold mb-3 text-secondary">ğŸ› ï¸ ä»»åŠ¡ç®¡ç†</h6>
                    <div class="d-grid gap-2">
                        <a href="{% url 'tasks:task_delete' task.pk %}" 
                           class="btn btn-outline-danger rounded-pill text-start ps-3"
                           onclick="return confirm('ç¡®å®šè¦æ’¤é”€æ­¤ä»»åŠ¡å—ï¼Ÿ\nå¦‚æœä»»åŠ¡æœªç»“æŸï¼Œé¢„æ‰£çš„é‡‘å¸å°†é€€è¿˜ã€‚')">
                            <i class="bi bi-trash3 me-2"></i> æ’¤é”€/åˆ é™¤ä»»åŠ¡
                        </a>
                        <button class="btn btn-outline-dark rounded-pill text-start ps-3" disabled>
                            <i class="bi bi-pencil-square me-2"></i> ç¼–è¾‘ä»»åŠ¡ (å¼€å‘ä¸­)
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
            
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        
        // 1. æ¸²æŸ“ Markdown å†…å®¹
        const text = document.getElementById('raw-content').textContent;
        Vditor.preview(document.getElementById('task-content'), text, {
            mode: 'light',
            anchor: 1,
        });

        // 2. å€’è®¡æ—¶é€»è¾‘ (å¼ºåŒ–ç‰ˆ)
        const timerSpan = document.getElementById('countdown-display');
        const timerData = document.getElementById('countdown-data');
        
        if (timerSpan && timerData) {
            const deadline = new Date(timerData.dataset.deadline).getTime();

            function updateTimer() {
                const now = new Date().getTime();
                const distance = deadline - now;

                if (distance < 0) {
                    timerSpan.innerHTML = "å·²æˆªæ­¢";
                    timerSpan.className = "text-danger fw-bold";
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                let timeStr = '';
                if (days > 0) timeStr += `<span class="h4">${days}</span><span class="small text-muted me-2">å¤©</span>`;
                timeStr += `<span class="h4">${hours.toString().padStart(2, '0')}</span><span class="small text-muted me-1">:</span>`;
                timeStr += `<span class="h4">${minutes.toString().padStart(2, '0')}</span><span class="small text-muted me-1">:</span>`;
                timeStr += `<span class="h4 text-danger">${seconds.toString().padStart(2, '0')}</span>`;

                timerSpan.innerHTML = timeStr;
            }

            setInterval(updateTimer, 1000);
            updateTimer();
        }
    });
</script>
{% endblock %}