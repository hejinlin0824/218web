{% extends 'base.html' %}

{% block title %}{{ task.title }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/vditor/dist/index.css" />
<script src="https://unpkg.com/vditor/dist/method.min.js"></script>

<div class="row justify-content-center">
    <div class="col-md-9">
        
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h2 class="fw-bold mb-2">
                            {% if task.task_type == 'faculty' %}
                                <span class="text-danger">[å¯¼å¸ˆæŒ‡ä»¤]</span>
                            {% endif %}
                            {{ task.title }}
                        </h2>
                        <div class="d-flex gap-3 text-muted small mb-3">
                            <span>å‘å¸ƒäºº: <a href="{% url 'user_app:public_profile' task.creator.pk %}">{{ task.creator.nickname|default:task.creator.username }}</a></span>
                            <span>å‘å¸ƒäº: {{ task.created_at|date:"Y-m-d" }}</span>
                            
                            <span>
                                {% if task.status == 'closed' %}
                                    <span class="text-secondary fw-bold">ğŸ ä»»åŠ¡å·²ç»“æŸ</span>
                                {% elif task.is_overdue %}
                                    <span class="text-secondary fw-bold">ğŸ›‘ å·²æˆªæ­¢ ({{ task.deadline|date:"m-d H:i" }})</span>
                                {% else %}
                                    â³ å‰©ä½™: 
                                    <span id="countdown-timer" 
                                          data-deadline="{{ task.deadline|date:'c' }}" 
                                          class="text-danger fw-bold font-monospace">
                                        è®¡ç®—ä¸­...
                                    </span>
                                {% endif %}
                            </span>
                            </div>
                    </div>
                    <div class="text-end">
                        {% if task.task_type == 'faculty' %}
                            <div class="badge bg-danger fs-6 mb-2">ä¼˜å…ˆçº§: MAX</div>
                        {% else %}
                            <div class="display-6 fw-bold text-warning">ğŸª™ {{ task.bounty }}</div>
                        {% endif %}
                        <div class="badge bg-light text-dark border d-block">{{ task.get_status_display }}</div>
                    </div>
                </div>
                
                <hr>
                
                <div id="task-content" class="vditor-reset fs-5"></div>
                <div id="raw-content" style="display:none;">{{ task.content }}</div>
            </div>
        </div>

        {% if is_creator %}
            <div class="card shadow-sm border-0 border-start border-5 border-primary mb-4">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                    <span>ğŸ‘‘ å‘èµ·äººç®¡ç†æ§åˆ¶å°</span>
                    <a href="{% url 'tasks:task_delete' task.pk %}" 
                       class="btn btn-sm btn-outline-danger"
                       onclick="return confirm('ç¡®å®šè¦æ’¤é”€æ­¤ä»»åŠ¡å—ï¼Ÿ\nå¦‚æœä»»åŠ¡æœªç»“æŸï¼Œé¢„æ‰£çš„é‡‘å¸å°†é€€è¿˜ã€‚')">
                        ğŸ—‘ï¸ æ’¤é”€/åˆ é™¤ä»»åŠ¡
                    </a>
                </div>
                <div class="card-body">
                    {% if task.status == 'closed' %}
                        <div class="alert alert-success">
                            ğŸ ä»»åŠ¡å·²ç»“æŸã€‚è·èƒœè€…ï¼š
                            {% if task.winner %}
                                <a href="{% url 'user_app:public_profile' task.winner.pk %}" class="fw-bold">{{ task.winner.nickname|default:task.winner.username }}</a>
                            {% else %}
                                <span class="text-muted">æ—  (ç›´æ¥å…³é—­)</span>
                            {% endif %}
                        </div>
                    {% else %}
                        <h6 class="mb-3">å‚ä¸è€…åå• (è¯·åœ¨ä»»åŠ¡å®Œæˆåé€‰æ‹©ä¸€ä½ MVP è¿›è¡Œæ‰“èµç»“ç®—)</h6>
                        
                        <form method="post" action="{% url 'tasks:settle_task' task.pk %}" onsubmit="return confirm('ç¡®å®šè¦ç»“æŸä»»åŠ¡å¹¶å°†èµé‡‘è½¬ç»™è¯¥ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')">
                            {% csrf_token %}
                            <div class="table-responsive mb-3">
                                <table class="table table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>é€‰æ‹©</th>
                                            <th>å‚ä¸è€…</th>
                                            <th>å½“å‰çŠ¶æ€</th>
                                            <th>åŠ å…¥æ—¶é—´</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for p in all_participants %}
                                        <tr class="{% if p.status == 'quit' or p.status == 'rejected' %}text-muted opacity-50{% endif %}">
                                            <td>
                                                <input type="radio" name="winner_id" value="{{ p.user.id }}" 
                                                       class="form-check-input" required 
                                                       {% if p.status != 'accepted' %}disabled{% endif %}>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    {% if p.user.avatar %}
                                                        <img src="{{ p.user.avatar.url }}" width="30" height="30" class="rounded-circle me-2" style="object-fit: cover;">
                                                    {% else %}
                                                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2" 
                                                             style="width: 30px; height: 30px; font-size: 0.8rem; font-weight: bold;">
                                                            {{ p.user.username.0|upper }}
                                                        </div>
                                                    {% endif %}
                                                    <a href="{% url 'user_app:public_profile' p.user.pk %}" class="text-decoration-none text-dark">
                                                        {{ p.user.nickname|default:p.user.username }}
                                                    </a>
                                                </div>
                                            </td>
                                            <td>
                                                {% if p.status == 'invited' %}<span class="badge bg-secondary">æœªå“åº”</span>
                                                {% elif p.status == 'accepted' %}<span class="badge bg-success">è¿›è¡Œä¸­</span>
                                                {% elif p.status == 'rejected' %}<span class="badge bg-danger">å·²æ‹’ç»</span>
                                                {% elif p.status == 'quit' %}<span class="badge bg-dark">å·²é€€å‡º</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ p.updated_at|date:"m-d" }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">æš‚æ— å‚ä¸è€…</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="d-flex justify-content-end gap-2">
                                <button type="submit" class="btn btn-warning fw-bold">
                                    {% if task.bounty > 0 %}
                                        ğŸ† é€‰å®š MVP å¹¶ç»“ç®—èµé‡‘
                                    {% else %}
                                        ğŸ æ ‡è®°ä»»åŠ¡å®Œæˆ
                                    {% endif %}
                                </button>
                            </div>
                        </form>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {% if participant_record and not is_creator %}
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body text-center p-4">
                    <h5 class="mb-3">æ‚¨çš„å½“å‰çŠ¶æ€ï¼š
                        {% if participant_record.status == 'accepted' %}
                            <span class="badge bg-success">âœ… è¿›è¡Œä¸­</span>
                        {% elif participant_record.status == 'invited' %}
                            <span class="badge bg-info text-dark">ğŸ“© å¾…å›åº”</span>
                        {% elif participant_record.status == 'quit' %}
                            <span class="badge bg-dark">ğŸ³ï¸ å·²é€€å‡º</span>
                        {% endif %}
                    </h5>
                    
                    {% if task.status == 'closed' %}
                        <p class="text-muted">ğŸ ä»»åŠ¡å·²ç»“æŸã€‚</p>
                    {% else %}
                        {% if participant_record.status == 'invited' %}
                            
                            {% if task.task_type == 'faculty' %}
                                <div class="alert alert-warning">
                                    <strong>ğŸš¨ å¿…ä¿®ä»»åŠ¡</strong><br>
                                    è¿™æ˜¯å¯¼å¸ˆç›´æ¥æŒ‡æ´¾çš„ä»»åŠ¡ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨ä¸ºæ‚¨æ¥å—ã€‚è¯·æŒ‰æ—¶å®Œæˆã€‚
                                </div>
                                <div class="d-flex justify-content-center">
                                    <a href="{% url 'direct_messages:chat_room' task.creator.pk %}" class="btn btn-primary rounded-pill">ğŸ’¬ æ±‡æŠ¥è¿›å±•</a>
                                </div>
                            {% else %}
                                <p>æ‚¨æ”¶åˆ°äº†æ­¤ä»»åŠ¡çš„é‚€è¯·ï¼Œæ˜¯å¦æ¥å—ï¼Ÿ</p>
                                <div class="d-flex justify-content-center gap-3">
                                    <a href="{% url 'tasks:handle_invite' task.pk 'accept' %}" class="btn btn-success px-4 rounded-pill">âœ… æ¥å—æŒ‘æˆ˜</a>
                                    <a href="{% url 'tasks:handle_invite' task.pk 'reject' %}" class="btn btn-outline-secondary px-4 rounded-pill">ğŸš« å©‰è¨€æ‹’ç»</a>
                                </div>
                            {% endif %}

                        {% elif participant_record.status == 'accepted' %}
                            <p class="text-success">æ‚¨æ­£åœ¨å‚ä¸æ­¤ä»»åŠ¡ï¼ŒåŠ æ²¹ï¼å®Œæˆåè¯·è”ç³»å‘èµ·äººéªŒæ”¶ã€‚</p>
                            <div class="d-flex justify-content-center gap-2">
                                <a href="{% url 'direct_messages:chat_room' task.creator.pk %}" class="btn btn-primary btn-sm rounded-pill">ğŸ’¬ è”ç³»å‘èµ·äºº</a>
                                
                                {% if task.task_type != 'faculty' %}
                                    <a href="{% url 'tasks:handle_invite' task.pk 'quit' %}" class="btn btn-outline-danger btn-sm rounded-pill" onclick="return confirm('ç¡®å®šè¦æ”¾å¼ƒä»»åŠ¡å—ï¼Ÿ')">ğŸ³ï¸ æ”¾å¼ƒä»»åŠ¡</a>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        {% endif %}

    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Vditor æ¸²æŸ“
        const text = document.getElementById('raw-content').textContent;
        Vditor.preview(document.getElementById('task-content'), text, {
            mode: 'light',
            anchor: 1,
        });

        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ åŠ¨æ€å€’è®¡æ—¶è„šæœ¬ ğŸ‘‡ğŸ‘‡ğŸ‘‡
        const timerSpan = document.getElementById('countdown-timer');
        if (timerSpan) {
            const deadline = new Date(timerSpan.dataset.deadline).getTime();

            function updateTimer() {
                const now = new Date().getTime();
                const distance = deadline - now;

                if (distance < 0) {
                    timerSpan.innerHTML = "ğŸ›‘ å·²æˆªæ­¢";
                    timerSpan.className = "text-secondary fw-bold";
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                timerSpan.innerHTML = `${days}å¤© ${hours}æ—¶ ${minutes}åˆ† ${seconds}ç§’`;
            }

            setInterval(updateTimer, 1000);
            updateTimer(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        }
    });
</script>
{% endblock %}