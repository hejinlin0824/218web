{% extends 'base.html' %}

{% block title %}æ‹¼å†™ç»ƒä¹  - {{ level }}{% endblock %}

{# éšè—ä¾§è¾¹æ ï¼Œå…¨å±æ²‰æµ¸ä½“éªŒ #}
{% block sidebar %}{% endblock %}

{% block content_container %}
<div class="col-12">
    <div class="container py-5" style="max-width: 800px;">
        
        <div class="d-flex justify-content-between align-items-center mb-5">
            <a href="{% url 'vocabulary:index' %}" class="btn btn-light rounded-circle shadow-sm" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;">
                <i class="bi bi-x-lg"></i>
            </a>
            <div class="flex-grow-1 mx-4">
                <div class="progress" style="height: 10px; border-radius: 5px;">
                    <div class="progress-bar bg-success" id="progressBar" style="width: 0%"></div>
                </div>
            </div>
            <div class="fw-bold text-muted"><span id="currentIdx">0</span> / <span id="totalCount">0</span></div>
        </div>

        <div class="text-center" id="gameArea">
            
            <div class="mb-5 animate__animated animate__fadeIn">
                <h3 class="fw-bold text-dark mb-2" id="wordMeaning">åŠ è½½ä¸­...</h3>
                <div class="text-muted fs-5 font-monospace" id="wordPhonetic"></div>
            </div>

            <div id="inputContainer" class="d-flex justify-content-center gap-2 mb-5 flex-wrap">
                </div>

            <div id="feedbackMsg" class="h5 fw-bold text-success" style="min-height: 30px;"></div>

            <audio id="wordAudio"></audio>

        </div>

        <div id="resultArea" class="text-center d-none">
            <div class="display-1 mb-3">ğŸ‰</div>
            <h2 class="fw-bold mb-3">ç»ƒä¹ å®Œæˆï¼</h2>
            <p class="lead text-muted mb-4">æœ¬æ¬¡å…±ç»ƒä¹ äº† <span id="resultCount">0</span> ä¸ªå•è¯</p>
            <div class="d-flex justify-content-center gap-3">
                <a href="{% url 'vocabulary:index' %}" class="btn btn-outline-secondary rounded-pill px-4">è¿”å›å¤§å…</a>
                <button onclick="location.reload()" class="btn btn-primary rounded-pill px-4 fw-bold">å†æ¥ä¸€ç»„</button>
            </div>
        </div>

    </div>
</div>

<style>
    /* === æ‹¼å†™æ ¼å­çš„æ ·å¼ === */
    .char-input {
        width: 50px;
        height: 60px;
        font-size: 2rem;
        text-align: center;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        background-color: #fff;
        font-weight: bold;
        text-transform: uppercase;
        transition: all 0.2s;
        caret-color: transparent; /* éšè—å…‰æ ‡ï¼Œæ¨¡æ‹Ÿæ¸¸æˆæ„Ÿ */
    }
    
    /* é€‰ä¸­çŠ¶æ€ */
    .char-input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.1);
        outline: none;
        transform: translateY(-2px);
    }
    
    /* æ­£ç¡®æ ·å¼ (ç»¿è‰²) */
    .char-input.correct {
        background-color: #d1e7dd;
        border-color: #198754;
        color: #0f5132;
    }
    
    /* é”™è¯¯æ ·å¼ (çº¢è‰² + æŠ–åŠ¨åŠ¨ç”») */
    .char-input.wrong {
        border-color: #dc3545;
        color: #dc3545;
        background-color: #f8d7da;
        animation: shake 0.4s;
    }
    
    /* é”™è¯¯æŠ–åŠ¨åŠ¨ç”»å…³é”®å¸§ */
    @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        50% { transform: translateX(5px); }
        75% { transform: translateX(-5px); }
        100% { transform: translateX(0); }
    }
    
    /* æ‰‹æœºç«¯é€‚é…ï¼šæ ¼å­å˜å°ä¸€ç‚¹ */
    @media (max-width: 576px) {
        .char-input {
            width: 36px;
            height: 48px;
            font-size: 1.5rem;
            border-radius: 8px;
        }
    }
</style>

<script>
    // 1. åˆå§‹åŒ–é…ç½®
    const LEVEL = "{{ level }}";
    // è°ƒç”¨æˆ‘ä»¬åœ¨åç«¯å†™å¥½çš„ API
    const API_URL = `{% url 'vocabulary:api_get_words' %}?level=${LEVEL}&count=10`; 
    
    let wordsQueue = [];       // å­˜æ”¾å–å›æ¥çš„å•è¯åˆ—è¡¨
    let currentWordObj = null; // å½“å‰æ­£åœ¨èƒŒçš„å•è¯å¯¹è±¡
    let currentIndex = 0;      // å½“å‰ç¬¬å‡ ä¸ª
    let isProcessing = false;  // é˜²æ­¢è¿å‡»å†²çª

    // é¡µé¢åŠ è½½å®Œæˆåï¼Œå¯åŠ¨æ¸¸æˆ
    document.addEventListener('DOMContentLoaded', initGame);

    // 2. åˆå§‹åŒ–æ¸¸æˆï¼šå»åç«¯æ‹¿æ•°æ®
    async function initGame() {
        try {
            const res = await fetch(API_URL);
            const json = await res.json();
            
            if (json.status === 'ok') {
                wordsQueue = json.data;
                document.getElementById('totalCount').innerText = wordsQueue.length;
                
                if (wordsQueue.length === 0) {
                    alert("è¯åº“é‡Œå¥½åƒæ²¡æœ‰è¿™ä¸ªç­‰çº§çš„å•è¯ï¼Ÿè¯·å…ˆå¯¼å…¥æ•°æ®ã€‚");
                    return;
                }
                
                // å¼€å§‹ç¬¬ä¸€ä¸ªè¯
                loadNextWord();
            } else {
                alert("åŠ è½½å•è¯å¤±è´¥ï¼š" + json.msg);
            }
        } catch (e) {
            console.error(e);
            alert("ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨");
        }
    }

    // 3. åŠ è½½ä¸‹ä¸€ä¸ªå•è¯ (æ ¸å¿ƒé€»è¾‘)
    function loadNextWord() {
        // å¦‚æœèƒŒå®Œäº†ï¼Œæ˜¾ç¤ºç»“ç®—é¡µ
        if (currentIndex >= wordsQueue.length) {
            showResult();
            return;
        }

        // è·å–å½“å‰å•è¯æ•°æ®
        currentWordObj = wordsQueue[currentIndex];
        const word = currentWordObj.word.toLowerCase(); // ç›®æ ‡å•è¯ (å°å†™)
        
        // æ›´æ–°ç•Œé¢æ˜¾ç¤º (è¿›åº¦ã€é‡Šä¹‰ã€éŸ³æ ‡)
        document.getElementById('currentIdx').innerText = currentIndex + 1;
        document.getElementById('progressBar').style.width = ((currentIndex) / wordsQueue.length * 100) + '%';
        document.getElementById('wordMeaning').innerText = currentWordObj.meaning;
        document.getElementById('wordPhonetic').innerText = currentWordObj.phonetic || "";
        document.getElementById('feedbackMsg').innerText = "";

        // åŠ¨æ€ç”Ÿæˆè¾“å…¥æ¡†ï¼šå•è¯æœ‰å‡ ä¸ªå­—æ¯ï¼Œå°±ç”Ÿå‡ ä¸ªæ¡†
        const container = document.getElementById('inputContainer');
        container.innerHTML = ''; // æ¸…ç©ºä¸Šä¸€é¢˜
        
        for (let i = 0; i < word.length; i++) {
            // è·³è¿‡ç©ºæ ¼æˆ–ç‰¹æ®Šç¬¦å· (å¦‚æœå•è¯é‡Œæœ‰ç©ºæ ¼ï¼Œæ¯”å¦‚ 'hang out')
            if (word[i] === ' ' || word[i] === '-') {
                const span = document.createElement('span');
                span.innerText = word[i];
                span.className = "fs-2 align-self-center";
                container.appendChild(span);
                continue;
            }

            const input = document.createElement('input');
            input.type = "text";
            input.maxLength = 1; // åªèƒ½è¾“1ä¸ªå­—
            input.className = "char-input";
            input.dataset.index = i; // è®°å½•å®ƒæ˜¯ç¬¬å‡ ä¸ªå­—æ¯
            input.dataset.char = word[i]; // è®°å½•æ­£ç¡®ç­”æ¡ˆæ˜¯ä»€ä¹ˆ
            
            // ç»‘å®šäº‹ä»¶ï¼šè¾“å…¥ç›‘å¬ã€åˆ é™¤ç›‘å¬ã€ç‚¹å‡»èšç„¦
            input.addEventListener('input', handleInput);
            input.addEventListener('keydown', handleKeyDown);
            input.addEventListener('click', () => focusFirstEmpty()); // å¼ºåˆ¶ä»å·¦å¾€å³è¾“

            container.appendChild(input);
        }

        // è‡ªåŠ¨èšç„¦ç¬¬ä¸€ä¸ªæ ¼å­
        setTimeout(() => focusFirstEmpty(), 100);
    }

    // 4. å¤„ç†è¾“å…¥äº‹ä»¶
    function handleInput(e) {
        const input = e.target;
        const val = input.value.toLowerCase();
        const correctChar = input.dataset.char.toLowerCase();

        if (!val) return; // å¦‚æœè¢«åˆ ç©ºäº†ï¼Œä¸ç®¡

        // æ ¸å¿ƒåˆ¤æ–­ï¼šè¾“å¯¹äº†å—ï¼Ÿ
        if (val === correctChar) {
            // âœ… å¯¹äº†ï¼šå˜ç»¿
            input.classList.add('correct');
            input.classList.remove('wrong');
            input.disabled = true; // é”å®šä¸è®©æ”¹äº†
            
            // æ£€æŸ¥æ˜¯ä¸æ˜¯æ‹¼å®Œäº†
            if (checkAllComplete()) {
                handleWordComplete();
            } else {
                // è¿˜æ²¡å®Œï¼Œèšç„¦ä¸‹ä¸€ä¸ªç©ºæ ¼å­
                focusFirstEmpty();
            }
        } else {
            // âŒ é”™äº†ï¼šå˜çº¢ + æŠ–åŠ¨
            input.value = ''; // æ¸…ç©ºé”™è¯¯è¾“å…¥
            input.classList.add('wrong');
            
            // 0.5ç§’åç§»é™¤çº¢è‰²æ ·å¼ï¼Œæ–¹ä¾¿é‡è¾“
            setTimeout(() => input.classList.remove('wrong'), 500);
        }
    }

    // 5. å¤„ç†é”®ç›˜åŠŸèƒ½é”® (æ¯”å¦‚é€€æ ¼)
    function handleKeyDown(e) {
        // å¦‚æœæŒ‰äº† Backspace ä¸”å½“å‰æ¡†æ˜¯ç©ºçš„ï¼Œè·³å›ä¸Šä¸€ä¸ªæ ¼å­
        if (e.key === 'Backspace' && e.target.value === '') {
            const inputs = Array.from(document.querySelectorAll('.char-input'));
            const currIdx = inputs.indexOf(e.target);
            if (currIdx > 0) {
                // æ‰¾åˆ°ä¸Šä¸€ä¸ªæ²¡è¢«é”å®š(disabled)çš„æ ¼å­
                // å…¶å®é€»è¾‘ä¸Šåªæœ‰å‰ä¸€ä¸ªå¯èƒ½æ²¡é”ï¼Œæˆ–è€…å·²ç»é”äº†ã€‚
                // ç®€å•çš„é€»è¾‘æ˜¯ï¼šè¿™é‡Œæˆ‘ä»¬è®¾å®šè¾“å¯¹äº†å°±é”æ­»ï¼Œæ‰€ä»¥ä¸èƒ½é€€æ ¼ä¿®æ”¹å·²æ­£ç¡®çš„ã€‚
                // æ‰€ä»¥å®é™…ä¸Š Backspace åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ç”¨å¤„ä¸å¤§ï¼Œé™¤éæ²¡è¾“å¯¹ã€‚
            }
        }
    }

    // 6. è¾…åŠ©ï¼šèšç„¦ç¬¬ä¸€ä¸ªæ²¡å¡«çš„æ ¼å­
    function focusFirstEmpty() {
        const inputs = document.querySelectorAll('.char-input');
        for (let input of inputs) {
            if (!input.disabled && !input.value) {
                input.focus();
                return;
            }
        }
    }

    // 7. è¾…åŠ©ï¼šæ£€æŸ¥æ˜¯å¦å…¨éƒ¨æ‹¼å†™å®Œæˆ
    function checkAllComplete() {
        const inputs = document.querySelectorAll('.char-input');
        // åªè¦æœ‰ä¸€ä¸ªæ²¡è¢«ç¦ç”¨(è¯´æ˜è¿˜æ²¡è¾“å¯¹é”å®š)ï¼Œå°±æ˜¯æ²¡å®Œæˆ
        for (let input of inputs) {
            if (!input.disabled) return false;
        }
        return true;
    }

    // 8. å•è¯å®Œæˆåçš„é€»è¾‘
    function handleWordComplete() {
        if (isProcessing) return;
        isProcessing = true;

        // æ’­æ”¾å‘éŸ³
        const audio = document.getElementById('wordAudio');
        audio.src = currentWordObj.audio_url;
        audio.play().catch(e => console.log("æµè§ˆå™¨é™åˆ¶äº†è‡ªåŠ¨æ’­æ”¾", e));

        document.getElementById('feedbackMsg').innerText = "âœ… Excellent! æ‹¼å†™æ­£ç¡®";
        
        // è¿›åº¦æ¡æ›´æ–°
        document.getElementById('progressBar').style.width = ((currentIndex + 1) / wordsQueue.length * 100) + '%';

        // å»¶è¿Ÿ 1.2 ç§’è¿›å…¥ä¸‹ä¸€ä¸ªè¯
        setTimeout(() => {
            currentIndex++;
            isProcessing = false;
            loadNextWord();
        }, 1200);
    }

    // 9. æ˜¾ç¤ºç»“ç®—é¡µ
    function showResult() {
        document.getElementById('gameArea').classList.add('d-none');
        document.getElementById('resultArea').classList.remove('d-none');
        document.getElementById('resultCount').innerText = wordsQueue.length;
    }
</script>
{% endblock %}