{% extends 'base.html' %}
{% load static %}

{% block title %}æ‹¼å†™æŒ‘æˆ˜{% endblock %}
{# éšè—ä¾§è¾¹æ ï¼Œå…¨å±æ²‰æµ¸ #}
{% block sidebar %}{% endblock %}

{% block content_container %}
<div class="col-12 p-0">
    <div class="practice-container">
        
        <div class="top-bar">
            <a href="javascript:history.back()" class="close-btn" title="é€€å‡º"><i class="bi bi-x-lg"></i></a>
            <div class="progress-track">
                <div class="progress-fill" id="progressBar" style="width: 0%">
                    <div class="progress-glow"></div>
                </div>
            </div>
            <div class="progress-text">
                <span id="currentIdx">1</span> / <span id="totalCount">-</span>
            </div>
        </div>

        <div class="game-stage">
            
            <div class="word-display animate__animated animate__fadeIn">
                <div id="posContainer" class="mb-2" style="min-height: 28px;"></div>
                
                <div class="meaning-text" id="wordMeaning">Loading...</div>
                
                <div class="phonetic-pill" onclick="playAudio()">
                    <i class="bi bi-volume-up-fill"></i>
                    <span id="wordPhonetic"></span>
                </div>
            </div>

            <div id="inputContainer" class="input-grid"></div>

            <div class="feedback-area">
                <div id="hintCard" class="hint-card d-none animate__animated animate__headShake">
                    <div class="hint-header">
                        <div class="hint-icon-box"><i class="bi bi-lightbulb-fill"></i></div>
                        <span class="hint-title">æç¤º / ä¾‹å¥</span>
                    </div>
                    <div class="hint-body" id="hintBody"></div>
                </div>
                
                <div id="statusText" class="status-text"></div>
            </div>

            <div class="bottom-actions">
                <button class="btn-action btn-skip" id="skipBtn" onclick="showAnswer()">
                    ğŸ™ˆ ä¸çŸ¥é“ / æç¤º
                </button>
                <button class="btn-action btn-submit" id="submitBtn" onclick="checkAnswer()" disabled>
                    ç¡®è®¤æäº¤
                </button>
            </div>

        </div>

        <div id="resultOverlay" class="result-overlay d-none animate__animated animate__fadeIn">
            <div class="result-box animate__animated animate__bounceIn">
                <div class="result-icon">ğŸ†</div>
                <h2>æœ¬æ¬¡æŒ‘æˆ˜å®Œæˆ!</h2>
                <p>ç§¯è·¬æ­¥ï¼Œè‡³åƒé‡Œã€‚ç»§ç»­ä¿æŒï¼</p>
                
                <div class="result-stats">
                    <div class="stat-item">
                        <div class="stat-num text-success" id="resultCorrect">10</div>
                        <div class="stat-label">æ­£ç¡®</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-num text-warning">Done</div>
                        <div class="stat-label">çŠ¶æ€</div>
                    </div>
                </div>

                <div class="result-btns">
                    <button onclick="location.reload()" class="btn-primary-action w-100">å†æ¥ä¸€ç»„</button>
                    <a href="{% url 'vocabulary:index' %}" class="btn-secondary-action w-100 mt-2">è¿”å›å¤§å…</a>
                </div>
            </div>
        </div>

    </div>
</div>

<audio id="wordAudio"></audio>

<style>
    /* === è§†è§‰é£æ ¼å®šä¹‰ === */
    :root {
        --bg-color: #ffffff;
        --primary-color: #58cc02; /* ç»å…¸å¤šé‚»å›½ç»¿ */
        --primary-shadow: #58a700;
        --error-color: #ff4b4b;
        --error-bg: #fff2f2;
        --error-shadow: #d42c2c;
        --secondary-color: #e5e5e5;
        --text-color: #4b4b4b;
        --input-border: #e5e5e5;
        --focus-border: #1cb0f6; /* èšç„¦è“ */
        --focus-shadow: #1899d6;
        
        /* æç¤ºå¡ç‰‡æš–è‰²è°ƒ */
        --hint-bg-start: #fff9e6;
        --hint-bg-end: #ffffff;
        --hint-border: #ffeeba;
        --hint-icon-color: #f59f00;
    }

    /* å¸ƒå±€ */
    .practice-container {
        max-width: 800px; margin: 0 auto; min-height: 85vh;
        display: flex; flex-direction: column; padding: 20px;
        font-family: 'Nunito', -apple-system, sans-serif;
    }

    /* é¡¶éƒ¨è¿›åº¦æ¡ */
    .top-bar { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
    .close-btn { font-size: 1.5rem; color: #e5e5e5; transition: color 0.2s; }
    .close-btn:hover { color: #afafaf; }
    
    .progress-track {
        flex-grow: 1; height: 16px; background-color: #e5e5e5; border-radius: 10px;
        overflow: hidden; position: relative;
    }
    .progress-fill {
        height: 100%; background-color: var(--primary-color); width: 0%;
        border-radius: 10px; transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
    }
    .progress-glow {
        position: absolute; top: 3px; left: 5px; right: 5px; height: 4px;
        background-color: rgba(255,255,255,0.3); border-radius: 4px;
    }
    .progress-text { font-weight: 800; color: var(--primary-color); }

    /* å•è¯å±•ç¤ºåŒº */
    .word-display { text-align: center; margin-bottom: 30px; }
    
    /* è¯æ€§èƒ¶å›Š */
    .pos-badge {
        display: inline-block; background-color: #e0f2fe; color: #0284c7;
        font-weight: 800; font-size: 0.9rem; padding: 4px 10px;
        border-radius: 8px; margin-bottom: 4px; text-transform: lowercase;
        border: 1px solid #bae6fd;
    }

    .meaning-text {
        font-size: 1.8rem; font-weight: 800; color: var(--text-color); margin-bottom: 15px; line-height: 1.3;
    }

    .phonetic-pill {
        display: inline-flex; align-items: center; gap: 8px; padding: 6px 14px;
        border: 2px solid #e5e5e5; border-radius: 12px; color: #1cb0f6;
        font-weight: 700; cursor: pointer; background: white;
        box-shadow: 0 4px 0 #e5e5e5; transition: 0.1s;
    }
    .phonetic-pill:active { transform: translateY(4px); box-shadow: none; }

    /* === è¾“å…¥æ ¼å­ === */
    .input-grid {
        display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 20px;
    }
    .char-input {
        width: 50px; height: 60px; font-size: 2rem; font-weight: 700; text-align: center;
        color: var(--text-color); background: white;
        border: 2px solid var(--input-border); border-radius: 12px;
        box-shadow: 0 4px 0 var(--input-border);
        transition: all 0.1s; text-transform: uppercase;
        caret-color: var(--focus-border);
    }
    .char-input:focus {
        outline: none; border-color: var(--focus-border); background-color: #f0faff;
        box-shadow: 0 4px 0 var(--focus-shadow); transform: translateY(-2px); z-index: 10;
    }
    .char-input.wrong {
        border-color: var(--error-color) !important; background-color: var(--error-bg) !important;
        color: var(--error-color) !important; box-shadow: 0 4px 0 var(--error-shadow) !important;
        animation: shake 0.4s;
    }
    .char-input.correct {
        border-color: var(--primary-color) !important; background-color: #dfffc8 !important;
        color: var(--primary-color) !important; box-shadow: none !important;
        transform: translateY(4px);
    }

    /* === æç¤ºåŒº === */
    .feedback-area {
        width: 100%; margin-bottom: 20px; min-height: 100px;
        display: flex; justify-content: center; align-items: center; flex-direction: column;
    }
    .hint-card {
        background: linear-gradient(145deg, var(--hint-bg-start) 0%, var(--hint-bg-end) 100%);
        border: 1px solid var(--hint-border);
        border-radius: 20px; padding: 16px 20px;
        width: 100%; max-width: 600px;
        box-shadow: 0 10px 30px -10px rgba(245, 159, 0, 0.15);
        display: flex; flex-direction: column;
    }
    .hint-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .hint-icon-box {
        width: 28px; height: 28px; border-radius: 50%; background: rgba(245, 159, 0, 0.15);
        color: var(--hint-icon-color); display: flex; align-items: center; justify-content: center; font-size: 1rem;
    }
    .hint-title { font-weight: 800; font-size: 0.85rem; color: var(--hint-icon-color); text-transform: uppercase; }
    .hint-body { text-align: left; }
    
    .hint-en { font-size: 1.1rem; font-weight: 700; color: #2c2c2c; margin-bottom: 4px; line-height: 1.4; }
    .highlight-word { color: #d63031; background-color: rgba(255, 75, 75, 0.1); padding: 0 4px; border-radius: 4px; }
    .hint-cn { color: #888; font-size: 0.9rem; }
    .hint-answer-box { font-size: 1.4rem; font-weight: 900; color: var(--error-color); letter-spacing: 2px; margin-top: 5px; }

    /* çŠ¶æ€æ–‡å­— (Excellent) */
    .status-text {
        font-size: 1.8rem; font-weight: 800; color: var(--primary-color);
        height: 40px; display: flex; align-items: center; text-shadow: 0 2px 0 #dfffc8;
        transform: scale(0); transition: transform 0.3s;
    }
    .status-text.show { transform: scale(1); }

    /* åº•éƒ¨æŒ‰é’® */
    .bottom-actions { margin-top: auto; display: flex; gap: 15px; width: 100%; padding-top: 20px; border-top: 2px solid #f0f0f0; }
    .btn-action {
        flex: 1; padding: 14px; border-radius: 16px; font-size: 1rem; font-weight: 800;
        text-transform: uppercase; border: none; cursor: pointer; transition: all 0.1s;
    }
    .btn-skip { background: white; border: 2px solid #e5e5e5; color: #afafaf; box-shadow: 0 4px 0 #e5e5e5; }
    .btn-skip:active { transform: translateY(4px); box-shadow: none; }
    .btn-submit { background: var(--primary-color); color: white; box-shadow: 0 4px 0 var(--primary-shadow); }
    .btn-submit:active { transform: translateY(4px); box-shadow: none; }
    .btn-submit:disabled { background: #e5e5e5; color: #afafaf; box-shadow: none; transform: translateY(0); cursor: not-allowed; }
    .btn-retry { background-color: var(--error-color) !important; box-shadow: 0 4px 0 var(--error-shadow) !important; }

    /* ç»“ç®—å¼¹çª— */
    .result-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95);
        z-index: 2000; display: flex; justify-content: center; align-items: center;
    }
    .result-box {
        background: white; border: 2px solid #e5e5e5; border-radius: 30px; padding: 40px; text-align: center;
        width: 90%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    }
    .result-icon { font-size: 5rem; margin-bottom: 10px; }
    .result-stats { display: flex; justify-content: space-around; margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 16px; }
    .stat-num { font-size: 1.5rem; font-weight: 800; }
    .stat-label { font-size: 0.8rem; color: #999; text-transform: uppercase; font-weight: bold; }
    .btn-primary-action {
        background: var(--primary-color); color: white; border: none; padding: 15px; width: 100%;
        border-radius: 16px; font-weight: 800; text-transform: uppercase;
        box-shadow: 0 4px 0 var(--primary-shadow); cursor: pointer; transition: 0.1s;
    }
    .btn-primary-action:active { transform: translateY(4px); box-shadow: none; }
    .btn-secondary-action {
        display: block; text-align: center; color: var(--text-color); padding: 15px;
        width: 100%; border-radius: 16px; font-weight: 800; text-decoration: none;
    }

    @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
    @media (max-width: 500px) {
        .char-input { width: 42px; height: 55px; font-size: 1.6rem; }
        .practice-container { padding: 10px; }
    }
</style>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const LEVEL = urlParams.get('level') || 'CET4';
    const COUNT = urlParams.get('count') || 10;
    const MODE = urlParams.get('mode') || 'learn';
    const API_URL = `{% url 'vocabulary:api_get_words' %}?level=${LEVEL}&count=${COUNT}&mode=${MODE}`;
    
    let wordsQueue = [], currentWordObj = null, currentIndex = 0;
    let isErrorState = false; 

    document.addEventListener('DOMContentLoaded', initGame);

    async function initGame() {
        try {
            const res = await fetch(API_URL);
            const json = await res.json();
            if (json.status === 'ok') {
                wordsQueue = json.data;
                if (wordsQueue.length === 0) {
                    alert("æš‚æ— å•è¯å¯ä¾›ç»ƒä¹ ï¼");
                    window.location.href = "{% url 'vocabulary:index' %}";
                    return;
                }
                document.getElementById('totalCount').innerText = wordsQueue.length;
                loadNextWord();
            }
        } catch (e) { console.error(e); alert("ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥"); }
    }

    function loadNextWord() {
        if (currentIndex >= wordsQueue.length) {
            showResult();
            return;
        }

        currentWordObj = wordsQueue[currentIndex];
        isErrorState = false;
        
        // 1. è¿›åº¦æ¡æ›´æ–°
        document.getElementById('currentIdx').innerText = currentIndex + 1;
        document.getElementById('progressBar').style.width = `${(currentIndex / wordsQueue.length) * 100}%`;

        // 2. å†…å®¹æ›´æ–°
        renderMeaning(currentWordObj.meaning);
        document.getElementById('wordPhonetic').innerText = currentWordObj.phonetic || "";
        
        // 3. ğŸ”¥ğŸ”¥ğŸ”¥ å¼ºåˆ¶æ¸…ç©ºçŠ¶æ€ï¼Œä¿®å¤æ®‹ç•™ Bug ğŸ”¥ğŸ”¥ğŸ”¥
        const statusText = document.getElementById('statusText');
        statusText.innerText = "";  
        statusText.className = "status-text"; // ç§»é™¤æ‰€æœ‰åŠ¨ç”»ç±»ï¼Œåªä¿ç•™åŸºç¡€ç±»
        
        // 4. éšè—æç¤ºå¡ç‰‡
        const hintCard = document.getElementById('hintCard');
        hintCard.classList.add('d-none');
        hintCard.classList.remove('animate__headShake');

        // 5. é‡ç½®æŒ‰é’®
        const btn = document.getElementById('submitBtn');
        btn.innerText = "ç¡®è®¤æäº¤";
        btn.disabled = true;
        btn.classList.remove('btn-retry');
        
        playAudio();
        createInputs(currentWordObj.word);
    }

    function renderMeaning(rawMeaning) {
        const posContainer = document.getElementById('posContainer');
        const meaningEl = document.getElementById('wordMeaning');
        posContainer.innerHTML = '';
        
        const match = rawMeaning.match(/^([a-zA-Z.&]+)\s*(.*)/);
        if (match && match.length >= 3) {
            const badge = document.createElement('span');
            badge.className = 'pos-badge';
            badge.innerText = match[1];
            posContainer.appendChild(badge);
            meaningEl.innerText = match[2];
        } else {
            meaningEl.innerText = rawMeaning;
        }
    }

    function createInputs(word) {
        const container = document.getElementById('inputContainer');
        container.innerHTML = '';
        
        for (let i = 0; i < word.length; i++) {
            if ([' ', '-'].includes(word[i])) {
                const span = document.createElement('span');
                span.innerText = word[i];
                span.className = "fs-2 fw-bold align-self-center mx-1 text-muted";
                container.appendChild(span);
                continue;
            }

            const input = document.createElement('input');
            input.type = "text"; input.maxLength = 1; input.className = "char-input"; 
            input.dataset.index = i;
            
            input.value = ""; 
            input.name = "char_" + currentIndex + "_" + i + "_" + Math.random().toString(36).substr(2, 5);
            input.autocomplete = "off"; 
            input.setAttribute("data-lpignore", "true"); 
            input.inputMode = "text"; input.autocorrect = "off"; input.autocapitalize = "off"; input.spellcheck = false;

            input.addEventListener('input', (e) => handleInput(e, i));
            input.addEventListener('keydown', (e) => handleKeyDown(e, i));
            input.addEventListener('focus', (e) => handleFocus(e));
            
            container.appendChild(input);
        }
        setTimeout(() => {
            const first = container.querySelector('input');
            if(first) first.focus();
        }, 100);
    }

    function handleInput(e, idx) {
        const val = e.target.value;
        const inputs = document.querySelectorAll('.char-input');
        if (isErrorState) clearErrorStyles();
        if (val) {
            let nextInput = null;
            for (let j = idx + 1; j < inputs.length; j++) {
                if (!inputs[j].disabled) { nextInput = inputs[j]; break; }
            }
            if (nextInput) nextInput.focus();
        }
        updateSubmitButton();
    }

    function handleKeyDown(e, idx) {
        const inputs = document.querySelectorAll('.char-input');
        const input = inputs[idx];

        if (/^[a-zA-Z]$/.test(e.key) && !e.ctrlKey && !e.altKey && !e.metaKey) {
            e.preventDefault(); 
            input.value = e.key; 
            if (isErrorState) clearErrorStyles(); 
            
            let nextInput = null;
            for (let j = idx + 1; j < inputs.length; j++) {
                if (!inputs[j].disabled) { nextInput = inputs[j]; break; }
            }
            if (nextInput) nextInput.focus();
            updateSubmitButton();
            return;
        }
        
        if (e.key === 'Backspace') {
            if (!input.value && idx > 0) {
                let prevInput = null;
                for (let j = idx - 1; j >= 0; j--) {
                    if (!inputs[j].disabled) { prevInput = inputs[j]; break; }
                }
                if (prevInput) prevInput.focus();
            } else {
                input.value = ''; 
            }
            if (isErrorState) clearErrorStyles();
            updateSubmitButton();
        }
        if (e.key === 'Enter') checkAnswer();
    }

    function handleFocus(e) {
        if (isErrorState) clearErrorStyles();
    }

    function updateSubmitButton() {
        const inputs = Array.from(document.querySelectorAll('.char-input'));
        const allFilled = inputs.every(input => input.value.trim() !== '');
        document.getElementById('submitBtn').disabled = !allFilled;
    }

    function clearErrorStyles() {
        isErrorState = false;
        document.querySelectorAll('.char-input').forEach(inp => inp.classList.remove('wrong'));
        const btn = document.getElementById('submitBtn');
        btn.classList.remove('btn-retry');
        btn.innerText = "ç¡®è®¤æäº¤";
        
        // ğŸ”¥ æ¸…é™¤çŠ¶æ€æ–‡å­—
        const statusText = document.getElementById('statusText');
        statusText.innerText = "";
        statusText.className = "status-text";
    }

    function checkAnswer() {
        const btn = document.getElementById('submitBtn');
        if (btn.disabled) return;

        const inputs = document.querySelectorAll('.char-input');
        let firstWrongIndex = -1;
        let isAllCorrect = true;

        inputs.forEach((input, index) => {
            const char = input.value.toLowerCase();
            const target = currentWordObj.word[parseInt(input.dataset.index)].toLowerCase();
            if (char !== target) {
                isAllCorrect = false;
                if (firstWrongIndex === -1) firstWrongIndex = index;
            }
        });

        if (isAllCorrect) {
            handleCorrect(inputs);
        } else {
            handleWrong(inputs, firstWrongIndex);
        }
    }

    function handleCorrect(inputs) {
        inputs.forEach(inp => {
            inp.classList.add('correct'); 
            inp.disabled = true; 
        });
        
        const statusText = document.getElementById('statusText');
        statusText.innerText = "Excellent!";
        // ğŸ”¥ å¼ºåˆ¶é‡ç»˜è§¦å‘åŠ¨ç”»
        statusText.className = "status-text";
        void statusText.offsetWidth; 
        statusText.className = "status-text show animate__animated animate__rubberBand";
        
        playAudio();
        submitResult(true);

        setTimeout(() => {
            currentIndex++;
            loadNextWord();
        }, 1200);
    }

    function handleWrong(inputs, firstWrongIndex) {
        isErrorState = true;
        
        inputs.forEach((inp, index) => {
            const char = inp.value.toLowerCase();
            const target = currentWordObj.word[parseInt(inp.dataset.index)].toLowerCase();
            if (char !== target) {
                inp.classList.add('wrong');
            }
        });
        
        // é”™è¯¯æ—¶ä¹Ÿè¦æ¸…ç©º Excellent
        const statusText = document.getElementById('statusText');
        statusText.innerText = "";
        statusText.className = "status-text";

        showHint();
        
        const hintCard = document.getElementById('hintCard');
        hintCard.classList.remove('animate__headShake');
        void hintCard.offsetWidth;
        hintCard.classList.add('animate__headShake');

        const btn = document.getElementById('submitBtn');
        btn.innerText = "å†è¯•ä¸€æ¬¡";
        btn.classList.add('btn-retry');

        if (inputs[firstWrongIndex]) {
            inputs[firstWrongIndex].focus();
        }
        submitResult(false);
    }

    function showHint() {
        const hintCard = document.getElementById('hintCard');
        const hintBody = document.getElementById('hintBody');
        
        hintCard.classList.remove('d-none');
        
        const safeWord = currentWordObj.word;
        const sentence = currentWordObj.example_en;

        if (!sentence) {
            hintBody.innerHTML = `
                <div class="text-muted small mb-1">æš‚æ— ä¾‹å¥ï¼Œæ­£ç¡®æ‹¼å†™ä¸ºï¼š</div>
                <div class="hint-answer-box">${safeWord}</div>
            `;
        } else {
            const regex = new RegExp(`(${safeWord})`, 'gi');
            const highlightedSentence = sentence.replace(regex, '<span class="highlight-word">$1</span>');
            const sentenceCn = currentWordObj.example_cn || "";
            
            hintBody.innerHTML = `
                <div class="hint-en">${highlightedSentence}</div>
                <div class="hint-cn">${sentenceCn}</div>
            `;
        }
    }

    window.showAnswer = function() {
        showHint();
        const inputs = document.querySelectorAll('.char-input');
        
        // æ¸…ç©º Excellent
        document.getElementById('statusText').innerText = "";
        document.getElementById('statusText').className = "status-text";

        inputs.forEach(inp => {
            const idx = parseInt(inp.dataset.index);
            inp.value = currentWordObj.word[idx]; 
            inp.classList.add('wrong'); 
        });
        isErrorState = true;
        document.getElementById('submitBtn').disabled = false;
        if(inputs.length > 0) inputs[0].focus();
    }

    function submitResult(isCorrect) {
        fetch("{% url 'vocabulary:api_submit_result' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ word_id: currentWordObj.id, is_correct: isCorrect })
        }).catch(err => console.log(err));
    }

    function playAudio() {
        const audio = document.getElementById('wordAudio');
        if(currentWordObj && currentWordObj.audio_url) {
            audio.src = currentWordObj.audio_url;
            audio.play().catch(e => {});
        }
    }
    
    function showResult() {
        document.getElementById('resultOverlay').classList.remove('d-none');
        document.getElementById('resultCorrect').innerText = wordsQueue.length;
        document.getElementById('progressBar').style.width = '100%';
    }
</script>
{% endblock %}