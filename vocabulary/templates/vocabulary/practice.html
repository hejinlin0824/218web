{% extends 'base.html' %}
{% block title %}æ‹¼å†™æŒ‘æˆ˜{% endblock %}
{% block sidebar %}{% endblock %}

{% block content_container %}
<div class="col-12">
    <div class="container py-5" style="max-width: 800px;">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <a href="javascript:history.back()" class="btn btn-light rounded-circle shadow-sm" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;"><i class="bi bi-x-lg"></i></a>
            <div class="flex-grow-1 mx-4">
                <div class="progress" style="height: 10px; border-radius: 5px;">
                    <div class="progress-bar bg-success transition-width" id="progressBar" style="width: 0%"></div>
                </div>
            </div>
            <div class="fw-bold text-muted"><span id="currentIdx">1</span> / <span id="totalCount">0</span></div>
        </div>

        <div class="text-center" id="gameArea">
            <div class="mb-5 animate__animated animate__fadeIn">
                <h3 class="fw-bold text-dark mb-2" id="wordMeaning">åŠ è½½ä¸­...</h3>
                <div class="d-flex justify-content-center align-items-center gap-2 cursor-pointer" onclick="playAudio()" title="ç‚¹å‡»é‡æ’­å‘éŸ³" style="cursor: pointer;">
                    <div class="text-muted fs-5 font-monospace" id="wordPhonetic"></div>
                    <i class="bi bi-volume-up-fill text-primary"></i>
                </div>
            </div>

            <div id="inputContainer" class="d-flex justify-content-center gap-2 mb-4 flex-wrap"></div>

            <div id="hintArea" class="d-none animate__animated animate__fadeInUp mb-4">
                <div class="alert alert-danger d-inline-block text-start shadow-sm" style="max-width: 90%; border-left: 5px solid #dc3545;">
                    <div class="d-flex align-items-center mb-2 text-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> 
                        <strong>æ‹¼å†™é”™è¯¯ï¼Œè¯·å‚è€ƒä¾‹å¥ä¿®æ­£ï¼š</strong>
                    </div>
                    <div class="bg-white p-3 rounded border">
                        <p class="mb-1 text-dark en-sentence fs-5" style="line-height: 1.6;"></p>
                        <p class="mb-0 text-muted small cn-sentence"></p>
                    </div>
                </div>
            </div>
            
            <div id="feedbackMsg" class="h4 fw-bold text-success mb-3" style="min-height: 30px;"></div>
        </div>

        <div id="resultArea" class="text-center d-none">
            <div class="display-1 mb-3">ğŸ‰</div>
            <h2 class="fw-bold mb-3">æœ¬æ¬¡ç»ƒä¹ å®Œæˆï¼</h2>
            <div class="d-flex justify-content-center gap-3 mt-4">
                <a href="{% url 'vocabulary:index' %}" class="btn btn-outline-secondary rounded-pill px-4">è¿”å›å¤§å…</a>
                <button onclick="location.reload()" class="btn btn-primary rounded-pill px-4">å†æ¥ä¸€ç»„</button>
            </div>
        </div>
    </div>
</div>
<audio id="wordAudio"></audio>

<style>
    .char-input { width: 50px; height: 60px; font-size: 2rem; text-align: center; border: 2px solid #e0e0e0; border-radius: 12px; background-color: #fff; font-weight: bold; text-transform: uppercase; color: #333; transition: all 0.2s; }
    .char-input:focus { border-color: #0d6efd; box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.1); outline: none; transform: translateY(-3px); }
    .char-input.wrong { border-color: #dc3545; background-color: #fff5f5; color: #dc3545; animation: shake 0.4s; }
    .char-input.correct { border-color: #198754; background-color: #d1e7dd; color: #0f5132; }
    .transition-width { transition: width 0.5s ease; }
    @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
</style>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const LEVEL = urlParams.get('level') || 'CET4';
    // ğŸ”¥ è·å–ç”¨æˆ·é€‰çš„æ•°é‡ï¼Œé»˜è®¤10
    const COUNT = urlParams.get('count') || 10;
    const MODE = urlParams.get('mode') || 'learn';
    
    const API_URL = `{% url 'vocabulary:api_get_words' %}?level=${LEVEL}&count=${COUNT}&mode=${MODE}`;
    
    let wordsQueue = [], currentWordObj = null, currentIndex = 0, isProcessing = false;

    document.addEventListener('DOMContentLoaded', initGame);

    async function initGame() {
        try {
            const res = await fetch(API_URL);
            const json = await res.json();
            if (json.status === 'ok') {
                wordsQueue = json.data;
                if (wordsQueue.length === 0) {
                    alert("æš‚æ— å•è¯å¯ä¾›ç»ƒä¹ ï¼");
                    window.location.href = "{% url 'vocabulary:index' %}";
                    return;
                }
                document.getElementById('totalCount').innerText = wordsQueue.length;
                loadNextWord();
            }
        } catch (e) { alert("ç½‘ç»œé”™è¯¯"); }
    }

    function loadNextWord() {
        if (currentIndex >= wordsQueue.length) {
            document.getElementById('gameArea').classList.add('d-none');
            document.getElementById('resultArea').classList.remove('d-none');
            // ğŸ”¥ ç»“æŸæ—¶è¿›åº¦æ¡æ‹‰æ»¡
            document.getElementById('progressBar').style.width = '100%';
            return;
        }

        currentWordObj = wordsQueue[currentIndex];
        document.getElementById('currentIdx').innerText = currentIndex + 1;
        
        // ğŸ”¥ ä¿®å¤ Bug2ï¼šè¿›åº¦æ¡é€»è¾‘
        // å¼€å§‹ç¬¬1ä¸ª(idx=0)ï¼Œè¿›åº¦0/10 = 0%
        // å®Œæˆç¬¬1ä¸ªï¼Œå‡†å¤‡åŠ è½½ç¬¬2ä¸ª(idx=1)ï¼Œè¿›åº¦ 1/10 = 10%
        // ...
        // å‡†å¤‡åŠ è½½ç¬¬10ä¸ª(idx=9)ï¼Œè¿›åº¦ 9/10 = 90%
        let progressPercent = (currentIndex / wordsQueue.length) * 100;
        document.getElementById('progressBar').style.width = progressPercent + '%';

        document.getElementById('wordMeaning').innerText = currentWordObj.meaning;
        document.getElementById('wordPhonetic').innerText = currentWordObj.phonetic || "";
        document.getElementById('hintArea').classList.add('d-none');
        document.getElementById('feedbackMsg').innerText = "";
        
        playAudio();
        createInputs(currentWordObj.word);
    }

    function playAudio() {
        if (!currentWordObj) return;
        const audio = document.getElementById('wordAudio');
        audio.src = currentWordObj.audio_url;
        audio.play().catch((e) => console.log("Auto-play blocked:", e));
    }

    function createInputs(word) {
        const container = document.getElementById('inputContainer');
        container.innerHTML = '';
        for (let i = 0; i < word.length; i++) {
            if ([' ', '-'].includes(word[i])) {
                const span = document.createElement('span');
                span.innerText = word[i];
                span.className = "fs-2 align-self-center";
                container.appendChild(span);
                continue;
            }
            const input = document.createElement('input');
            input.type = "text"; input.maxLength = 1; input.className = "char-input"; input.dataset.index = i;
            input.addEventListener('input', (e) => handleInput(e, i));
            input.addEventListener('keydown', (e) => handleKeyDown(e, i));
            container.appendChild(input);
        }
        setTimeout(() => container.querySelector('input').focus(), 100);
    }

    function handleInput(e, idx) {
        const val = e.target.value;
        const inputs = document.querySelectorAll('.char-input');
        if (val && idx < inputs.length - 1) inputs[idx + 1].focus();
        const allFilled = Array.from(inputs).every(input => input.value.trim() !== '');
        if (allFilled) checkAnswer(); 
    }

    function handleKeyDown(e, idx) {
        if (e.key === 'Backspace' && !e.target.value && idx > 0) {
            document.querySelectorAll('.char-input')[idx - 1].focus();
        }
    }

    function checkAnswer() {
        if (isProcessing) return;
        const inputs = document.querySelectorAll('.char-input');
        let isCorrect = true;

        inputs.forEach(input => {
            const char = input.value.toLowerCase();
            const target = currentWordObj.word[parseInt(input.dataset.index)].toLowerCase();
            if (char !== target) {
                isCorrect = false;
                input.classList.add('wrong');
                input.value = ''; 
            } else {
                input.classList.remove('wrong');
            }
        });

        if (isCorrect) {
            isProcessing = true;
            inputs.forEach(inp => { inp.classList.add('correct'); inp.disabled = true; });
            document.getElementById('feedbackMsg').innerText = "âœ… æ­£ç¡®";
            
            submitResult(true);

            setTimeout(() => {
                currentIndex++;
                isProcessing = false;
                loadNextWord();
            }, 800);
        } else {
            const hintArea = document.getElementById('hintArea');
            hintArea.classList.remove('d-none');
            const safeWord = currentWordObj.word;
            const sentence = currentWordObj.example_en || "æš‚æ— ä¾‹å¥";
            const regex = new RegExp(`(${safeWord})`, 'gi');
            hintArea.querySelector('.en-sentence').innerHTML = sentence.replace(regex, '<span class="text-danger fw-bold text-decoration-underline">$1</span>');
            hintArea.querySelector('.cn-sentence').innerText = currentWordObj.example_cn || "";
            
            submitResult(false);
            document.querySelector('.char-input:not(.correct)').focus(); 
        }
    }

    function submitResult(isCorrect) {
        fetch("{% url 'vocabulary:api_submit_result' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ word_id: currentWordObj.id, is_correct: isCorrect })
        });
    }
</script>
{% endblock %}